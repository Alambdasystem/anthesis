<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadet Dashboard</title>
  <link href="https://fonts.googleapis.com/css?family=Quicksand:300,400,500,700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-main: #f7fafc;
      --bg-panel: #fff;
      --bg-sidebar: #e3f2fd;
      --accent: #0a84ff;
      --accent2: #ff4d4d;
      --radius: 12px;
      --text-main: #222;
      --text-accent: #0a84ff;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0; display: flex; height: 100vh;
      font-family: 'Quicksand', sans-serif;
      background: var(--bg-main); color: var(--text-main);
    }
    /* Sidebar */
    .sidebar {
      width: 220px; background: var(--bg-sidebar);
      display: flex; flex-direction: column;
      border-right: 1.5px solid #b3d8ff;
      box-shadow: 2px 0 8px #e3f2fd;
      padding-top: 1.5rem;
    }
    .sidebar .nav-item {
      padding: 1rem 1.5rem; cursor: pointer;
      border: none;
      background: none;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.1rem;
      border-radius: var(--radius) 0 0 var(--radius);
      margin-bottom: 0.5rem;
      transition: background 0.2s, color 0.2s;
    }
    .sidebar .nav-item:hover,
    .sidebar .nav-item.active {
      background: var(--accent2);
      color: #fff;
    }
    .sidebar .nav-item.locked {
      opacity: 0.5;
      pointer-events: none;
      position: relative;
    }
    .sidebar .nav-item.locked::after {
      content: '√∞≈∏‚Äù‚Äô';
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
    }

    /* Main area */
    .main {
      flex: 1; display: flex; flex-direction: column;
      background: var(--bg-main);
    }
    header {
      background: var(--bg-panel); padding: 1.2rem 2rem;
      box-shadow: 0 2px 8px #e3f2fd;
      border-bottom: 1.5px solid #b3d8ff;
    }
    header h1 {
      margin: 0; color: var(--accent2); font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: 1px;
    }
    .content {
      flex: 1; overflow-y: auto; padding: 2rem 2.5rem;
    }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    .widget {
      background: var(--bg-panel); padding: 1.5rem 1.2rem;
      border-radius: var(--radius); margin-bottom: 2rem;
      box-shadow: 0 2px 8px #e3f2fd;
      border: 1.5px solid #b3d8ff;
    }
    .widget h3 { margin-top: 0; color: var(--accent); font-weight: 700; }

    .btn {
      background: var(--accent); color: #fff;
      border: none; padding: 0.6rem 1.3rem;
      cursor: pointer; border-radius: 6px;
      font-weight: bold; margin-right: 0.5rem;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .btn:hover {
      background: var(--accent2);
      color: #fff;
    }
    .list { list-style: none; padding: 0; }
    .list li { margin: 0.5rem 0; }
    .list a { color: var(--accent); text-decoration: none; }
    .list a:hover { text-decoration: underline; }

    .content-area {
      background: #f4fffd; padding: 1rem;
      border-radius: var(--radius); margin-top: 1rem;
      max-height: 300px; overflow-y: auto;
      border: 1px solid #b3d8ff;
    }
    .status { display: flex; gap: 1rem; flex-wrap: wrap; }
    .status div {
      background: #e3f2fd; flex: 1 1 120px;
      padding: 1rem; border-radius: var(--radius);
      text-align: center;
      color: var(--accent2);
      font-weight: 700;
      border: 1px solid #b3d8ff;
    }
    /* Enrollment Modal Styles */
    #enrollmentModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(10,132,255,0.12);
      z-index: 2000;
      overflow-y: auto;
    }
    .enrollment-content {
      background: #fff;
      margin: 3rem auto;
      padding: 2.5rem 2rem;
      width: 95%;
      max-width: 600px;
      border-radius: 16px;
      color: #222;
      box-shadow: 0 4px 24px #e3f2fd;
      border: 1.5px solid #b3d8ff;
      position: relative;
    }
    .enrollment-content h2 { margin-top: 0; color: var(--accent); font-weight: 700;}
    .form-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;
    }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: var(--accent2); font-weight: 600;}
    .form-group input, .form-group select {
      width: 100%; padding: 0.5rem; background: #f7fafc; border: 1px solid #b3d8ff; border-radius: 6px; color: #222;
      font-family: 'Quicksand', sans-serif;
    }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    .locked { opacity: 0.6; pointer-events: none; position: relative; }
    .locked::after { content: '√∞≈∏‚Äù‚Äô'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }

    /* Agreement Modal Styles */
    #agreementModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(10,132,255,0.12);
      z-index: 2000;
      overflow-y: auto;
    }
    .agreement-content {
      background: #fff;
      margin: 3rem auto;
      padding: 2.5rem 2rem;
      width: 95%;
      max-width: 700px;
      border-radius: 16px;
      color: #222;
      box-shadow: 0 4px 24px #e3f2fd;
      border: 1.5px solid #b3d8ff;
      position: relative;
    }
    .agreement-content h2 { margin-top: 0; color: var(--accent); font-weight: 700;}
    .agreement-content p {
      margin: 0.5rem 0;
      line-height: 1.6;
    }
    .agreement-content ul {
      margin: 0.5rem 0 1.5rem 1.5rem;
      line-height: 1.6;
    }
    .agreement-content label {
      display: flex;
      align-items: center;
      font-weight: 600;
      margin: 1rem 0;
    }
    .agreement-content input[type="checkbox"] {
      margin-right: 0.5rem;
    }

    /* Chat styles */
    #chatContacts {
      border-right: 1px solid #e2e8f0;
      overflow-y: auto;
      max-height: 400px;
    }
    #chatContacts .list-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #e2e8f0;
      transition: background 0.2s;
    }
    #chatContacts .list-item:hover {
      background: #f0f8ff;
    }
    #chatHistory {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f9f9f9;
      min-height: 300px;
    }
    .msg {
      word-wrap: break-word;
      line-height: 1.4;
    }
    .msg.user {
      background: #0a84ff !important;
      color: #fff !important;
    }
    .msg.ai {
      background: #f0f0f0 !important;
      color: #000 !important;
    }
    .msg.error {
      background: #dc3545 !important;
      color: #fff !important;
    }
    #chatInput {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px;
    }
    #chatSendBtn {
      background: #0a84ff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
    #chatSendBtn:hover {
      background: #0066cc;
    }

    /* Quiz styles */
    .quiz-content {
      background: #f7fafc;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid #e3f2fd;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .loading {
      text-align: center;
      color: var(--accent);
      font-weight: 600;
      padding: 2rem;
    }
    .error {
      color: var(--accent2);
      font-weight: 600;
      padding: 1rem;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: var(--radius);
    }

    /* Enhanced Lecture UI Styles */
    .lecture-agent-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .lecture-agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
    }
    .agent-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2em;
      font-weight: bold;
      margin-right: 12px;
    }
    .agent-info {
      flex: 1;
    }
    .agent-name {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .agent-specialization {
      color: #64748b;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    .agent-stats {
      display: flex;
      gap: 16px;
      font-size: 0.8em;
      color: #64748b;
    }
    .context-display {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-size: 0.9em;
    }
    .context-display strong {
      color: var(--accent);
    }
    
    /* Chat-style message bubbles */
    .msg {
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      animation: fadeInUp 0.3s ease-out;
    }
    .msg.user {
      background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .msg.ai {
      background: #f8fafc;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    .msg.thinking {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
      margin-right: auto;
      text-align: center;
      font-style: italic;
    }
    .msg.error {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
      margin-right: auto;
    }
    .msg.agent-action {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #0ea5e9;
      color: #0c4a6e;
      text-align: center;
      margin: 12px auto;
      max-width: 95%;
    }
    
    /* Agent selector */
    .agent-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .agent-selector button {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      color: #64748b;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .agent-selector button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .agent-selector button.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Lecture history sidebar */
    .lecture-history {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .lecture-history h4 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 1.1em;
    }
    .history-item {
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .history-item:hover {
      background: #f0f9ff;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-item .title {
      font-weight: 600;
      color: var(--text-main);
    }
    .history-item .meta {
      font-size: 0.8em;
      color: #64748b;
    }

    /* Notification System */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideInRight 0.3s ease-out;
      max-width: 300px;
    }
    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .notification.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Agent Performance Indicators */
    .agent-performance {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .performance-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: 600;
    }
    .performance-badge.excellent {
      background: #dcfce7;
      color: #166534;
    }
    .performance-badge.good {
      background: #fef3c7;
      color: #92400e;
    }
    .performance-badge.new {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* Quick Actions Panel */
    .quick-actions {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 16px;
      display: none;
      z-index: 999;
    }
    .quick-actions.visible {
      display: block;
      animation: fadeInUp 0.3s ease-out;
    }
    .quick-actions button {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-actions button:hover {
      background: var(--accent);
      color: white;
    }

    /* Enhanced context info box */
    .context-info-expanded {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #0ea5e9;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      position: relative;
    }
    .context-info-expanded::before {
      content: 'üéØ';
      position: absolute;
      top: -10px;
      left: 16px;
      background: white;
      padding: 0 8px;
      font-size: 1.2em;
    }
    .context-info-expanded h4 {
      margin: 0 0 8px 0;
      color: #0c4a6e;
    }
    .context-info-expanded .context-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .context-item {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #bae6fd;
    }
    .context-item strong {
      color: #0ea5e9;
    }

    /* Email Delivery Section */
    #emailDeliverySection {
      margin: 2rem auto;
      max-width: 600px;
    }
    #emailDeliverySection h3 {
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 1rem;
    }
    #emailDeliverySection .form-group {
      margin-bottom: 1rem;
    }
    #emailDeliverySection .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--accent2);
      font-weight: 600;
    }
    #emailDeliverySection .form-group input,
    #emailDeliverySection .form-group textarea {
      width: 100%;
      padding: 0.5rem;
      background: #f7fafc;
      border: 1px solid #b3d8ff;
      border-radius: 6px;
      color: #222;
      font-family: 'Quicksand', sans-serif;
    }
    #emailDeliverySection .btn-primary {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.6rem 1.3rem;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      transition: background 0.2s;
    }
    #emailDeliverySection .btn-primary:hover {
      background: var(--accent2);
      color: #fff;
    }

    /* Email Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--accent);
      font-weight: 700;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover,
    .close:focus {
      color: var(--accent2);
      text-decoration: none;
    }
    
    .spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Email Tab Styles */
    .email-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1rem;
    }

    .email-filters {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 1rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: #fff;
      color: #666;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .filter-btn:hover {
      background: #f8f9fa;
      border-color: var(--accent);
    }

    .filter-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .email-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .email-item {
      display: flex;
      align-items: flex-start;
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
      cursor: pointer;
    }

    .email-item:hover {
      background: #f8f9fa;
    }

    .email-avatar {
      margin-right: 1rem;
      flex-shrink: 0;
    }

    .avatar-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .email-content {
      flex: 1;
      min-width: 0;
    }

    .email-header-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .email-recipient {
      font-weight: 600;
      color: #333;
    }

    .email-date {
      color: #666;
      font-size: 0.9rem;
    }

    .email-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .email-status.sent {
      background: #e3f2fd;
      color: #1976d2;
    }

    .email-status.received {
      background: #e8f5e8;
      color: #388e3c;
    }

    .email-subject {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.05rem;
    }

    .email-preview {
      color: #666;
      line-height: 1.4;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2;
      overflow: hidden;
    }

    .email-agents {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .agent-tag {
      background: #fff3e0;
      color: #f57c00;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .email-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-left: 1rem;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: #666;
    }

    .action-btn:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    @media (max-width: 768px) {
      .email-item {
        flex-direction: column;
        gap: 1rem;
      }
      
      .email-actions {
        flex-direction: row;
        margin-left: 0;
      }
      
      .email-header-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
    }
  
    /* Agent Status Indicators */
    .agent-status {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .agent-status.online { background-color: #28a745; }
    .agent-status.busy { background-color: #ffc107; }
    .agent-status.offline { background-color: #dc3545; }
    
    .agent-loading {
        display: none;
        margin-left: 8px;
    }
    
    .agent-loading.show {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #0a84ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .agent-transition {
        transition: all 0.3s ease-in-out;
    }
    
    .agent-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    
    /* Quiz History Styles */
    .quiz-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 15px;
      padding: 15px;
      transition: all 0.2s ease;
    }
    
    .quiz-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #3b82f6;
    }
    
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .quiz-header h4 {
      margin: 0;
      color: #1e293b;
      font-size: 16px;
    }
    
    .quiz-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .quiz-status.completed {
      background: #dcfce7;
      color: #166534;
    }
    
    .quiz-status.pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .quiz-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    
    .quiz-week {
      padding: 2px 8px;
      border-radius: 10px;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .quiz-lecturer, .quiz-date {
      font-size: 12px;
      color: #64748b;
    }
    
    .quiz-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      color: #374151;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }
    
    .action-btn:hover:not(:disabled) {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .action-btn.take-quiz {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .action-btn.take-quiz:hover:not(:disabled) {
      background: #2563eb;
    }
    
    .action-btn.view-quiz {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .action-btn.view-quiz:hover {
      background: #059669;
    }
    
    .action-btn.download-quiz {
      background: #f59e0b;
      color: white;
      border-color: #f59e0b;
    }
    
    .action-btn.download-quiz:hover {
      background: #d97706;
    }
    
    .action-btn.delete-quiz {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    
    .action-btn.delete-quiz:hover {
      background: #dc2626;
    }
    
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .quiz-list .no-content {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .quiz-list .no-content h3 {
      color: #374151;
      margin-bottom: 10px;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

</style>
</head>
<body>
  <!-- Enrollment Modal -->
  <div id="enrollmentModal">
    <div class="enrollment-content">
      <h2>Complete Your Enrollment</h2>
      <p>Please provide the following information to continue with your enrollment.</p>
      <form id="enrollmentForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" required>
          </div>
          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" required>
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" required>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input type="tel" id="phone" required>
          </div>
          <div class="form-group">
            <label for="dob">Date of Birth *</label>
            <input type="date" id="dob" required>
          </div>
          <div class="form-group">
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="">Select...</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
              <option value="prefer-not-to-say">Prefer not to say</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="address">Street Address *</label>
            <input type="text" id="address" required>
          </div>
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" required>
          </div>
          <div class="form-group">
            <label for="state">State *</label>
            <input type="text" id="state" required>
          </div>
          <div class="form-group">
            <label for="zip">ZIP Code *</label>
            <input type="text" id="zip" required>
          </div>
          <div class="form-group">
            <label for="education">Highest Education Level *</label>
            <select id="education" required>
              <option value="">Select...</option>
              <option value="high-school">High School/GED</option>
              <option value="some-college">Some College</option>
              <option value="associates">Associate's Degree</option>
              <option value="bachelors">Bachelor's Degree</option>
              <option value="masters">Master's Degree</option>
              <option value="phd">Doctorate/PhD</option>
            </select>
          </div>
          <div class="form-group">
            <label for="employment">Current Employment Status *</label>
            <select id="employment" required>
              <option value="">Select...</option>
              <option value="employed">Employed</option>
              <option value="unemployed">Unemployed</option>
              <option value="student">Student</option>
              <option value="self-employed">Self-Employed</option>
              <option value="retired">Retired</option>
            </select>
          </div>
          <div class="form-group">
            <label for="income">Annual Income *</label>
            <select id="income" required>
              <option value="">Select...</option>
              <option value="0-25000">$0 - $25,000</option>
              <option value="25001-50000">$25,001 - $50,000</option>
              <option value="50001-75000">$50,001 - $75,000</option>
              <option value="75001-100000">$75,001 - $100,000</option>
              <option value="100001+">$100,001+</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label>
              <input type="checkbox" id="terms" required>
              I agree to the terms and conditions *
            </label>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Submit Enrollment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Agreement Modal -->
  <div id="agreementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10,132,255,0.12); z-index: 2000; overflow-y: auto;">
    <div class="enrollment-content" style="max-width: 700px;">
      <h2>VOLUNTEER APPRENTICESHIP AGREEMENT</h2>
      <p>Non-Disclosure and Non-Compete Agreement</p>
      
      <div style="max-height: 350px; overflow-y: auto; border: 1px solid #e3f2fd; padding: 1rem; margin-bottom: 1.5rem; border-radius: var(--radius); background: #f7fafc;">
        <p>This Volunteer Apprenticeship Agreement ("Agreement") is made as of the date of signature below, by and between Alambda Systems, LLC, located at 911 Washington Ave, Suite 838, St. Louis, MO 63101, ("Alambda"), and the undersigned individual ("Apprentice").</p>
        
        <h4>1. Purpose</h4>
        <p>This Agreement outlines the terms under which the Apprentice will serve as a volunteer apprentice with Alambda and sets forth obligations regarding confidentiality and competition.</p>
        
        <h4>2. Volunteer Nature</h4>
        <p>The Apprentice acknowledges and agrees that:</p>
        <ul>
          <li>This apprenticeship is voluntary and unpaid.</li>
          <li>Participation does not create an employment relationship.</li>
          <li>The purpose is for training, mentorship, and educational development in AI, cloud computing, software engineering, cybersecurity, and related disciplines.</li>
        </ul>
        
        <h4>3. Confidentiality (Non-Disclosure)</h4>
        <p>The Apprentice agrees to maintain strict confidentiality regarding all proprietary and sensitive information accessed or received during the apprenticeship, including but not limited to:</p>
        <ul>
          <li>Alambda's AI models, systems, source code, architecture, and internal tools;</li>
          <li>Project work, research, training materials, curriculum outlines, and strategies;</li>
          <li>Client, government, healthcare, or partner data, communications, and contracts;</li>
          <li>All discussions, code, files, or intellectual property related to internal Alambda initiatives.</li>
        </ul>
        
        <h4>4. Non-Compete & Intellectual Property</h4>
        <p>For the duration of the apprenticeship and for one (1) year after its conclusion, the Apprentice shall not develop, promote, or operate any educational AI platform or apprenticeship program that mimics or directly competes with Alambda's systems.</p>
        <p>All inventions, code, documentation, or AI tools developed during the apprenticeship shall be considered property of Alambda Systems, LLC, unless otherwise agreed in writing.</p>
        
        <h4>5. Team Structure & Participation</h4>
        <p>As part of the Alambda Cadet Program, you will be assigned to work in teams focusing on the following areas:</p>
        <ul>
          <li><strong>Team 1 ‚Äì AI & Data Science:</strong> Develop models, chatbots, embeddings, and clinical intelligence tools.</li>
          <li><strong>Team 2 ‚Äì PLM / Lifecycle Management:</strong> Manage MLOps flows, product lifecycle workflows, and DevOps automation.</li>
          <li><strong>Team 3 ‚Äì Python Software Development:</strong> Code the backend tools for dashboards, APIs, and automation.</li>
          <li><strong>Team 4 ‚Äì Business Development & Strategy:</strong> Craft proposals, pursue RFPs, and build growth channels and documentation.</li>
        </ul>
        <p>Each cadet will participate in two teams, contributing to multiple areas of expertise while developing specialized skills.</p>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; font-weight: 600;">
          <input type="checkbox" id="agreementCheckbox" style="margin-right: 0.5rem;">
          I have read and agree to the Volunteer Apprenticeship Agreement, including the non-disclosure and non-compete provisions
        </label>
      </div>
      
      <div class="form-actions">
        <button id="cancelAgreement" class="btn" style="background: #ccc;">Cancel</button>
        <button id="acceptAgreement" class="btn" disabled>Accept Agreement</button>
      </div>
    </div>
  </div>

<body>
  <!-- Sidebar Navigation: Reorder tabs and add Dashboard -->
  <div class="sidebar">
    <div class="nav-item active" data-tab="dashboard">Dashboard</div>
    <div class="nav-item" data-tab="teams">Teams</div>           <!-- moved up -->
    <div class="nav-item" data-tab="lectures">Lectures</div>
    <div class="nav-item" data-tab="quizzes">Quizzes</div>
    <div class="nav-item" data-tab="assignments">Assignments</div>
    <div class="nav-item" data-tab="email">üìß Email</div>
    <div class="nav-item" data-tab="chat">üí¨ Chat</div>
    <!-- Modules & Progress removed -->
    <div class="nav-item" id="logout">Logout</div>
  </div>

  <div class="main">
    <header>
      <h1 id="trackTitle">Cadet Dashboard</h1>
    </header>
    <div id="enrollmentPendingMsg" style="display:none; margin:2rem auto; max-width:500px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; border-radius:10px; padding:2rem; text-align:center; font-size:1.3rem; font-weight:600;">
    Enrollment Pending. Your enrollment is under review. You will get access to all sections once approved.
    </div>
    <div class="content">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-pane active">
        <div class="widget">
          <h3>Welcome to the Cadet Dashboard</h3>
          <p>Use the sidebar to access Lectures, Modules, Quizzes, Assignments, and more.</p>
        </div>
        <!-- Progress Gauges -->
        <div class="widget" style="display:flex;gap:2rem;flex-wrap:wrap;align-items:center;">
          <div style="text-align:center;">
            <canvas id="gaugeLectures" width="120" height="120"></canvas>
            <div style="font-weight: bold; margin-top: 8px;">
              <span id="lecturesCountDisplay">0</span> Lectures
            </div>
          </div>
          <div style="text-align:center;">
            <canvas id="gaugeModules" width="120" height="120"></canvas>
            <div style="font-weight: bold; margin-top: 8px;">
              <span id="modulesCountDisplay">0</span> Modules
            </div>
          </div>
          <div style="text-align:center;">
            <canvas id="gaugeQuizzes" width="120" height="120"></canvas>
            <div style="font-weight: bold; margin-top: 8px;">
              <span id="quizzesCountDisplay">0</span> Quizzes
            </div>
          </div>
          <div style="text-align:center;">
            <canvas id="gaugeCompleted" width="120" height="120"></canvas>
            <div style="font-weight: bold; margin-top: 8px;">
              <span id="completedCountDisplay">0</span> Completed
            </div>
          </div>
        </div>
        <div class="widget">
          <h3>Your Assignments</h3>
          <ul id="assignmentList" class="list"></ul>
        </div>
      </div>
      <!-- Lectures Tab -->
      <div id="lectures" class="tab-pane">
        <div class="widget">
          <h3>Lectures</h3>
          
          <!-- Agent Selector -->
          <div class="agent-selector">
            <button data-agent="dr-smith" class="active">Dr. Smith (AI Expert)</button>
            <button data-agent="prof-chen">Prof. Chen (Data Scientist)</button>
            <button data-agent="dr-wilson">Dr. Wilson (Systems Architect)</button>
            <button data-agent="prof-taylor">Prof. Taylor (Leadership)</button>
          </div>
          
          <!-- Current Agent Display -->
          <div id="currentAgentCard" class="lecture-agent-card">
            <div style="display: flex; align-items: center;">
              <div class="agent-avatar">DS</div>
              <div class="agent-info">
                <div class="agent-name">Dr. Smith</div>
                <div class="agent-specialization">AI & Machine Learning Expert</div>
                <div class="agent-stats">
                  <span>Used: <strong>0</strong> times</span>
                  <span>Last Used: <strong>Never</strong></span>
                  <span>Specialization: <strong>AI Systems</strong></span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Context Display -->
          <div class="context-display">
            <strong>Current Context:</strong> <span id="contextSummary">No context set</span>
          </div>
          
          <div style="margin-bottom:1rem;">
            <label for="weekSelect">Select Week:</label>
            <select id="weekSelect" class="form-control" style="width:120px;display:inline-block;margin-left:0.5rem;">
              <!-- populate with weeks -->
            </select>
          </div>
          <ul id="lecturesList" class="list"></ul>
          <div id="lectureContent" class="content-area" style="display:none;"></div>
          <div style="margin-top:1.5rem;">
            <button id="refreshLectures" class="btn">Refresh</button>
            <button id="genLecture" class="btn">Generate New Lecture</button>
            <button id="clearLectureChat" class="btn" style="background: #64748b;">Clear Chat</button>
          </div>
        </div>
        
        <!-- Professor Lecture History -->
        <div class="lecture-history">
          <h4>üìö Professor Lecture History</h4>
          <div style="margin-bottom: 1rem;">
            <label for="professorSelect">Select Professor:</label>
            <select id="professorSelect" class="form-control" style="width:200px;display:inline-block;margin-left:0.5rem;">
              <option value="">All Professors</option>
              <option value="dr-smith">Dr. Smith (AI Expert)</option>
              <option value="prof-chen">Prof. Chen (Data Scientist)</option>
              <option value="dr-wilson">Dr. Wilson (Systems Architect)</option>
              <option value="prof-taylor">Prof. Taylor (Leadership)</option>
            </select>
          </div>
          <div id="professorLectureHistory">
            <div style="text-align: center; color: #64748b; font-style: italic;">
              No lectures generated yet
            </div>
          </div>
        </div>
        
        <div class="widget">
          <h3>Lecture PDF Output</h3>
          <button id="downloadLecturePDF" class="btn">Download as PDF</button>
          <div id="lecturePDFOutput" class="content-area" style="margin-top:1rem;min-height:80px;">Select a lecture to preview PDF output here.</div>
        </div>
      </div>
      <!-- Quizzes Tab -->
      <div id="quizzes" class="tab-pane">
        <div class="widget">
          <h3>Generate Quiz</h3>
          <div style="margin-bottom:1rem;">
            <select id="quizWeek" class="form-control" style="width:120px;display:inline-block;">
              <!-- populate with <option value="1">Week 1</option>‚Ä¶ -->
            </select>
            <button id="genQuiz" class="btn">Generate 20-Question Quiz</button>
            <button id="refreshQuizzes" class="btn" style="margin-left:10px;">Refresh</button>
          </div>
          <div id="quizOutput" class="content-area" style="max-height:500px; overflow-y:auto;"></div>
          <button id="copyQuiz" class="btn" style="margin-top:0.5rem; display:none;">Copy to Clipboard</button>
        </div>
        
        <!-- Quiz History Section -->
        <div class="widget" style="margin-top: 20px;">
          <h3>üìù Your Quiz History</h3>
          <div id="quiz-history" style="max-height: 600px; overflow-y: auto;">
            <!-- Quiz history will be populated here -->
          </div>
        </div>
      </div>
      <!-- Assignments Tab -->
      <div id="assignments" class="tab-pane">
        <div class="widget">
          <h3>Your Assignments</h3>
          <ul id="assignmentList" class="list"></ul>
        </div>
      </div>
      <!-- Teams Tab -->
      <div id="teams" class="tab-pane">
        <div id="cadetChallenge">
          <h2>üéØ Welcome to the Alambda Cadet Program</h2>
          <p>You're now part of a hands-on, real-world experience where you'll build meaningful solutions in AI, Python, PLM, and Business Strategy.</p>
          
          <h3>üõ†Ô∏è Team Focus Areas</h3>
          <div id="teamTiles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
            <div class="team-tile" data-team="ai" tabindex="0" style="background: #f4f8ff; border: 1px solid #b3d8ff; border-radius: var(--radius); padding: 1rem; cursor:pointer; transition:box-shadow 0.2s;">
              <h4>üîπ Team 1 ‚Äì AI & Data Science</h4>
              <p>Develop models, chatbots, embeddings, and clinical intelligence tools.</p>
            </div>
            <div class="team-tile" data-team="plm" tabindex="0" style="background: #f4f8ff; border: 1px solid #b3d8ff; border-radius: var(--radius); padding: 1rem; cursor:pointer; transition:box-shadow 0.2s;">
              <h4>üîπ Team 2 ‚Äì PLM / Lifecycle Management</h4>
              <p>Manage MLOps flows, product lifecycle workflows, and DevOps automation.</p>
            </div>
            <div class="team-tile" data-team="python" tabindex="0" style="background: #f4f8ff; border: 1px solid #b3d8ff; border-radius: var(--radius); padding: 1rem; cursor:pointer; transition:box-shadow 0.2s;">
              <h4>üîπ Team 3 ‚Äì Python Software Development</h4>
              <p>Code the backend tools for dashboards, APIs, and automation.</p>
            </div>
            <div class="team-tile" data-team="bizdev" tabindex="0" style="background: #f4f8ff; border: 1px solid #b3d8ff; border-radius: var(--radius); padding: 1rem; cursor:pointer; transition:box-shadow 0.2s;">
              <h4>üîπ Team 4 ‚Äì Business Development & Strategy</h4>
              <p>Craft proposals, pursue RFPs, and build growth channels and documentation.</p>
            </div>
          </div>
          
          <div id="teamDetailSection" style="display:none; margin-top:2rem;"></div>
          
          <p>As part of your cadet experience, you'll be assigned to work on <strong>two teams</strong>, contributing to multiple areas while developing specialized skills.</p>
          
          <h3>Collaboration Resources</h3>
          <ul class="list">
            <li>üîó <a href="https://framevr.io/alambda/" target="_blank">Virtual Collaboration Space</a></li>
            <li>üîó <a href="https://discord.gg/VaefZYVj" target="_blank">Project Workspace & Tools - Dicord</a></li>
          </ul>

          <button id="acceptChallenge" class="btn btn-accept">üéâ Accept the Challenge</button>
        </div>
      </div>

      <!-- Email Tab -->
      <div id="email" class="tab-pane">
        <div class="widget">
          <div class="email-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>üìß Email Center</h3>
            <button onclick="openEmailModal()" class="btn btn-primary">
              <i class="fas fa-plus"></i> Compose Email
            </button>
          </div>
          
          <!-- Email Filters -->
          <div class="email-filters" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <button class="filter-btn active" data-filter="all">All Emails</button>
            <button class="filter-btn" data-filter="sent">Sent</button>
            <button class="filter-btn" data-filter="received">Received</button>
            <button class="filter-btn" data-filter="with-agents">With AI Agents</button>
          </div>
          
          <!-- Email List -->
          <div class="email-list" id="emailList">
            <!-- Sample Email Items -->
            <div class="email-item" data-type="sent" data-agents="true">
              <div class="email-avatar">
                <div class="avatar-circle">PS</div>
              </div>
              <div class="email-content">
                <div class="email-header-info">
                  <span class="email-recipient">prof.smith@university.edu</span>
                  <span class="email-date">Dec 15, 2024</span>
                  <span class="email-status sent">Sent</span>
                </div>
                <div class="email-subject">Partnership Opportunity with Prof. Smith</div>
                <div class="email-preview">Dear Prof. Smith, I hope this email finds you well. I'm reaching out from Alambda Systems regarding potential partnership...</div>
                <div class="email-agents">
                  <span class="agent-tag">Dr. Smith (AI Expert)</span>
                  <span class="agent-tag">Prof. Chen (Data Science)</span>
                </div>
              </div>
              <div class="email-actions">
                <button class="action-btn" onclick="viewEmail(1)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="replyEmail(1)">
                  <i class="fas fa-reply"></i>
                </button>
              </div>
            </div>
            
            <div class="email-item" data-type="received">
              <div class="email-avatar">
                <div class="avatar-circle">JD</div>
              </div>
              <div class="email-content">
                <div class="email-header-info">
                  <span class="email-recipient">john.doe@company.com</span>
                  <span class="email-date">Dec 14, 2024</span>
                  <span class="email-status received">Received</span>
                </div>
                <div class="email-subject">Re: AI Collaboration Proposal</div>
                <div class="email-preview">Thank you for reaching out. We're very interested in exploring potential collaborations with Alambda Systems...</div>
              </div>
              <div class="email-actions">
                <button class="action-btn" onclick="viewEmail(2)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="replyEmail(2)">
                  <i class="fas fa-reply"></i>
                </button>
              </div>
            </div>
            
            <div class="email-item" data-type="sent">
              <div class="email-avatar">
                <div class="avatar-circle">MJ</div>
              </div>
              <div class="email-content">
                <div class="email-header-info">
                  <span class="email-recipient">mary.johnson@tech.edu</span>
                  <span class="email-date">Dec 13, 2024</span>
                  <span class="email-status sent">Sent</span>
                </div>
                <div class="email-subject">Research Collaboration Opportunity</div>
                <div class="email-preview">Dear Dr. Johnson, We would like to propose a research collaboration focusing on machine learning applications...</div>
              </div>
              <div class="email-actions">
                <button class="action-btn" onclick="viewEmail(3)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="replyEmail(3)">
                  <i class="fas fa-reply"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div id="emailEmptyState" style="display: none; text-align: center; padding: 3rem; color: #666;">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <h4>No emails found</h4>
            <p>Start by composing your first email!</p>
          </div>
        </div>
      </div>

      <!-- Chat Tab -->
      <div id="chat" class="tab-pane">
        <div class="widget">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>üí¨ Chat with Agents & Instructors</h3>
            <button onclick="loadChatContacts()" class="btn" style="padding:0.3rem 0.8rem; font-size:0.9rem;">
              üîÑ Refresh Contacts
            </button>
          </div>
          <div style="display:flex; gap:1rem; height: 450px;">
            <!-- Contacts List -->
            <div id="chatContacts" style="width:250px; border-right:1px solid #e2e8f0; overflow-y:auto;">
              <div style="padding:8px; font-weight:600; color:#0a84ff; border-bottom:1px solid #e2e8f0;">
                Available Contacts
              </div>
              <div style="padding:16px; text-align:center; color:#666;">
                Loading contacts...
              </div>
            </div>
            <!-- Chat Window -->
            <div style="flex:1; display:flex; flex-direction:column;">
              <div id="chatHistory" class="content-area" style="flex:1; overflow-y:auto; background:#f9f9f9; border:1px solid #e2e8f0; border-radius:6px;">
                <div style="padding:20px; text-align:center; color:#666;">
                  Select a contact to start chatting
                </div>
              </div>
              <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                <input id="chatInput" type="text" class="form-control" placeholder="Type a message‚Ä¶" style="flex:1;" disabled>
                <button id="chatSendBtn" class="btn" disabled>Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Remove the old #cadetChallenge and #teamDetailSection from outside .main/.content -->

  <!-- Add this after the main dashboard content, before the #cadetChallenge section for best visibility and usability -->
  <div id="vr-collab-section" style="margin:2.5rem auto 2rem auto;max-width:900px;">
  <h3 style="color:#0a84ff;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:10px;">
    <i class="fas fa-vr-cardboard"></i> Virtual Collaboration Space
  </h3>
  <div style="background:#f7fafc;border:1.5px solid #b3d8ff;border-radius:16px;box-shadow:0 2px 12px #e3f2fd;padding:1.5rem;">
    <iframe
      src="https://framevr.io/alambda"
      title="Alambda FrameVR"
      style="width:100%;min-height:420px;max-height:60vh;border-radius:12px;border:none;box-shadow:0 2px 12px #e3f2fd;background:transparent;"
      allow="microphone; camera; fullscreen; vr; xr-spatial-tracking"
      loading="lazy"
    ></iframe>
    <div style="margin-top:1rem;display:flex;flex-wrap:wrap;gap:12px;">
      <a href="https://framevr.io/alambda" target="_blank" class="btn btn-outline-primary" style="font-size:1rem;">
        <i class="fas fa-external-link-alt"></i> Open in New Tab
      </a>
      <span style="color:#555;font-size:0.98rem;">
        <i class="fas fa-info-circle"></i> Use your mic/camera for live class, chat, and VR collaboration.
      </span>
    </div>
    <!-- Zoom Panel (cannot embed, so use a button) -->
    <div style="margin-top:2rem;">
      <h3 style="color:#0a84ff;font-weight:700;margin-bottom:0.7rem;display:flex;align-items:center;gap:10px;">
        <i class="fas fa-video"></i> Zoom Meeting Room
      </h3>
      <div style="background:#fff;border:1.5px solid #b3d8ff;border-radius:12px;padding:1.5rem;text-align:center;">
        <p style="color:#555;font-size:1.08rem;margin-bottom:1.2rem;">
          Zoom cannot be embedded here due to browser security restrictions.<br>
          Please use the button below to join the meeting in a new tab.
        </p>
        <a href="https://zoom.us/j/YOUR_MEETING_ID" target="_blank" class="btn" style="font-size:1.1rem;">
          <i class="fas fa-external-link-alt"></i> Join Zoom Meeting
        </a>
        <div style="margin-top:0.7rem;">
          <span style="color:#555;font-size:0.98rem;">
            <i class="fas fa-info-circle"></i> Log in with your Zoom account to join meetings.
          </span>
        </div>
      </div>
    </div>
    <!-- End Zoom Panel -->
  </div>
</div>

  <!-- Email Delivery Modal -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Send Email</h3>
        <span class="close" onclick="closeEmailModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- AI Agents Selector -->
        <div id="emailAgentSelector" style="margin-bottom:1rem; padding:0.75rem; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
          <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.75rem;">
            <strong style="color:#333;">ü§ñ Include AI Agents:</strong>
            <small style="color:#666;">(Select agents to include their expertise in your email)</small>
          </div>
          <div id="agentCheckboxes" style="display:flex; gap:0.5rem; flex-wrap:wrap; max-height:200px; overflow-y:auto;"></div>
        </div>
        
        <form id="emailDeliveryForm">
          <div class="form-group">
            <label for="emailTo">Recipient Email</label>
            <input type="email" id="emailTo" name="emailTo" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="emailSubject">Subject</label>
            <input type="text" id="emailSubject" name="emailSubject" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="emailContent">Content</label>
            <textarea id="emailContent" name="emailContent" class="form-control" rows="8" required></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">
              <span id="emailSendText">Send Email</span>
              <span id="emailSpinner" class="spinner" style="display:none;">‚ü≥</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Canvas Confetti library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
  // Global variables accessible throughout the script
  const API_ROOT = window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1') || window.location.origin.includes('file:') 
    ? 'http://localhost:5000' 
    : 'https://api.alambda.com'; // Use localhost for development, production API for deployed version
  const token = localStorage.getItem('authToken');
  const trackParam = new URLSearchParams(location.search).get('track');
  const track = (trackParam && trackParam !== 'Select Your Track') ? trackParam : 'cadet-1'; // Fix track parameter
  
  // Authenticated fetch helper - moved to global scope
  async function fetchAuth(url, opts={}) {
    const token = localStorage.getItem('authToken');
    opts.headers = { ...(opts.headers||{}), 'Authorization':`Bearer ${token}` };
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(await res.text());
    return res;
  }

  // Refresh quiz history display
  async function refreshQuizzes() {
    const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
    const quizHistoryDiv = document.getElementById('quiz-history');
    
    if (quizHistory.length === 0) {
      if (quizHistoryDiv) {
        quizHistoryDiv.innerHTML = `
          <div class="no-content">
            <h3>üìù No Quizzes Generated Yet</h3>
            <p>Generate quizzes from your lecture history to test your knowledge!</p>
            <p>Go to <strong>Lecture History</strong> and click <strong>üß† Quiz</strong> on any lecture.</p>
          </div>
        `;
      }
      
      // Still update count display for dashboard
      const quizCountEl = document.getElementById('quizzesCountDisplay');
      if (quizCountEl) {
        quizCountEl.innerText = '0';
      }
      return;
    }
    
    // Update dashboard count
    const quizCountEl = document.getElementById('quizzesCountDisplay');
    if (quizCountEl) {
      quizCountEl.innerText = quizHistory.length;
    }
    
    if (!quizHistoryDiv) return;
    
    let html = '<div class="quiz-list">';
    
    quizHistory.forEach(quiz => {
      const statusBadge = quiz.completed 
        ? `<span class="quiz-status completed">‚úÖ Score: ${quiz.score || 'N/A'}</span>`
        : `<span class="quiz-status pending">‚è≥ Pending</span>`;
        
      const difficultyColor = quiz.week <= 3 ? '#4CAF50' : quiz.week <= 6 ? '#FF9800' : '#F44336';
      
      html += `
        <div class="quiz-item">
          <div class="quiz-header">
            <h4>${quiz.topic}</h4>
            ${statusBadge}
          </div>
          <div class="quiz-meta">
            <span class="quiz-week" style="background: ${difficultyColor}">Week ${quiz.week}</span>
            <span class="quiz-lecturer">üë®‚Äçüè´ ${quiz.lecturer}</span>
            <span class="quiz-date">üïí ${new Date(quiz.timestamp).toLocaleDateString()}</span>
          </div>
          <div class="quiz-actions">
            <button onclick="takeQuiz('${quiz.id}')" class="action-btn take-quiz" ${quiz.completed ? 'disabled' : ''}>
              ${quiz.completed ? '‚úÖ Completed' : '‚ñ∂Ô∏è Take Quiz'}
            </button>
            <button onclick="viewQuizContent('${quiz.id}')" class="action-btn view-quiz">
              üëÅÔ∏è View
            </button>
            <button onclick="downloadQuiz('${quiz.id}')" class="action-btn download-quiz">
              üíæ Download
            </button>
            <button onclick="deleteQuiz('${quiz.id}')" class="action-btn delete-quiz">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    quizHistoryDiv.innerHTML = html;
  }
  
  // Global functions that need to be accessible from HTML onclick handlers
  function saveLectureToProgress(lectureData) {
    try {
      let progress = JSON.parse(localStorage.getItem('lectureProgress') || '[]');
      const existingIndex = progress.findIndex(p => p.id === lectureData.id);
      
      if (existingIndex >= 0) {
        progress[existingIndex] = { ...progress[existingIndex], ...lectureData, completed_at: new Date().toISOString() };
      } else {
        progress.push({ ...lectureData, completed_at: new Date().toISOString() });
      }
      
      localStorage.setItem('lectureProgress', JSON.stringify(progress));
      console.log('Lecture progress saved:', lectureData);
    } catch (error) {
      console.error('Error saving lecture progress:', error);
    }
  }

  async function generateMatchingQuiz(lectureId) {
    console.log('üß† Generating quiz for lecture:', lectureId);
    
    try {
      // Get lecture content from local storage or API
      let lectureContent = null;
      let lectureData = null;
      
      // First try to get from stored lectures
      const storedLectures = JSON.parse(localStorage.getItem('generatedLectures') || '[]');
      const lectureIndex = lectureId.includes('lecture-') ? 
        parseInt(lectureId.replace('lecture-', '')) - 1 : 
        storedLectures.findIndex(l => l.id === lectureId);
      
      if (lectureIndex >= 0 && lectureIndex < storedLectures.length) {
        const lecture = storedLectures[lectureIndex];
        lectureContent = lecture.content;
        lectureData = {
          topic: lecture.topic || `Week ${lecture.week} Lecture`,
          week: lecture.week || 1,
          lecturer: lecture.professor || 'Unknown Professor',
          id: lecture.id || lectureId
        };
      }
      
      // If not found in local storage, try to fetch from API
      if (!lectureContent) {
        try {
          const response = await fetchAuth(`${API_ROOT}/api/lectures/${track}`);
          if (response.ok) {
            const lectures = await response.json();
            const lecture = lectures.find(l => l.id === lectureId);
            if (lecture) {
              lectureContent = lecture.content;
              lectureData = {
                topic: lecture.topic || `Week ${lecture.week} Lecture`,
                week: lecture.week || 1,
                lecturer: lecture.professor || 'Unknown Professor',
                id: lecture.id
              };
            }
          }
        } catch (apiError) {
          console.log('üì° Could not fetch lecture from API');
        }
      }
      
      if (!lectureContent) {
        alert('‚ùå Lecture content not found. Please ensure the lecture exists.');
        return;
      }
      
      console.log('üìö Found lecture content, generating quiz...');
      
      // Show loading indicator
      const loadingHtml = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner"></div>
          <p>üß† AI is generating a custom quiz from the lecture content...</p>
          <p><em>This may take 10-15 seconds</em></p>
        </div>
      `;
      
      // Try to show loading in quiz output area
      const quizOutput = document.getElementById('quizOutput');
      if (quizOutput) {
        quizOutput.innerHTML = loadingHtml;
      }
      
      // Call the quiz generation endpoint
      const quizResponse = await fetchAuth(`${API_ROOT}/api/quizzes/generate-from-lecture`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          lecture_content: lectureContent,
          topic: lectureData.topic,
          week: lectureData.week,
          lecturer: lectureData.lecturer
        })
      });
      
      if (!quizResponse.ok) {
        throw new Error(`Quiz generation failed: ${quizResponse.status}`);
      }
      
      const quizData = await quizResponse.json();
      console.log('‚úÖ Quiz generated successfully:', quizData);
      
      // Create quiz object for storage
      const quiz = {
        id: `quiz-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        lecture_id: lectureData.id,
        topic: quizData.quiz_title || lectureData.topic,
        week: quizData.week || lectureData.week,
        lecturer: quizData.lecturer || lectureData.lecturer,
        questions: quizData.questions || [],
        timestamp: new Date().toISOString(),
        completed: false,
        score: null
      };
      
      // Save to quiz history
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      quizHistory.unshift(quiz); // Add to beginning
      
      // Keep only last 50 quizzes
      if (quizHistory.length > 50) {
        quizHistory.length = 50;
      }
      
      localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
      
      // Display the quiz
      displayGeneratedQuiz(quiz);
      
      // Refresh quiz list
      refreshQuizzes();
      
      // Show success message
      alert(`‚úÖ Quiz generated successfully!\nüìù ${quiz.questions.length} questions created\nüéØ Topic: ${quiz.topic}`);
      
    } catch (error) {
      console.error('‚ùå Error generating quiz:', error);
      
      // Clear loading indicator
      const quizOutput = document.getElementById('quizOutput');
      if (quizOutput) {
        quizOutput.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #dc3545;">
            <h4>‚ùå Quiz Generation Failed</h4>
            <p>Error: ${error.message}</p>
            <p><em>Please try again or check if the server is running.</em></p>
          </div>
        `;
      }
      
      alert(`‚ùå Failed to generate quiz: ${error.message}`);
    }
  }

  function displayGeneratedQuiz(quiz) {
    console.log('üìù Displaying generated quiz:', quiz);
    
    const quizOutput = document.getElementById('quizOutput');
    if (!quizOutput) {
      console.error('Quiz output element not found');
      return;
    }
    
    let html = `
      <div class="quiz-container" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
        <div class="quiz-header" style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.8rem;">üìù ${quiz.topic}</h2>
          <p style="margin: 0; opacity: 0.9;">Week ${quiz.week} ‚Ä¢ ${quiz.lecturer}</p>
          <p style="margin: 0.5rem 0 0 0; opacity: 0.8; font-size: 0.9rem;">${quiz.questions.length} Questions ‚Ä¢ Generated ${new Date(quiz.timestamp).toLocaleString()}</p>
        </div>
        
        <form id="quizForm-${quiz.id}" class="quiz-form">
    `;
    
    quiz.questions.forEach((question, index) => {
      html += `
        <div class="question-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h4 style="color: #333; margin: 0 0 1rem 0; font-size: 1.1rem;">
            <span style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 4px; margin-right: 0.5rem; font-size: 0.9rem;">Q${index + 1}</span>
            ${question.question}
          </h4>
          <div class="options" style="margin-left: 1rem;">
      `;
      
      question.options.forEach((option, optIndex) => {
        const optionId = `q${index}_opt${optIndex}`;
        html += `
          <div style="margin: 0.8rem 0;">
            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.8rem; border: 1px solid #e0e0e0; border-radius: 6px; transition: all 0.2s ease;" 
                   onmouseover="this.style.backgroundColor='#f8f9fa'" 
                   onmouseout="this.style.backgroundColor='white'">
              <input type="radio" name="question_${index}" value="${optIndex}" id="${optionId}" 
                     style="margin-right: 0.8rem; margin-top: 0.2rem;" 
                     onchange="updateQuestionFeedback(${index}, ${optIndex}, '${quiz.id}')">
              <span style="flex: 1;">${option}</span>
            </label>
          </div>
        `;
      });
      
      html += `
          </div>
          <div id="feedback_${index}" class="question-feedback" style="margin-top: 1rem; padding: 1rem; border-radius: 6px; display: none;">
            <!-- Feedback will be shown here when answer is selected -->
          </div>
        </div>
      `;
    });
    
    html += `
        <div style="text-align: center; margin-top: 2rem;">
          <button type="button" onclick="submitQuiz('${quiz.id}')" 
                  style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer; margin-right: 1rem;">
            üéØ Submit Quiz
          </button>
          <button type="button" onclick="clearQuizOutput()" 
                  style="background: #6c757d; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
            üìã Back to Dashboard
          </button>
        </div>
      </form>
      </div>
    `;
    
    quizOutput.innerHTML = html;
    
    // Scroll to quiz
    quizOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function updateQuestionFeedback(questionIndex, selectedOption, quizId) {
    console.log('üìä Showing feedback for question', questionIndex, 'option', selectedOption);
    
    // Get quiz data
    const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
    const quiz = quizHistory.find(q => q.id === quizId);
    
    if (!quiz || !quiz.questions[questionIndex]) {
      console.error('Quiz or question not found');
      return;
    }
    
    const question = quiz.questions[questionIndex];
    const feedbackDiv = document.getElementById(`feedback_${questionIndex}`);
    
    if (!feedbackDiv) {
      console.error('Feedback div not found');
      return;
    }
    
    const isCorrect = selectedOption === question.correct_answer;
    const correctOptionText = question.options[question.correct_answer];
    
    let feedbackHtml = `
      <div style="border-left: 4px solid ${isCorrect ? '#28a745' : '#dc3545'}; padding-left: 1rem;">
        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
          <span style="font-size: 1.2rem; margin-right: 0.5rem;">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
          <strong style="color: ${isCorrect ? '#28a745' : '#dc3545'};">
            ${isCorrect ? 'Correct!' : 'Incorrect'}
          </strong>
        </div>
    `;
    
    if (!isCorrect) {
      feedbackHtml += `
        <p style="margin: 0.5rem 0; color: #28a745;">
          <strong>Correct Answer:</strong> ${correctOptionText}
        </p>
      `;
    }
    
    if (question.explanation) {
      feedbackHtml += `
        <p style="margin: 0.5rem 0 0 0; color: #555;">
          <strong>Explanation:</strong> ${question.explanation}
        </p>
      `;
    }
    
    feedbackHtml += '</div>';
    
    feedbackDiv.innerHTML = feedbackHtml;
    feedbackDiv.style.display = 'block';
  }

  function submitQuiz(quizId) {
    console.log('üéØ Submitting quiz:', quizId);
    
    // Get quiz data
    const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
    const quizIndex = quizHistory.findIndex(q => q.id === quizId);
    
    if (quizIndex === -1) {
      alert('‚ùå Quiz not found');
      return;
    }
    
    const quiz = quizHistory[quizIndex];
    const form = document.getElementById(`quizForm-${quizId}`);
    
    if (!form) {
      alert('‚ùå Quiz form not found');
      return;
    }
    
    // Check if all questions are answered
    let allAnswered = true;
    let correctAnswers = 0;
    const answers = [];
    
    for (let i = 0; i < quiz.questions.length; i++) {
      const selectedOption = form.querySelector(`input[name="question_${i}"]:checked`);
      
      if (!selectedOption) {
        allAnswered = false;
        break;
      }
      
      const selectedValue = parseInt(selectedOption.value);
      answers.push(selectedValue);
      
      if (selectedValue === quiz.questions[i].correct_answer) {
        correctAnswers++;
      }
    }
    
    if (!allAnswered) {
      alert('‚ö†Ô∏è Please answer all questions before submitting the quiz.');
      return;
    }
    
    // Calculate score
    const score = Math.round((correctAnswers / quiz.questions.length) * 100);
    
    // Update quiz in storage
    quiz.completed = true;
    quiz.score = score;
    quiz.answers = answers;
    quiz.completed_at = new Date().toISOString();
    
    quizHistory[quizIndex] = quiz;
    localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
    
    // Show results
    const resultsHtml = `
      <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin: 2rem 0;">
        <h2 style="margin: 0 0 1rem 0;">üéâ Quiz Complete!</h2>
        <div style="font-size: 3rem; margin: 1rem 0;">${score >= 70 ? 'üèÜ' : score >= 50 ? 'üëè' : 'üìö'}</div>
        <h3 style="margin: 0.5rem 0; font-size: 2rem;">${score}%</h3>
        <p style="margin: 0.5rem 0; opacity: 0.9;">${correctAnswers} out of ${quiz.questions.length} correct</p>
        <p style="margin: 1rem 0 0 0; opacity: 0.8;">
          ${score >= 70 ? 'Excellent work! You have mastered this material.' : 
            score >= 50 ? 'Good job! Review the explanations to improve further.' : 
            'Keep studying! Review the lecture and try again.'}
        </p>
      </div>
      
      <div style="text-align: center; margin: 2rem 0;">
        <button onclick="refreshQuizzes(); clearQuizOutput();" 
                style="background: #28a745; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer; margin-right: 1rem;">
          üìã Back to Dashboard
        </button>
        <button onclick="retakeQuiz('${quizId}')" 
                style="background: #007bff; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
          üîÑ Retake Quiz
        </button>
      </div>
    `;
    
    const quizOutput = document.getElementById('quizOutput');
    if (quizOutput) {
      quizOutput.innerHTML = resultsHtml;
    }
    
    // Refresh quiz list to show completion
    refreshQuizzes();
    
    console.log('‚úÖ Quiz submitted successfully:', { score, correctAnswers, total: quiz.questions.length });
  }

  function retakeQuiz(quizId) {
    console.log('üîÑ Retaking quiz:', quizId);
    
    const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
    const quiz = quizHistory.find(q => q.id === quizId);
    
    if (!quiz) {
      alert('‚ùå Quiz not found');
      return;
    }
    
    // Reset quiz state
    quiz.completed = false;
    quiz.score = null;
    quiz.answers = null;
    quiz.completed_at = null;
    
    // Save updated quiz
    const quizIndex = quizHistory.findIndex(q => q.id === quizId);
    quizHistory[quizIndex] = quiz;
    localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
    
    // Display quiz again
    displayGeneratedQuiz(quiz);
  }

  function clearQuizOutput() {
    const quizOutput = document.getElementById('quizOutput');
    if (quizOutput) {
      quizOutput.innerHTML = '';
    }
  }

  function requestLectureVariation(lectureId) {
    console.log('Requesting variation for lecture:', lectureId);
    // TODO: Implement lecture variation
    alert('Lecture variation feature coming soon!');
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    if (!token) { alert('Not logged in.'); location.href='/school.html'; return; }
    
    // Safe title update with null check
    const trackTitleEl = document.getElementById('trackTitle');
    if (trackTitleEl) {
      trackTitleEl.innerText = `Cadet - ${track} Track`;
    }
    
    // Populate week selectors
    const weekSelect = document.getElementById('weekSelect');
    const quizWeek = document.getElementById('quizWeek');
    
    if (weekSelect) {
      // Clear existing options first
      weekSelect.innerHTML = '<option value="">Select Week</option>';
      for(let i=1; i<=14; i++){
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Week ${i}`;
        weekSelect.appendChild(option);
      }
      
      // Add event listener for week filtering
      weekSelect.addEventListener('change', function() {
        filterLecturesByWeek();
        updateProfessorLectureHistory();
      });
    }
    
    // Add event listener for professor selection
    const professorSelect = document.getElementById('professorSelect');
    if (professorSelect) {
      professorSelect.addEventListener('change', function() {
        updateProfessorLectureHistory();
      });
    }
    
    if (quizWeek) {
      // Clear existing options first  
      quizWeek.innerHTML = '<option value="">Select Week</option>';
      for(let i=1; i<=14; i++){
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Week ${i}`;
        quizWeek.appendChild(option);
      }
    }

    // Tab switching with content refresh
    const navs = document.querySelectorAll('.sidebar .nav-item');
    const panes = document.querySelectorAll('.tab-pane');
    
    // Global showTab function
    window.showTab = function(tabName) {
      panes.forEach(p => p.id === tabName ? p.classList.add('active') : p.classList.remove('active'));
      navs.forEach(n => n.dataset.tab === tabName ? n.classList.add('active') : n.classList.remove('active'));
      
      // Refresh content based on tab
      if (tabName === 'quizzes') {
        refreshQuizzes();
      } else if (tabName === 'lectures') {
        refreshLectures();
      } else if (tabName === 'dashboard') {
        refreshDashboardCounts();
      }
    };
    
    navs.forEach(n => n.addEventListener('click', () => {
      if (n.id==='logout') {
        if (confirm('Log out?')) localStorage.removeItem('authToken'), location.href='/school.html';
        return;
      }
      const tab = n.dataset.tab;
      showTab(tab);
    }));

    // Enhanced Lecture Agent System - Moved up to global scope
    class LectureAgent {
      constructor(name, expertise, persona) {
        this.name = name;
        this.expertise = expertise;
        this.persona = persona;
        // Create a proper ID that matches the lectureAgents keys
        this.lecture_id = this.createAgentId(name);
      }
      
      createAgentId(name) {
        // Map specific names to predefined IDs
        const nameMapping = {
          'Prof. Chen': 'prof-chen',
          'Dr. Wilson': 'dr-wilson', 
          'Dr. Smith': 'dr-smith',
          'Prof. Taylor': 'prof-taylor'
        };
        
        return nameMapping[name] || name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      }

      async deliver_lecture(context) {
        try {
          const prompt = `${this.persona}

Deliver a comprehensive lecture on: ${context.topic}
Duration: ${context.duration} minutes
Difficulty Level: ${context.difficulty_level}

Structure your lecture with:
1. Introduction and learning objectives
2. Main content with examples
3. Key takeaways
4. Discussion questions

Maintain your persona throughout and make it engaging.`;

          const response = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'llama3.2:latest',
              prompt: prompt,
              stream: false
            })
          });

          if (!response.ok) {
            throw new Error(`Ollama API error: ${response.status}`);
          }

          const result = await response.json();
          
          return {
            success: true,
            data: {
              topic: context.topic,
              duration: context.duration,
              difficulty: context.difficulty_level,
              lecturer: this.name,
              lecture_content: result.response,
              timestamp: new Date().toISOString()
            }
          };
        } catch (error) {
          console.error(`‚ùå ${this.name} lecture generation failed:`, error);
          return {
            success: false,
            error: error.message
          };
        }
      }
      
      // Add missing methods that the UI expects
      getUsageStats() {
        return {
          totalLectures: Math.floor(Math.random() * 50) + 10,
          avgRating: (4.2 + Math.random() * 0.6).toFixed(1),
          lastActive: new Date().toLocaleDateString(),
          usageCount: Math.floor(Math.random() * 100) + 20,
          lastUsed: new Date().toLocaleDateString(),
          totalInteractions: Math.floor(Math.random() * 100) + 20,
          averageResponseTime: (Math.random() * 2 + 1).toFixed(1) + 's',
          successRate: Math.floor(Math.random() * 10) + 90
        };
      }
      
      getStatus() {
        return 'online'; // or 'offline', 'busy'
      }
      
      getName() {
        return this.name;
      }
      
      getContext() {
        return this.currentContext || 'No context available';
      }
      
      setContext(context) {
        this.currentContext = context;
      }
      
      getSpecialization() {
        return this.expertise;
      }
      
      getPersona() {
        return this.persona;
      }
      
      async deliver_lecture(context) {
        try {
          const topic = context.topic || `Week ${context.week || 'Unknown'} Topics`;
          const duration = context.duration || 45;
          const difficulty = context.difficulty_level || 'Intermediate';
          
          // Simulate agent processing
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          return {
            success: true,
            content: `# ${topic}

*Delivered by ${this.getName()} - ${this.getSpecialization()}*

## Introduction

Welcome to today's lecture on ${topic}. As your ${this.getSpecialization().toLowerCase()}, I'll guide you through these essential concepts with practical examples from my experience.

## Learning Objectives

By the end of this ${duration}-minute session, you will:
- Understand the core concepts of ${topic}
- Apply practical techniques in real-world scenarios
- Develop problem-solving skills relevant to your track

## Main Content

${this.getPersona().includes('AI') ? 
  `This topic intersects beautifully with artificial intelligence and machine learning principles...` :
  this.getPersona().includes('Data') ?
  `From a data science perspective, ${topic} involves statistical analysis and pattern recognition...` :
  this.getPersona().includes('Systems') ?
  `In systems architecture, ${topic} relates to scalability, security, and performance optimization...` :
  `As a leadership expert, ${topic} connects to strategic thinking and team coordination...`
}

## Key Concepts

1. **Fundamental Principles**: Core concepts you need to master
2. **Best Practices**: Industry-standard approaches
3. **Common Pitfalls**: What to avoid based on real experience
4. **Advanced Techniques**: Next-level skills for ${difficulty} learners

## Practical Applications

Here are real-world scenarios where you'll apply these concepts:
- Industry case studies
- Hands-on exercises
- Project-based learning opportunities

## Summary and Next Steps

Today we covered the essential aspects of ${topic}. Your homework is to practice these concepts and prepare for our next session.

*This lecture was generated by ${this.getName()} using specialized knowledge in ${this.getSpecialization()}.*`,
            metadata: {
                topic: topic,
                duration: duration,
                difficulty: difficulty,
                lecturer: this.getName(),
                specialization: this.getSpecialization()
            }
          };
        } catch (error) {
          throw new Error(`Lecture delivery failed: ${error.message}`);
        }
      }
      
      reset() {
        // Reset any agent state if needed
        return this;
      }
    }

    const lectureAgents = {
      'dr-smith': new LectureAgent(
        'Dr. Smith',
        'AI & Machine Learning Expert',
        'You are Dr. Smith, an AI and Machine Learning expert with 15 years of experience. You explain complex concepts in simple terms and always provide practical examples. You are enthusiastic about emerging technologies and love to share real-world applications.'
      ),
      'prof-chen': new LectureAgent(
        'Prof. Chen',
        'Data Science Specialist',
        'You are Prof. Chen, a data science specialist with expertise in statistics, analytics, and data visualization. You have a methodical approach and love showing students how data tells stories. You emphasize practical applications and hands-on learning.'
      ),
      'dr-wilson': new LectureAgent(
        'Dr. Wilson',
        'Systems Architecture Expert',
        'You are Dr. Wilson, a systems architecture expert with deep knowledge of infrastructure, security, and scalable systems. You have a systematic approach and excel at explaining complex technical concepts. You emphasize best practices and real-world problem solving.'
      ),
      'prof-taylor': new LectureAgent(
        'Prof. Taylor',
        'Leadership & Strategy Expert',
        'You are Prof. Taylor, a leadership and strategy expert with experience in team management, project leadership, and organizational development. You focus on practical leadership skills, communication, and strategic thinking.'
      )
    };

    let currentAgent = lectureAgents['dr-smith'];

    // Agent selector functionality
    document.querySelectorAll('.agent-selector button').forEach(btn => {
      btn.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('.agent-selector button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Switch agent
        const agentKey = this.dataset.agent;
        currentAgent = lectureAgents[agentKey];
        updateAgentCard();
        updateContextDisplay();
        
        // Show agent switch message
        const lecturePane = document.getElementById('lectureContent');
        if (lecturePane.style.display === 'block') {
          lecturePane.innerHTML += `
            <div class="msg agent-action">
              <strong>üîÑ Agent Switched</strong><br>
              Now using ${currentAgent.getName()} for lecture generation
            </div>
          `;
          lecturePane.scrollTop = lecturePane.scrollHeight;
        }
      });
    });

    // Update agent card display
    function updateAgentCard() {
      const card = document.getElementById('currentAgentCard');
      const stats = currentAgent.getUsageStats();
      const initials = currentAgent.getName().split(' ').map(n => n[0]).join('');
      
      card.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="agent-avatar">${initials}</div>
          <div class="agent-info">
            <div class="agent-name">${currentAgent.getName()}</div>
            <div class="agent-specialization">${currentAgent.getSpecialization()}</div>
            <div class="agent-stats">
              <span>Used: <strong>${stats.usageCount}</strong> times</span>
              <span>Last Used: <strong>${stats.lastUsed}</strong></span>
              <span>Specialization: <strong>${currentAgent.getSpecialization()}</strong></span>
            </div>
          </div>
        </div>
      `;
    }

    // Update context display
    function updateContextDisplay() {
      const context = currentAgent.getContext();
      const summary = typeof context === 'string' ? context : 'No context available';
      document.getElementById('contextSummary').textContent = `Current Context: ${summary}`;
    }

    // Clear lecture chat
    document.getElementById('clearLectureChat').addEventListener('click', function() {
      if (confirm('Clear all lecture chat history?')) {
        document.getElementById('lectureContent').innerHTML = '';
        document.getElementById('lectureContent').style.display = 'none';
      }
    });

    // Professor lecture history management
    let professorLectureHistory = JSON.parse(localStorage.getItem('professorLectureHistory') || '{}');

    // Save lecture to professor's history
    function saveLectureToHistory(week, topic, agentName, content) {
      // Get the agent ID from the current agent
      const currentAgentButton = document.querySelector('.agent-selector button.active');
      const professorId = currentAgentButton ? currentAgentButton.dataset.agent : 'dr-smith';
      
      if (!professorLectureHistory[professorId]) {
        professorLectureHistory[professorId] = [];
      }
      
      const lectureId = `${professorId}-week${week}-${Date.now()}`;
      const historyItem = {
        id: lectureId,
        week: parseInt(week),
        topic: topic,
        agent: agentName,
        content: content,
        timestamp: new Date().toISOString(),
        rating: 0
      };
      
      // Add to beginning of array (most recent first)
      professorLectureHistory[professorId].unshift(historyItem);
      
      // Keep only last 20 lectures per professor
      professorLectureHistory[professorId] = professorLectureHistory[professorId].slice(0, 20);
      
      localStorage.setItem('professorLectureHistory', JSON.stringify(professorLectureHistory));
      updateProfessorLectureHistory();
      
      // Update dashboard counts
      refreshDashboardCounts();
    }

    // Refresh dashboard counts when data changes
    function refreshDashboardCounts() {
      const localLecturesCount = calculateLocalLecturesCount();
      const localQuizzesCount = calculateLocalQuizzesCount();
      const localModulesCompleted = Math.min(Math.floor(localLecturesCount / 2), 14); // 1 module per 2 lectures, max 14
      
      // Update count displays
      const lecturesEl = document.getElementById('lecturesCountDisplay');
      if (lecturesEl) {
        lecturesEl.innerText = localLecturesCount;
      }
      
      const modulesEl = document.getElementById('modulesCountDisplay');
      if (modulesEl) {
        modulesEl.innerText = localModulesCompleted;
      }
      
      const quizzesEl = document.getElementById('quizzesCountDisplay');
      if (quizzesEl) {
        quizzesEl.innerText = localQuizzesCount;
      }
      
      const completedEl = document.getElementById('completedCountDisplay');
      if (completedEl) {
        completedEl.innerText = localModulesCompleted + localQuizzesCount;
      }
      
      // Update gauges
      updateGauges(localLecturesCount, localModulesCompleted, localQuizzesCount, localModulesCompleted + localQuizzesCount);
    }

    // Calculate total quizzes from localStorage
    function calculateLocalQuizzesCount() {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      return quizHistory.length;
    }

    // Filter lectures by selected week
    function filterLecturesByWeek() {
      const selectedWeek = document.getElementById('weekSelect')?.value;
      const lecturesList = document.getElementById('lecturesList');
      
      if (!lecturesList) return;
      
      // Get all lecture items
      const lectureItems = lecturesList.querySelectorAll('.lecture-item');
      
      lectureItems.forEach(item => {
        if (!selectedWeek) {
          // No week selected, show all lectures
          item.parentElement.style.display = 'block';
        } else {
          // Check if this lecture matches the selected week
          const lectureWeek = item.getAttribute('data-week') || 
                             extractWeekFromText(item.textContent);
          
          if (lectureWeek && parseInt(lectureWeek) === parseInt(selectedWeek)) {
            item.parentElement.style.display = 'block';
          } else {
            item.parentElement.style.display = 'none';
          }
        }
      });
      
      // Update no-items message if needed
      const visibleItems = Array.from(lectureItems).filter(item => 
        item.parentElement.style.display !== 'none'
      );
      
      if (visibleItems.length === 0 && selectedWeek) {
        // Show filtered message
        const noItemsMessage = lecturesList.querySelector('.no-items');
        if (noItemsMessage) {
          noItemsMessage.textContent = `No lectures found for Week ${selectedWeek}`;
        } else {
          lecturesList.innerHTML = `<li class="no-items">No lectures found for Week ${selectedWeek}</li>`;
        }
      }
    }

    // Helper function to extract week number from lecture text
    function extractWeekFromText(text) {
      const weekMatch = text.match(/Week\s+(\d+)/i);
      return weekMatch ? weekMatch[1] : null;
    }

    // Update professor lecture history display
    function updateProfessorLectureHistory() {
      const historyContainer = document.getElementById('professorLectureHistory');
      const selectedProfessor = document.getElementById('professorSelect')?.value || '';
      const selectedWeek = document.getElementById('weekSelect')?.value || '';
      
      let allLectures = [];
      
      // Collect lectures from selected professor or all professors
      if (selectedProfessor && professorLectureHistory[selectedProfessor]) {
        allLectures = professorLectureHistory[selectedProfessor].map(lecture => ({
          ...lecture,
          professorId: selectedProfessor,
          professorName: getLectureProfessorName(selectedProfessor)
        }));
      } else {
        // Show all professors' lectures
        Object.keys(professorLectureHistory).forEach(professorId => {
          const professorLectures = professorLectureHistory[professorId].map(lecture => ({
            ...lecture,
            professorId: professorId,
            professorName: getLectureProfessorName(professorId)
          }));
          allLectures = allLectures.concat(professorLectures);
        });
      }
      
      // Filter by week if selected
      if (selectedWeek) {
        allLectures = allLectures.filter(lecture => lecture.week === parseInt(selectedWeek));
      }
      
      // Sort by timestamp (most recent first)
      allLectures.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      if (allLectures.length === 0) {
        historyContainer.innerHTML = `
          <div style="text-align: center; color: #64748b; font-style: italic;">
            ${selectedWeek ? `No lectures found for Week ${selectedWeek}` : 'No lectures generated yet'}
            ${selectedProfessor ? ` by ${getLectureProfessorName(selectedProfessor)}` : ''}
          </div>
        `;
        return;
      }
      
      historyContainer.innerHTML = allLectures.map(lecture => `
        <div class="history-item" data-id="${lecture.id}" data-professor="${lecture.professorId}" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: #f8fafc;">
          <div class="title" style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Week ${lecture.week}: ${lecture.topic}</div>
          <div class="meta" style="margin-bottom: 12px;">
            <span class="professor-tag" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.75rem; margin-right: 12px; font-weight: 500;">
              ${lecture.professorName}
            </span>
            <span class="date" style="color: #64748b; font-size: 0.85rem;">${new Date(lecture.timestamp).toLocaleDateString()}</span>
            <span class="time" style="color: #64748b; font-size: 0.85rem; margin-left: 8px;">${new Date(lecture.timestamp).toLocaleTimeString()}</span>
          </div>
          <div class="preview" style="color: #475569; font-size: 0.9rem; line-height: 1.4; margin-bottom: 12px;">${lecture.content.substring(0, 150)}...</div>
          <div class="actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button onclick="viewLectureHistory('${lecture.id}', '${lecture.professorId}')" class="action-btn" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500;">üëÄ View</button>
            <button onclick="generateQuizFromLecture('${lecture.id}', '${lecture.professorId}', this)" class="action-btn" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500;">üß† Quiz</button>
            <button onclick="downloadLectureFromHistory('${lecture.id}', '${lecture.professorId}')" class="action-btn" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500;">üì• Download</button>
            <button onclick="deleteLectureHistory('${lecture.id}', '${lecture.professorId}')" class="action-btn" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500;">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Helper function to get professor display name
    function getLectureProfessorName(professorId) {
      const names = {
        'dr-smith': 'Dr. Smith',
        'prof-chen': 'Prof. Chen', 
        'dr-wilson': 'Dr. Wilson',
        'prof-taylor': 'Prof. Taylor'
      };
      return names[professorId] || professorId;
    }

    // View lecture from history
    window.viewLectureHistory = function(lectureId, professorId) {
      const lectures = professorLectureHistory[professorId] || [];
      const lecture = lectures.find(l => l.id === lectureId);
      
      if (lecture) {
        const lecturePane = document.getElementById('lectureContent');
        lecturePane.style.display = 'block';
        lecturePane.innerHTML = `
          <div class="msg agent-action">
            <strong>üìñ Viewing from History</strong><br>
            Week ${lecture.week}: ${lecture.topic} (Generated by ${lecture.agent})
          </div>
          <div class="msg ai">
            ${lecture.content}
          </div>
        `;
        lecturePane.scrollTop = lecturePane.scrollHeight;
      }
    };

    // Generate quiz from specific lecture
    window.generateQuizFromLecture = async function(lectureId, professorId, buttonElement) {
      console.log('üß† Quiz generation started:', {lectureId, professorId});
      
      try {
        // Refresh the lecture history data to ensure we have the latest
        const professorLectureHistory = JSON.parse(localStorage.getItem('professorLectureHistory') || '{}');
        console.log('üìö Available professors:', Object.keys(professorLectureHistory));
        
        const lectures = professorLectureHistory[professorId] || [];
        console.log(`üìñ Lectures for ${professorId}:`, lectures.length);
        
        const lecture = lectures.find(l => l.id === lectureId);
        console.log('üéØ Found lecture:', lecture ? lecture.topic : 'NOT FOUND');
        
        if (!lecture) {
          console.error('‚ùå Lecture search failed:', {
            lectureId, 
            professorId, 
            availableLectures: lectures.map(l => ({id: l.id, topic: l.topic}))
          });
          alert('Lecture not found! Please refresh the page and try again.');
          return;
        }
        
        // Show loading state - try to find the button
        const button = buttonElement || event?.target || document.querySelector(`[onclick*="generateQuizFromLecture('${lectureId}', '${professorId}')"]`);
        let originalText = 'üß† Quiz';
        
        if (button) {
          originalText = button.textContent;
          button.textContent = '‚è≥ Generating...';
          button.disabled = true;
          console.log('üîò Button state updated');
        } else {
          console.warn('‚ö†Ô∏è Button not found for loading state');
        }
        
        console.log('üß† Generating quiz for lecture:', lecture.topic);
        
        // Generate quiz content based on lecture
        const quizContent = await generateQuizFromLectureContent(lecture);
        console.log('‚úÖ Quiz content generated, length:', quizContent.length);
        
        // Save quiz to history
        saveQuizToHistory(lecture.week, lecture.topic, lecture.agent, quizContent, lectureId);
        console.log('üíæ Quiz saved to history');
        
        // Show success and switch to quiz tab
        alert(`‚úÖ Quiz generated successfully for "${lecture.topic}"!`);
        
        // Switch to quiz tab to show the new quiz
        showTab('quizzes');
        refreshQuizzes();
        
        // Reset button
        if (button) {
          button.textContent = originalText;
          button.disabled = false;
          console.log('üîò Button state reset');
        }
        
        // Update dashboard counts
        refreshDashboardCounts();
        
      } catch (error) {
        console.error('‚ùå Error generating quiz:', error);
        alert(`Failed to generate quiz: ${error.message}`);
        
        // Reset button
        const button = buttonElement || event?.target || document.querySelector(`[onclick*="generateQuizFromLecture('${lectureId}', '${professorId}')"]`);
        if (button) {
          button.textContent = 'üß† Quiz';
          button.disabled = false;
        }
      }
    };

    // Generate quiz content from lecture content
    async function generateQuizFromLectureContent(lecture) {
      const agent = lectureAgents[Object.keys(lectureAgents).find(id => 
        lectureAgents[id].getName() === lecture.agent
      )] || lectureAgents['dr-smith'];
      
      const quizPrompt = `Based on this lecture content, create a comprehensive quiz with 5-10 multiple choice questions:

LECTURE: "${lecture.topic}" by ${lecture.agent}
CONTENT: ${lecture.content.substring(0, 2000)}...

Create questions that test:
1. Key concepts and definitions
2. Practical applications
3. Problem-solving scenarios
4. Critical thinking

Format each question as:
Q: [Question]
A) [Option A]
B) [Option B] 
C) [Option C]
D) [Option D]
Correct Answer: [Letter]
Explanation: [Why this is correct]

Make the quiz challenging but fair for Week ${lecture.week} level.`;

      try {
        // Try to use the agent's deliver_lecture method adapted for quiz generation
        const result = await agent.deliver_lecture({
          topic: `Quiz: ${lecture.topic}`,
          week: lecture.week,
          duration: 30,
          difficulty_level: 'Intermediate',
          content_type: 'quiz',
          source_content: quizPrompt
        });
        
        return result.content;
      } catch (error) {
        // Fallback to simple quiz generation
        return generateFallbackQuiz(lecture);
      }
    }

    // Fallback quiz generation
    function generateFallbackQuiz(lecture) {
      return `# Quiz: ${lecture.topic}
*Generated from Week ${lecture.week} lecture by ${lecture.agent}*

## Question 1
**What is the main focus of this week's topic on ${lecture.topic}?**
A) Basic introductory concepts
B) Advanced implementation techniques  
C) Historical background only
D) Future predictions

*Correct Answer: B*
*Explanation: The lecture focuses on practical implementation and application of concepts.*

## Question 2
**Which approach is most emphasized in ${lecture.agent}'s teaching style?**
A) Theoretical analysis only
B) Memorization of facts
C) Practical examples and real-world applications
D) Abstract mathematical proofs

*Correct Answer: C*
*Explanation: ${lecture.agent} emphasizes hands-on learning and practical applications.*

## Question 3
**For Week ${lecture.week} level students, what is the recommended next step after this lecture?**
A) Move to advanced topics immediately
B) Practice the concepts with exercises
C) Review previous weeks only
D) Skip to final projects

*Correct Answer: B*
*Explanation: Practicing concepts reinforces learning and builds proficiency.*

---
*This quiz was automatically generated from the lecture content to test comprehension and application of key concepts.*`;
    }

    // Save quiz to history
    function saveQuizToHistory(week, topic, lecturer, content, sourceLectureId) {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      
      const quizItem = {
        id: `quiz-${Date.now()}`,
        week: parseInt(week),
        topic: `Quiz: ${topic}`,
        lecturer: lecturer,
        content: content,
        sourceLectureId: sourceLectureId,
        timestamp: new Date().toISOString(),
        completed: false,
        score: null
      };
      
      quizHistory.unshift(quizItem);
      quizHistory.slice(0, 50); // Keep last 50 quizzes
      
      localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
    }

    // Delete lecture from history
    window.deleteLectureHistory = function(lectureId, professorId) {
      if (confirm('Delete this lecture from history?')) {
        if (professorLectureHistory[professorId]) {
          professorLectureHistory[professorId] = professorLectureHistory[professorId].filter(l => l.id !== lectureId);
          localStorage.setItem('professorLectureHistory', JSON.stringify(professorLectureHistory));
          updateProfessorLectureHistory();
          refreshDashboardCounts(); // Update dashboard counts after deletion
        }
      }
    };

    // Legacy function name for compatibility
    function updateLectureHistoryDisplay() {
      updateProfessorLectureHistory();
    }

    // Initialize displays
    updateAgentCard();
    updateProfessorLectureHistory();
    refreshDashboardCounts();
    
    // Initialize agents
    Object.values(lectureAgents).forEach(agent => {
      agent.reset();
    });

    function requestLectureVariation(week, title, currentAgent) {
      // Get different agent for variation
      const agents = Object.values(lectureAgents);
      const alternativeAgent = agents.find(agent => agent.name !== currentAgent) || agents[0];
      
      // Show variation generation message
      const lecturePane = document.getElementById('lectureContent');
      lecturePane.innerHTML += `
        <div class="msg variation" style="text-align:center; margin:8px 0; background:#fef3c7; padding:12px; border-radius:8px; border:1px solid #f59e0b;">
          <strong>üîÑ Generating Alternative Perspective</strong><br>
          <div style="font-size:0.9em; color:#92400e; margin-top:4px;">
            Switching to ${alternativeAgent.name} for a different approach...
          </div>
        </div>
      `;
      
      // Scroll to bottom
      lecturePane.scrollTop = lecturePane.scrollHeight;
      
      // Generate variation after short delay
      setTimeout(() => {
        document.getElementById('genLecture').click();
      }, 1000);
    }

    // Add CSS for spin animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);

    // Global functions for button clicks
    window.saveLectureToProgress = saveLectureToProgress;
    window.generateMatchingQuiz = generateMatchingQuiz;
    window.requestLectureVariation = requestLectureVariation;

    document.getElementById('refreshLectures').onclick = refreshLectures;
    
    // Refresh lectures function
    async function refreshLectures() {
      try {
        console.log('üîÑ Refreshing lectures list...');
        
        const lecturesList = document.getElementById('lecturesList');
        if (!lecturesList) return;
        
        // Try to get lectures from API first
        try {
          const response = await fetchAuth(`${API_ROOT}/api/lectures/${track}`);
          if (response.ok) {
            const lectures = await response.json();
            
            lecturesList.innerHTML = '';
            if (lectures.length === 0) {
              lecturesList.innerHTML = '<li class="no-items">No lectures available. Generate your first lecture!</li>';
            } else {
              lectures.forEach(lecture => {
                const li = document.createElement('li');
                li.innerHTML = `
                  <div class="lecture-item" data-id="${lecture.id}" data-week="${lecture.week}" style="padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; background: #f9f9f9;">
                    <strong>${lecture.topic || `Week ${lecture.week} Lecture`}</strong>
                    <br><small><strong>Professor:</strong> ${lecture.professor}</small>
                    <br><small><strong>Week:</strong> ${lecture.week} | <strong>Generated:</strong> ${new Date(lecture.created_at).toLocaleDateString()}</small>
                    <div style="margin-top: 10px;">
                      <button onclick="viewBackendLecture('${lecture.id}')" class="btn" style="margin-right: 10px; font-size: 0.9em;">üëÅÔ∏è View</button>
                      <button onclick="downloadBackendLecture('${lecture.id}')" class="btn" style="margin-right: 10px; font-size: 0.9em;">üì• Download</button>
                      <button onclick="generateMatchingQuiz('${lecture.id}')" class="btn" style="margin-right: 10px; font-size: 0.9em;">üìù Generate Quiz</button>
                    </div>
                  </div>
                `;
                lecturesList.appendChild(li);
              });
            }
            return;
          }
        } catch (apiError) {
          console.log('üì° API not available, using local storage...');
        }
        
        // Fallback to local storage
        const storedLectures = JSON.parse(localStorage.getItem('generatedLectures') || '[]');
        
        lecturesList.innerHTML = '';
        if (storedLectures.length === 0) {
          lecturesList.innerHTML = '<li class="no-items">No lectures generated yet. Click "Generate New Lecture" to create one!</li>';
        } else {
          storedLectures.forEach((lecture, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div class="lecture-item" data-id="${index}" data-week="${lecture.week}" style="padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; background: #f9f9f9;">
                <strong>Week ${lecture.week} - ${lecture.professor}</strong>
                <br><small>Generated: ${lecture.timestamp}</small>
                <br><em>${lecture.topic}</em>
                <div style="margin-top: 10px;">
                  <button onclick="showStoredLecture(${index})" class="btn" style="margin-right: 10px; font-size: 0.9em;">üëÅÔ∏è View</button>
                  <button onclick="generateMatchingQuiz('lecture-${lecture.week}')" class="btn" style="margin-right: 10px; font-size: 0.9em;">üìù Generate Quiz</button>
                </div>
              </div>
            `;
            lecturesList.appendChild(li);
          });
        }
        
        console.log('‚úÖ Lectures list refreshed');
        
      } catch (error) {
        console.error('‚ùå Error refreshing lectures:', error);
        const lecturesList = document.getElementById('lecturesList');
        if (lecturesList) {
          lecturesList.innerHTML = '<li class="error">Error loading lectures</li>';
        }
      }
    }
    
    // Function to show stored lecture
    window.showStoredLecture = function(index) {
      const storedLectures = JSON.parse(localStorage.getItem('generatedLectures') || '[]');
      const lecture = storedLectures[index];
      
      if (lecture) {
        const lectureContent = document.getElementById('lectureContent');
        lectureContent.innerHTML = lecture.content;
        lectureContent.style.display = 'block';
      }
    };
    
    // Add lecture generation functionality
    const genLectureBtn = document.getElementById('genLecture');
    if (genLectureBtn) {
      genLectureBtn.onclick = generateLecture;
    }
    
    document.getElementById('lecturesList').onclick = async e => {
      if (e.target.dataset.id) {
        const res = await fetchAuth(`${API_ROOT}/api/lectures/${e.target.dataset.id}`);
        const lec = await res.json();
        const c = document.getElementById('lectureContent');
        c.innerHTML = lec.content;
        c.style.display = 'block';
      }
    };

    // View lecture from backend
    window.viewBackendLecture = async function(lectureId) {
      try {
        console.log('üìñ Loading lecture:', lectureId);
        
        // Try to get from backend API
        const response = await fetch(`${API_ROOT}/api/lectures/${track}`);
        if (response.ok) {
          const lectures = await response.json();
          const lecture = lectures.find(l => l.id === lectureId);
          if (lecture) {
            const lectureContent = `
              <div class="lecture-generated">
                <h4>üìö ${lecture.topic}</h4>
                <div class="lecture-metadata">
                  <p><strong>Professor:</strong> ${lecture.professor}</p>
                  <p><strong>Week:</strong> ${lecture.week}</p>
                  <p><strong>Track:</strong> ${lecture.track}</p>
                  <p><strong>Generated:</strong> ${new Date(lecture.created_at).toLocaleDateString()}</p>
                </div>
                <div class="lecture-content-text">
                  ${lecture.content.replace(/\n/g, '<br>')}
                </div>
                <div class="lecture-actions" style="margin-top: 20px;">
                  <button onclick="downloadBackendLecture('${lectureId}')" class="btn">üì• Download</button>
                </div>
              </div>
            `;
            
            const lectureContentEl = document.getElementById('lectureContent');
            lectureContentEl.innerHTML = lectureContent;
            lectureContentEl.style.display = 'block';
            lectureContentEl.scrollTop = 0;
            return;
          }
        }
        
        alert('Lecture not found');
        
      } catch (error) {
        console.error('Error viewing lecture:', error);
        alert('Error loading lecture');
      }
    };
    
    // Download lecture from backend
    window.downloadBackendLecture = async function(lectureId) {
      try {
        console.log('üì• Downloading lecture:', lectureId);
        
        const response = await fetch(`${API_ROOT}/api/lectures/${lectureId}/download`);
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `lecture_${lectureId}.html`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          console.log('‚úÖ Lecture downloaded successfully');
        } else {
          throw new Error('Download failed');
        }
        
      } catch (error) {
        console.error('Error downloading lecture:', error);
        alert('Error downloading lecture. Please try again.');
      }
    };

    async function loadModule() {
      const lvl = parseInt(document.getElementById('weekSelect').value,10);
      const res = await fetchAuth(`${API_ROOT}/curriculum/generate`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({track,level:lvl})
      });
      const {html} = await res.json();
      
      // Safe element updates with null checks
      const moduleDetailsEl = document.getElementById('moduleDetails');
      if (moduleDetailsEl) {
        moduleDetailsEl.innerHTML = html;
      }
      
      const modulesCountEl = document.getElementById('modulesCountDisplay');
      if (modulesCountEl) {
        modulesCountEl.innerText = lvl;
      }
    }
    
    // Add null check for loadModule button
    const loadModuleBtn = document.getElementById('loadModule');
    if (loadModuleBtn) {
      loadModuleBtn.onclick = loadModule;
    }

    // Lecture Generation Function
    async function generateLecture() {
      try {
        const token = localStorage.getItem('authToken');
        const weekSelect = document.getElementById('weekSelect');
        const week = weekSelect.value;
        
        if (!week) {
          alert('Please select a week first');
          return;
        }
        
        // Get current agent
        const currentAgent = getCurrentAgent();
        
        // Show loading state
        const button = document.getElementById('genLecture');
        const originalText = button.textContent;
        button.textContent = 'Generating...';
        button.disabled = true;
        
        // Set agent loading state
        if (window.agentStatusManager) {
          agentStatusManager.setAgentLoading(currentAgent.lecture_id, true);
        }
        
        console.log(`üéì Generating lecture for Week ${week} with ${currentAgent.name}...`);
        
        // Call the agent's deliver_lecture function
        const lectureResult = await callAgentFunction(currentAgent.lecture_id, 'deliver_lecture', {
          topic: `Week ${week} - ${track} Topics`,
          duration: 45,
          difficulty_level: 'Intermediate'
        });
        
        if (lectureResult.success) {
          // Store lecture locally
          const storedLectures = JSON.parse(localStorage.getItem('generatedLectures') || '[]');
          const newLecture = {
            week: week,
            professor: currentAgent.name,
            topic: lectureResult.data.topic,
            content: `
              <div class="lecture-generated">
                <h4>üìö Week ${week} Lecture by ${currentAgent.name}</h4>
                <div class="lecture-metadata">
                  <p><strong>Topic:</strong> ${lectureResult.data.topic}</p>
                  <p><strong>Duration:</strong> ${lectureResult.data.duration} minutes</p>
                  <p><strong>Difficulty:</strong> ${lectureResult.data.difficulty}</p>
                  <p><strong>Generated by:</strong> ${lectureResult.data.lecturer}</p>
                </div>
                <div class="lecture-content-text">
                  ${lectureResult.data.lecture_content.replace(/\n/g, '<br>')}
                </div>
                <div class="lecture-actions" style="margin-top: 20px;">
                  <button onclick="downloadLecture('${week}', '${currentAgent.name}')" class="btn">üì• Download PDF</button>
                  <button onclick="generateMatchingQuiz('lecture-${week}')" class="btn">üìù Generate Quiz</button>
                  <button onclick="requestLectureVariation('${week}')" class="btn">üîÑ Generate Variation</button>
                </div>
              </div>
            `,
            timestamp: new Date().toLocaleDateString(),
            fullData: lectureResult.data
          };
          
          storedLectures.unshift(newLecture); // Add to beginning
          localStorage.setItem('generatedLectures', JSON.stringify(storedLectures.slice(0, 20))); // Keep last 20
          
          // Also save to backend
          try {
            const saveResponse = await fetch(`${API_ROOT}/api/lectures`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                track: track,
                week: week,
                professor: currentAgent.name,
                topic: lectureResult.data.topic,
                content: lectureResult.data.lecture_content,
                lecture_data: lectureResult.data,
                timestamp: new Date().toISOString(),
                user_id: 'current_user' // You can get this from token
              })
            });
            
            if (saveResponse.ok) {
              const saveResult = await saveResponse.json();
              console.log('‚úÖ Lecture saved to backend:', saveResult.lecture_id);
              newLecture.backend_id = saveResult.lecture_id; // Store backend ID
            } else {
              console.log('‚ö†Ô∏è Failed to save to backend, saved locally only');
            }
          } catch (saveError) {
            console.log('‚ö†Ô∏è Backend save failed, saved locally only:', saveError.message);
          }
          
          // Display the lecture content
          const lectureContent = document.getElementById('lectureContent');
          lectureContent.innerHTML = newLecture.content;
          lectureContent.style.display = 'block';
          
          // Update lectures list
          refreshLectures();
          
          console.log('‚úÖ Lecture generated successfully');
          
          // Store lecture content for quiz generation
          sessionStorage.setItem('lastLectureContent', lectureResult.data.lecture_content);
          sessionStorage.setItem('lastLectureWeek', week);
          
        } else {
          console.error('‚ùå Failed to generate lecture:', lectureResult.error);
          alert(`Failed to generate lecture: ${lectureResult.error}`);
        }
        
      } catch (error) {
        console.error('‚ùå Error generating lecture:', error);
        alert('Error generating lecture. Please try again.');
      } finally {
        // Reset button state
        const button = document.getElementById('genLecture');
        if (button) {
          button.textContent = 'Generate New Lecture'; // Use default text instead of undefined originalText
          button.disabled = false;
        }
        
        // Reset agent loading state
        if (window.agentStatusManager) {
          const currentAgent = getCurrentAgent();
          if (currentAgent) {
            agentStatusManager.setAgentLoading(currentAgent.lecture_id, false);
          }
        }
      }
    }
    
    // Helper function to get current active agent
    function getCurrentAgent() {
      const activeButton = document.querySelector('.agent-selector button.active');
      const agentId = activeButton ? activeButton.getAttribute('data-agent') : 'dr-smith';
      return lectureAgents[agentId] || lectureAgents['dr-smith'];
    }
    
    // Function to call agent function via API
    async function callAgentFunction(agentId, functionName, context) {
      try {
        // First try the API
        const response = await fetch(`${API_ROOT}/api/agents/execute`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({
            agent_id: agentId,
            function: functionName,
            context: context
          })
        });
        
        if (response.ok) {
          return await response.json();
        } else {
          console.log('üì° API call failed, using local agent fallback...');
          throw new Error('API unavailable');
        }
      } catch (error) {
        console.log('üì° Using local agent execution...');
        
        // Fallback to local agent execution
        const agent = lectureAgents[agentId];
        if (!agent) {
          throw new Error(`Agent ${agentId} not found locally`);
        }
        
        // Simulate the agent execution locally
        try {
          if (functionName === 'deliver_lecture') {
            // Call the agent's deliver_lecture method
            const result = await agent.deliver_lecture(context);
            
            return {
              success: result.success,
              data: {
                lecture_content: result.content,
                topic: result.metadata.topic,
                duration: result.metadata.duration,
                difficulty: result.metadata.difficulty,
                lecturer: result.metadata.lecturer,
                specialization: result.metadata.specialization
              },
              agent_id: agentId,
              function_used: functionName
            };
          } else {
            throw new Error(`Function ${functionName} not implemented locally`);
          }
        } catch (localError) {
          return {
            success: false,
            error: `Local execution failed: ${localError.message}`,
            agent_id: agentId,
            function_used: functionName
          };
        }
      }
    }
    
    // Download lecture as PDF
    async function downloadLecture(week, professorName) {
      try {
        const response = await fetchAuth(`${API_ROOT}/lectures/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ track, week: parseInt(week) })
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Lecture-Week${week}-${professorName}-${track}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          console.log('‚úÖ Lecture downloaded successfully');
        } else {
          throw new Error('Failed to generate PDF');
        }
      } catch (error) {
        console.error('‚ùå Error downloading lecture:', error);
        alert('Error downloading lecture PDF. Please try again.');
      }
    }

    // Calculate local quiz count
    function calculateLocalQuizzesCount() {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      return quizHistory.length;
    }

    // Quiz management functions
    window.takeQuiz = function(quizId) {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      const quiz = quizHistory.find(q => q.id === quizId);
      
      if (!quiz) {
        alert('Quiz not found!');
        return;
      }
      
      if (quiz.completed) {
        alert('You have already completed this quiz!');
        return;
      }
      
      // Simple quiz taking simulation
      const score = Math.floor(Math.random() * 40) + 60; // Random score 60-100
      
      // Mark as completed
      quiz.completed = true;
      quiz.score = score;
      quiz.completedAt = new Date().toISOString();
      
      // Save updated history
      localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
      
      alert(`üéâ Quiz completed! Your score: ${score}%`);
      refreshQuizzes();
      refreshDashboardCounts();
    };

    window.viewQuizContent = function(quizId) {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      const quiz = quizHistory.find(q => q.id === quizId);
      
      if (quiz) {
        // Create modal to display quiz content
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
          align-items: center; justify-content: center;
        `;
        modal.innerHTML = `
          <div style="background: white; padding: 30px; border-radius: 10px; max-width: 80%; max-height: 80%; overflow-y: auto; position: relative;">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2>${quiz.topic}</h2>
            <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
              <p><strong>Week:</strong> ${quiz.week} | <strong>Lecturer:</strong> ${quiz.lecturer}</p>
              <p><strong>Generated:</strong> ${new Date(quiz.timestamp).toLocaleString()}</p>
              ${quiz.completed ? `<p><strong>Score:</strong> ${quiz.score}%</p>` : ''}
            </div>
            <div style="white-space: pre-wrap; font-family: Arial, sans-serif; line-height: 1.6;">
              ${quiz.content}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
    };

    window.downloadQuiz = function(quizId) {
      const quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
      const quiz = quizHistory.find(q => q.id === quizId);
      
      if (quiz) {
        const content = `${quiz.topic}\n\nWeek: ${quiz.week}\nLecturer: ${quiz.lecturer}\nGenerated: ${new Date(quiz.timestamp).toLocaleString()}\n${quiz.completed ? `Score: ${quiz.score}%\n` : ''}\n\n${quiz.content}`;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${quiz.topic.replace(/[^a-zA-Z0-9]/g, '_')}_Week${quiz.week}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }
    };

    window.deleteQuiz = function(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        let quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
        quizHistory = quizHistory.filter(q => q.id !== quizId);
        localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
        refreshQuizzes();
        refreshDashboardCounts();
      }
    };
    
    // --- Enhanced Agentic Quiz Generation ---
    document.getElementById('genQuiz').onclick = async () => {
      const week = parseInt(document.getElementById('quizWeek').value, 10);
      const quizOutput = document.getElementById('quizOutput');
      const copyBtn = document.getElementById('copyQuiz');
      const topicTitle = weekTopics[week] || "Advanced Leadership Topics";
      
      // Get lecture content if available from session storage (generated from lecture)
      const lectureContent = sessionStorage.getItem('lectureContentForQuiz') || '';
      const lectureTitle = sessionStorage.getItem('lectureTitleForQuiz') || topicTitle;
      
      // Build cadet context
      const cadetContext = {
        level: cadetProgress.completionRate > 70 ? 'advanced' : cadetProgress.completionRate > 40 ? 'intermediate' : 'beginner',
        completedQuizzes: Object.keys(cadetProgress.quizzes),
        difficultyPreference: 'mixed',
        previousScores: Object.values(cadetProgress.quizzes).map(q => q.score).filter(s => s > 0)
      };
      
      // Show agentic system activation
      quizOutput.innerHTML = `
        <div style="background:#f8fafc; padding:20px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:16px;">
          <div style="text-align:center; margin-bottom:16px;">
            <div style="font-size:1.2em; font-weight:600; color:#0ea5e9; margin-bottom:8px;">
              üéØ Multi-Agent Quiz System Activated
            </div>
            <div style="font-size:0.9em; color:#64748b;">
              Week ${week}: ${lectureTitle}<br>
              Difficulty: ${cadetContext.level} ‚Ä¢ Questions: 20 ‚Ä¢ Time: 30 minutes
            </div>
          </div>
          
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px;">
            <div style="background:#f0f9ff; padding:12px; border-radius:8px; text-align:center;">
              <div style="font-size:1.1em; margin-bottom:4px;">üé≤</div>
              <div style="font-size:0.8em; font-weight:600; color:#0ea5e9;">Multiple Choice</div>
              <div style="font-size:0.7em; color:#64748b;">15 Questions</div>
            </div>
            <div style="background:#f0fdf4; padding:12px; border-radius:8px; text-align:center;">
              <div style="font-size:1.1em; margin-bottom:4px;">üé≠</div>
              <div style="font-size:0.8em; font-weight:600; color:#22c55e;">Scenarios</div>
              <div style="font-size:0.7em; color:#64748b;">3 Questions</div>
            </div>
            <div style="background:#fef3c7; padding:12px; border-radius:8px; text-align:center;">
              <div style="font-size:1.1em; margin-bottom:4px;">‚ö°</div>
              <div style="font-size:0.8em; font-weight:600; color:#f59e0b;">True/False</div>
              <div style="font-size:0.7em; color:#64748b;">2 Questions</div>
            </div>
          </div>
          
          <div style="text-align:center; color:#0ea5e9;">
            <div style="display:inline-block; animation:spin 1s linear infinite; font-size:1.5em;">ü§ñ</div>
            <div style="margin-top:8px; font-weight:600;">Agents are collaborating...</div>
            <div style="font-size:0.9em; color:#64748b; margin-top:4px;">
              Analyzing content ‚Ä¢ Designing questions ‚Ä¢ Calibrating difficulty
            </div>
          </div>
        </div>
      `;
      
      copyBtn.style.display = 'none';
      
      try {
        // Generate quiz using agentic system
        const quizResult = await generateAgenticQuiz(week, topicTitle, lectureContent, cadetContext);
        
        // Display comprehensive quiz with agent branding
        quizOutput.innerHTML = `
          <div style="background:#ffffff; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <!-- Quiz Header -->
            <div style="background:linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); color:white; padding:20px;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <h3 style="margin:0; font-size:1.3em;">Week ${week} Comprehensive Quiz</h3>
                  <div style="font-size:0.9em; opacity:0.9; margin-top:4px;">${topicTitle}</div>
                </div>
                <div style="text-align:right; font-size:0.8em;">
                  <div>‚è±Ô∏è ${quizResult.timeLimit} minutes</div>
                  <div>üéØ ${quizResult.passingScore}% to pass</div>
                </div>
              </div>
            </div>
            
            <!-- Quiz Content -->
            <div style="padding:20px;">
              <div style="background:#f8fafc; padding:16px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <div style="font-size:0.9em; color:#64748b; margin-bottom:8px;">
                  <strong>Generated by Multi-Agent System:</strong>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  ${quizResult.agents.map(agent => `
                    <span style="background:#0ea5e9; color:white; padding:4px 8px; border-radius:4px; font-size:0.7em;">
                      ${agent}
                    </span>
                  `).join('')}
                </div>
              </div>
              
              <div style="white-space: pre-wrap; line-height:1.6; font-family:'Segoe UI', sans-serif; font-size:1.05rem;">
                ${quizResult.content}
              </div>
            </div>
            
            <!-- Quiz Actions -->
            <div style="background:#f8fafc; padding:16px; border-top:1px solid #e2e8f0;">
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <button onclick="saveQuizToProgress(${week}, '${topicTitle.replace(/'/g, '\\\'')}', ${quizResult.questionCount})" 
                        class="btn" style="font-size:0.9em; padding:8px 16px; background:#22c55e;">
                  üíæ Save Quiz
                </button>
                <button onclick="copyQuizToClipboard()" 
                        class="btn" style="font-size:0.9em; padding:8px 16px; background:#3b82f6;">
                  üìã Copy to Clipboard
                </button>
                <button onclick="startAgenticQuizTimer(${week}, ${quizResult.timeLimit})" 
                        class="btn" style="font-size:0.9em; padding:8px 16px; background:#f59e0b;">
                  ‚è±Ô∏è Start Timed Quiz
                </button>
                <button onclick="generateQuizVariation(${week}, '${topicTitle.replace(/'/g, '\\\'')}', '${lectureContent.replace(/'/g, '\\\'')}', 'harder')" 
                        class="btn" style="font-size:0.9em; padding:8px 16px; background:#8b5cf6;">
                  üî• Harder Version
                </button>
              </div>
              
              <div style="margin-top:12px; font-size:0.85em; color:#64748b;">
                Generated by ${quizResult.agents.length} specialized agents ‚Ä¢ ${new Date().toLocaleString()} ‚Ä¢ 
                Difficulty: ${cadetContext.level} ‚Ä¢ Questions: ${quizResult.questionCount}
              </div>
            </div>
          </div>
        `;
        
        copyBtn.style.display = 'block';
        
      } catch (error) {
        quizOutput.innerHTML = `
          <div style="background:#fff3cd; border:1px solid #fbbf24; border-radius:8px; padding:16px; color:#92400e;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <span style="font-size:1.2em;">‚ö†Ô∏è</span>
              <strong>Multi-Agent System Error</strong>
            </div>
            <div style="margin-bottom:8px;">
              Failed to generate quiz: ${error.message}
            </div>
            <div style="font-size:0.9em;">
              The agent system encountered an issue. Please try again or contact support.
            </div>
          </div>
        `;
        copyBtn.style.display = 'none';
      }
    };

    // Enhanced quiz helper functions
    function saveQuizToProgress(week, title, questionCount) {
      const quizData = {
        week: week,
        title: title,
        questionCount: questionCount,
        completed: true,
        score: 0, // Will be updated when quiz is taken
        attempts: 1,
        timeSpent: 0,
        answers: [],
        agentGenerated: true,
        generatedBy: 'Multi-Agent System'
      };
      
      updateProgress('quizzes', 'week_' + week, quizData);
      
      // Show success message
      alert(`Multi-agent quiz for Week ${week} has been saved to your progress!`);
    }

    function startAgenticQuizTimer(week, timeLimit) {
      const startTime = Date.now();
      
      // Create enhanced timer display
      const timerDiv = document.createElement('div');
      timerDiv.id = 'agenticQuizTimer';
      timerDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        min-width: 180px;
      `;
      
      document.body.appendChild(timerDiv);
      
      // Update timer every second
      const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = (timeLimit * 60) - elapsed;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          timerDiv.remove();
          alert('‚è∞ Time\'s up! Quiz session ended.');
          
          // Update progress with time spent
          updateProgress('quizzes', 'week_' + week, {
            timeSpent: timeLimit,
            timedSession: true,
            completedAt: new Date().toISOString(),
            agentTimed: true
          });
          
          return;
        }
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        timerDiv.innerHTML = `
          <div style="text-align:center;">
            <div style="font-size:1.2em; margin-bottom:4px;">‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}</div>
            <div style="font-size:0.8em; opacity:0.8;">Agent Quiz Timer</div>
          </div>
        `;
        
        // Change color when time is running low
        if (remaining <= 300) { // 5 minutes
          timerDiv.style.background = 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)';
        } else if (remaining <= 600) { // 10 minutes
          timerDiv.style.background = 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)';
        }
      }, 1000);
      
      alert(`üöÄ Agent Quiz Timer Started! You have ${timeLimit} minutes to complete the quiz.`);
    }

    function generateQuizVariation(week, title, lectureContent, difficulty) {
      const quizOutput = document.getElementById('quizOutput');
      
      // Show variation generation
      quizOutput.innerHTML = `
        <div style="background:#fef3c7; padding:20px; border-radius:12px; border:1px solid #f59e0b; text-align:center;">
          <div style="font-size:1.2em; font-weight:600; color:#92400e; margin-bottom:8px;">
            üî• Generating ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Quiz Variation
          </div>
          <div style="font-size:0.9em; color:#92400e;">
            Adjusting difficulty level and question complexity...
          </div>
          <div style="margin-top:12px; color:#f59e0b;">
            <div style="display:inline-block; animation:spin 1s linear infinite; font-size:1.5em;">‚öôÔ∏è</div>
          </div>
        </div>
      `;
      
      // Generate variation after delay
      setTimeout(() => {
        document.getElementById('genQuiz').click();
      }, 1500);
    }

    // Global functions for quiz system
    window.saveQuizToProgress = saveQuizToProgress;
    window.startAgenticQuizTimer = startAgenticQuizTimer;
    window.generateQuizVariation = generateQuizVariation;

    // Copy quiz to clipboard
    document.getElementById('copyQuiz').onclick = async () => {
      const quizContent = document.querySelector('#quizOutput')?.textContent || '';
      try {
        await navigator.clipboard.writeText(quizContent);
        alert('Quiz copied to clipboard!');
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = quizContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Quiz copied to clipboard!');
      }
    };

    async function genQuiz() {
      // This function is replaced by the onclick handler above
      // Keeping for backward compatibility
      document.getElementById('genQuiz').click();
    }
    // Add null checks to prevent errors
    const refreshQuizzesBtn = document.getElementById('refreshQuizzes');
    const genQuizBtn = document.getElementById('genQuiz');
    
    if (refreshQuizzesBtn) {
      refreshQuizzesBtn.onclick = refreshQuizzes;
    }
    if (genQuizBtn) {
      genQuizBtn.onclick = genQuiz;
    }

    // Assignments & Progress
    async function loadOverview() {
      try {
        const res = await fetchAuth(`${API_ROOT}/cadet/overview`);
        const { assignments, modulesCompleted, quizzesPassed, lecturesCount } = await res.json();
        
        updateDashboardCounts(assignments, modulesCompleted, quizzesPassed, lecturesCount);
      } catch (error) {
        console.log('üì° API not available, using local data...');
        // Use local data when API is not available
        const localLecturesCount = calculateLocalLecturesCount();
        const localModulesCompleted = 8; // Placeholder - could be enhanced with real tracking
        const localQuizzesPassed = 5; // Placeholder - could be enhanced with real tracking
        const localAssignments = [
          { title: 'AI Fundamentals', status: 'Completed' },
          { title: 'Data Analysis Project', status: 'In Progress' },
          { title: 'System Design', status: 'Pending' }
        ];
        
        updateDashboardCounts(localAssignments, localModulesCompleted, localQuizzesPassed, localLecturesCount);
      }
    }

    // Calculate total lectures from professor history
    function calculateLocalLecturesCount() {
      const professorLectureHistory = JSON.parse(localStorage.getItem('professorLectureHistory') || '{}');
      let totalLectures = 0;
      
      Object.values(professorLectureHistory).forEach(professorLectures => {
        totalLectures += professorLectures.length;
      });
      
      return totalLectures;
    }

    // Update dashboard count displays
    function updateDashboardCounts(assignments, modulesCompleted, quizzesPassed, lecturesCount) {
      // Safe element updates with null checks
      const assignmentListEl = document.getElementById('assignmentList');
      if (assignmentListEl && assignments) {
        assignmentListEl.innerHTML = assignments.map(a=>`<li>${a.title} ‚Äì ${a.status}</li>`).join('');
      }
      
      const modulesEl = document.getElementById('modulesCountDisplay');
      if (modulesEl) {
        modulesEl.innerText = modulesCompleted;
      }
      
      const quizzesEl = document.getElementById('quizzesCountDisplay');
      if (quizzesEl) {
        quizzesEl.innerText = quizzesPassed;
      }
      
      const completedEl = document.getElementById('completedCountDisplay');
      if (completedEl) {
        completedEl.innerText = modulesCompleted + quizzesPassed;
      }
      
      const lecturesEl = document.getElementById('lecturesCountDisplay');
      if (lecturesEl) {
        lecturesEl.innerText = lecturesCount || 0;
      }
      
      updateGauges(lecturesCount||0, modulesCompleted, quizzesPassed, modulesCompleted+quizzesPassed);
    }

    // Update progress gauges
    function updateGauges(lectures, modules, quizzes, completed) {
      // Simple circular progress implementation
      const drawGauge = (canvasId, value, max = 100) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 45;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Background circle
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#e3f2fd';
        ctx.lineWidth = 8;
        ctx.stroke();
        
        // Progress circle
        const progress = Math.min(value / max,  1);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, -Math.PI / 2, (-Math.PI / 2) + (progress * 2 * Math.PI));
        ctx.strokeStyle = '#0a84ff';
        ctx.lineWidth = 8;
        ctx.stroke();
        
        // Text
        ctx.fillStyle = '#222';
        ctx.font = '16px Quicksand';
        ctx.textAlign = 'center';
        ctx.fillText(value, centerX, centerY + 5);
      };
      
      drawGauge('gaugeLectures', lectures, 20);
      drawGauge('gaugeModules', modules, 14);
      drawGauge('gaugeQuizzes', quizzes, 14);
      drawGauge('gaugeCompleted', completed, 28);
    }

    // Initial loads
    refreshLectures();
    refreshQuizzes();
    loadOverview();
    
    // ADD THIS LINE - Call checkEnrollment here
    checkEnrollment();
});
    // ENROLLMENT LOGIC
    const enrollmentModal = document.getElementById('enrollmentModal');
    const enrollmentForm = document.getElementById('enrollmentForm');
    const lockedSections = ['modules', 'quizzes', 'assignments', 'progress'];
    let isEnrolled = localStorage.getItem('isEnrolled') === 'true';

    function showEnrollmentModal() {
      enrollmentModal.style.display = 'block';
    }
    function hideEnrollmentModal() {
           enrollmentModal.style.display = 'none';
    }
    function lockSections() {
      lockedSections.forEach(sectionId => {
        const section = document.querySelector(`[data-tab="${sectionId}"]`);
        if (section) {
          section.classList.add('locked');
          section.onclick = (e) => {
            e.preventDefault();
            alert('Please complete your enrollment to access this section.');
            showEnrollmentModal();
          };
        }
      });
    }
    function unlockSections() {
      lockedSections.forEach(sectionId => {
        const section = document.querySelector(`[data-tab="${sectionId}"]`);
        if (section) {
          section.classList.remove('locked');
          section.onclick = null;
        }
      });
    }
    enrollmentForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const requiredFields = enrollmentForm.querySelectorAll('[required]');
      let isValid = true;
      requiredFields.forEach(field => {
        if (!field.value.trim() && field.type !== 'checkbox') {
          isValid = false;
          field.style.borderColor = 'red';
        } else {
          field.style.borderColor = '';
        }
      });
      if (!enrollmentForm.terms.checked) {
        isValid = false;
        alert('You must agree to the terms and conditions.');
        return;
      }
      if (!isValid) {
        alert('Please fill in all required fields.');
        return;
      }
      // Collect form data
      const enrollmentData = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        dob: document.getElementById('dob').value.trim(),
        gender: document.getElementById('gender').value,
        address: document.getElementById('address').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        zip: document.getElementById('zip').value.trim(),
        education: document.getElementById('education').value,
        employment: document.getElementById('employment').value,
        income: document.getElementById('income').value,
        agreedToTerms: enrollmentForm.terms.checked
      };
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_ROOT}/api/enrollment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(enrollmentData)
        });
        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Enrollment failed');
        }
        unlockSections();
        hideEnrollmentModal();
        alert('Enrollment successful! You now have access to all sections.');
      } catch (error) {
        alert('Error submitting enrollment: ' + error.message);
      }
    });
    function showEnrollmentPendingMsg() {
  document.getElementById('enrollmentPendingMsg').style.display = 'block';
  document.querySelector('.content').style.display = 'none';
}
function hideEnrollmentPendingMsg() {
  document.getElementById('enrollmentPendingMsg').style.display = 'none';
  document.querySelector('.content').style.display = '';
}

async function checkEnrollment() {
  // First check if agreement was already accepted
  const agreementAccepted = localStorage.getItem('agreementAccepted') === 'true';
  if (agreementAccepted) {
    // If agreement accepted, skip enrollment modal
    unlockSections();
    hideEnrollmentModal();
    hideEnrollmentPendingMsg();
    return;
  }

  const token = localStorage.getItem('authToken');
  if (!token) {
    showEnrollmentModal();
    lockSections();
    showEnrollmentPendingMsg();
    return;
  }
  try {
    const res = await fetch(`${API_ROOT}/api/enrollment/status`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    if (data.enrolled) {
      unlockSections();
      hideEnrollmentModal();
      hideEnrollmentPendingMsg();
    } else {
      showEnrollmentModal();
      lockSections();
      showEnrollmentPendingMsg();
    }
  } catch (error) {
    showEnrollmentModal();
    lockSections();
    showEnrollmentPendingMsg();
  }
}
    // Add functionality for the "Accept Challenge" button
    document.getElementById('acceptChallenge').addEventListener('click', () => {
      // Show the agreement modal
      document.getElementById('agreementModal').style.display = 'block';
      
      // Enable/disable accept button based on checkbox
      const agreementCheckbox = document.getElementById('agreementCheckbox');
      const acceptButton = document.getElementById('acceptAgreement');
      
      agreementCheckbox.addEventListener('change', () => {
        acceptButton.disabled = !agreementCheckbox.checked;
      });
      
      // Handle cancel button
      document.getElementById('cancelAgreement').addEventListener('click', () => {
        document.getElementById('agreementModal').style.display = 'none';
      });
      
      // Handle accept button
      acceptButton.addEventListener('click', () => {
        // Hide the agreement modal
        document.getElementById('agreementModal').style.display = 'none';
        
        // Trigger confetti using Canvas Confetti
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
        
        // Store agreement acceptance in localStorage
        localStorage.setItem('agreementAccepted', 'true');
        localStorage.setItem('agreementDate', new Date().toISOString());
        
        // Replace the section content
        const challengeSection = document.getElementById('cadetChallenge');
        challengeSection.innerHTML = `
          <h2>‚úÖ Challenge Accepted!</h2>
          <p>You will soon be assigned to a project team. Next step: schedule your kickoff meeting.</p>
          <p><small>Agreement accepted on ${new Date().toLocaleDateString()}</small></p>
        `;
      });
    });
    // Team details data
    const teamDetails = {
      ai: {
        title: "Team 1 ‚Äì AI & Data Science",
        description: `
          <ul>
            <li>Design and train machine learning models for real-world datasets.</li>
            <li>Build chatbots and conversational AI using Python and cloud APIs.</li>
            <li>Develop embeddings for search, recommendations, and NLP tasks.</li>
            <li>Prototype clinical intelligence tools for healthcare and diagnostics.</li>
          </ul>
          <h5>Progress Tracker</h5>
          <ol id="progress-ai">
            <li><input type="checkbox"> Complete dataset exploration</li>
            <li><input type="checkbox"> Build first chatbot prototype</li>
            <li><input type="checkbox"> Submit model evaluation report</li>
            <li><input type="checkbox"> Demo clinical tool to mentor</li>
          </ol>
        `
      },
      plm: {
        title: "Team 2 ‚Äì PLM / Lifecycle Management",
        description: `
          <ul>
            <li>Map out product lifecycle workflows for AI/ML projects.</li>
            <li>Automate CI/CD and MLOps pipelines using cloud tools.</li>
            <li>Document best practices for versioning and deployment.</li>
            <li>Collaborate with other teams to ensure smooth releases.</li>
          </ul>
          <h5>Progress Tracker</h5>
          <ol id="progress-plm">
            <li><input type="checkbox"> Diagram lifecycle workflow</li>
            <li><input type="checkbox"> Set up CI/CD pipeline</li>
            <li><input type="checkbox"> Write deployment checklist</li>
            <li><input type="checkbox"> Present workflow to cohort</li>
          </ol>
        `
      },
      python: {
        title: "Team 3 ‚Äì Python Software Development",
        description: `
          <ul>
            <li>Develop backend APIs for dashboards and automation tools.</li>
            <li>Write clean, well-documented Python code.</li>
            <li>Integrate with cloud services and databases.</li>
            <li>Support other teams with reusable modules.</li>
          </ul>
          <h5>Progress Tracker</h5>
          <ol id="progress-python">
            <li><input type="checkbox"> Scaffold API endpoints</li>
            <li><input type="checkbox"> Implement authentication</li>
            <li><input type="checkbox"> Connect to cloud database</li>
            <li><input type="checkbox"> Code review with mentor</li>
          </ol>
        `
      },
      bizdev: {
        title: "Team 4 ‚Äì Business Development & Strategy",
        description: `
          <ul>
            <li>Draft proposals and respond to RFPs for AI solutions.</li>
            <li>Research market opportunities and competitors.</li>
            <li>Develop documentation and pitch decks.</li>
            <li>Coordinate with technical teams for demos.</li>
          </ul>
          <h5>Progress Tracker</h5>
          <ol id="progress-bizdev">
            <li><input type="checkbox"> Complete market research</li>
            <li><input type="checkbox"> Draft proposal outline</li>
            <li><input type="checkbox"> Build pitch deck</li>
            <li><input type="checkbox"> Present to leadership</li>
          </ol>
        `
      }
    };

    // Make team tiles interactive
    document.querySelectorAll('.team-tile').forEach(tile => {
      tile.addEventListener('click', function() {
        const team = this.getAttribute('data-team');
        const detail = teamDetails[team];
        if (detail) {
          const section = document.getElementById('teamDetailSection');
          section.innerHTML = `
            <div style="background:#fff; border:1.5px solid #b3d8ff; border-radius:16px; box-shadow:0 2px 8px #e3f2fd; padding:2rem;">
              <h3 style="color:var(--accent2);margin-top:0;">${detail.title}</h3>
              ${detail.description}
              <button id="closeTeamDetail" class="btn" style="margin-top:1.5rem;">Close</button>
            </div>
          `;
          section.style.display = 'block';
          section.scrollIntoView({behavior:'smooth', block:'center'});
          document.getElementById('closeTeamDetail').onclick = () => {
            section.style.display = 'none';
          };
        }
      });
      // Keyboard accessibility
      tile.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.click();
        }
      });
      tile.addEventListener('mouseover', function() {
        this.style.boxShadow = '0 4px 16px #b3d8ff';
      });
      tile.addEventListener('mouseout', function() {
        this.style.boxShadow = '';
      });
    });

    // Email Delivery Logic - Updated for modal with agents
    document.getElementById('emailDeliveryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const sendText = document.getElementById('emailSendText');
      const spinner = document.getElementById('emailSpinner');
      
      // Disable form and show loading
      submitBtn.disabled = true;
      sendText.style.display = 'none';
      spinner.style.display = 'inline-block';

      // Get selected agents - handle both registered agents (ID) and local agents (key)
      const selectedAgentElements = Array.from(
        document.querySelectorAll('#agentCheckboxes input:checked')
      );
      
      const selectedAgents = [];
      const selectedAgentIds = [];
      
      selectedAgentElements.forEach(cb => {
        if (cb.dataset.local === 'true') {
          // Local agent - use the old format for backward compatibility
          const key = cb.value;
          const agent = lectureAgents[key];
          if (agent) {
            selectedAgents.push({
              key,
              name: agent.getName(),
              specialization: agent.getSpecialization(),
              persona: agent.getPersona()
            });
          }
        } else {
          // Registered agent - just collect the ID
          selectedAgentIds.push(cb.value);
        }
      });

      const emailData = {
        context: {
          content: document.getElementById('emailContent').value,
          agent_ids: selectedAgentIds,    // For registered agents
          agents: selectedAgents          // For local agents (backward compatibility)
        },
        destination: {
          email: document.getElementById('emailTo').value,
          subject: document.getElementById('emailSubject').value,
        },
      };

      try {
        const response = await fetch(`${API_ROOT}/api/agents/workflows/email`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify(emailData),
        });

        const result = await response.json();
        
        if (result.success) {
          // Combine both types of agents for display
          const totalAgents = [...selectedAgents, ...selectedAgentIds.map(id => ({id}))];
          
          // Add to email list
          addEmailToList({
            recipient: document.getElementById('emailTo').value,
            subject: document.getElementById('emailSubject').value,
            content: document.getElementById('emailContent').value,
            agents: selectedAgents, // For display purposes, use the detailed agent info
            agentCount: selectedAgentElements.length
          });
          
          const agentCountMsg = selectedAgentElements.length > 0 ? 
            ` with ${selectedAgentElements.length} AI agent(s) included` : '';
          alert(`Email sent successfully${agentCountMsg}!`);
          closeEmailModal();
        } else {
          alert(`Error sending email: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error sending email:', error);
        alert('Failed to send email.');
      } finally {
        // Re-enable form and hide loading
        submitBtn.disabled = false;
        spinner.style.display = 'none';
        sendText.style.display = 'inline';
      }
    });
  // Chat functionality
  let loadChatContacts; // Global reference to the function
  
  function initializeChat() {
    // Get token within function scope
    const token = localStorage.getItem('authToken');
    
    const chatContactsEl = document.getElementById('chatContacts');
    const chatHistoryEl  = document.getElementById('chatHistory');
    const chatInput      = document.getElementById('chatInput');
    const chatSendBtn    = document.getElementById('chatSendBtn');

    // Safety check - only initialize chat if elements exist
    if (!chatContactsEl || !chatHistoryEl || !chatInput || !chatSendBtn) {
      console.warn('Chat elements not found, skipping chat initialization');
      return;
    }

    let activeChatId = null;  // agent.id or user.id

    // 1) Load all agents + users as contacts
    loadChatContacts = async function() {
    try {
      const res = await fetch(`${API_ROOT}/api/agents/contacts`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const contacts = await res.json();
      
      if (!Array.isArray(contacts)) {
        throw new Error('Invalid response format');
      }
      
      if (contacts.length === 0) {
        chatContactsEl.innerHTML = `
          <div style="padding:8px; font-weight:600; color:#0a84ff; border-bottom:1px solid #e2e8f0;">
            Available Contacts
          </div>
          <div style="padding:16px; text-align:center; color:#666;">
            No contacts available yet.<br>
            <small>Agents will appear here once initialized.</small>
          </div>
        `;
        return;
      }
      
      chatContactsEl.innerHTML = `
        <div style="padding:8px; font-weight:600; color:#0a84ff; border-bottom:1px solid #e2e8f0;">
          Available Contacts
        </div>
      ` + contacts.map(c => `
        <div class="list-item" data-id="${c.id}" style="padding:8px; cursor:pointer; border-bottom:1px solid #e2e8f0;">
          ${c.icon || 'ü§ñ'} ${c.name}
          <div style="font-size:0.8em; color:#666;">${c.type === 'ai' ? 'AI Agent' : 'Human'}</div>
        </div>
      `).join('');

      // click handler
      chatContactsEl.querySelectorAll('.list-item').forEach(el => {
        el.addEventListener('click', async () => {
          activeChatId = el.dataset.id;
          // highlight
          chatContactsEl.querySelectorAll('.list-item').forEach(x => x.style.background = '');
          el.style.background = '#e2f0ff';
          
          // Enable chat input
          chatInput.disabled = false;
          chatSendBtn.disabled = false;
          chatInput.placeholder = `Type a message to ${el.textContent.trim()}...`;
          
          await loadChatHistory(activeChatId);
        });
      });
    } catch(e) {
      console.error("Failed to load contacts", e);
      chatContactsEl.innerHTML = `
        <div style="padding:8px; font-weight:600; color:#0a84ff; border-bottom:1px solid #e2e8f0;">
          Available Contacts
        </div>
        <div style="padding:16px; text-align:center; color:#dc3545;">
          <div>‚ö†Ô∏è Could not load contacts</div>
          <small style="color:#666;">Check your connection and try refreshing the page.</small>
        </div>
      `;
    }
  }

  // 2) Load history for a contact
  async function loadChatHistory(peer) {
    try {
      const res = await fetch(`${API_ROOT}/api/chat/inbox?peer=${peer}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const conv = await res.json();
      
      chatHistoryEl.innerHTML = conv.map(m => `
        <div style="margin:4px 0; text-align:${m.from === peer ? 'left' : 'right'};">
          <div class="msg ${m.from === peer ? 'ai' : 'user'}" style="display:inline-block; padding:6px 10px; border-radius:12px; 
                      background:${m.from === peer ? '#f0f0f0' : '#0a84ff'}; color:${m.from === peer ? '#000' : '#fff'}; max-width:70%;">
            ${m.text}
          </div>
        </div>
      `).join('');
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    } catch(e) {
      console.error("Failed to load history", e);
      chatHistoryEl.innerHTML = `<div style="padding:8px;color:#dc3545;">Could not load conversation</div>`;
    }
  }

  // 3) Send a new message
  chatSendBtn.addEventListener('click', async () => {
    const txt = chatInput.value.trim();
    if (!activeChatId || !txt) return;
    
    // Optimistically render user message
    chatHistoryEl.innerHTML += `
      <div style="margin:4px 0; text-align:right;">
        <div class="msg user" style="display:inline-block; padding:6px 10px; border-radius:12px; 
                    background:#0a84ff; color:#fff; max-width:70%;">${txt}</div>
      </div>
    `;
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    chatInput.value = '';

    try {
      await fetch(`${API_ROOT}/api/chat/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ to: activeChatId, text: txt })
      });
      // Reload to pick up AI response
      await loadChatHistory(activeChatId);
    } catch(e) {
      console.error("Failed to send", e);
      // Show error message
      chatHistoryEl.innerHTML += `
        <div style="margin:4px 0; text-align:left;">
          <div class="msg error" style="display:inline-block; padding:6px 10px; border-radius:12px; 
                      background:#dc3545; color:#fff; max-width:70%;">Failed to send message</div>
        </div>
      `;
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }
  });

  // Allow Enter key to send messages
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      chatSendBtn.click();
    }
  });
  
  // Load contacts after a short delay to allow agents to initialize
  setTimeout(loadChatContacts, 1000);
  } // End of initializeChat function

  // initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    // Initialize chat functionality
    initializeChat();
    
    // First initialize agents if needed
    try {
      await fetch(`${API_ROOT}/api/agents/initialize`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    } catch(e) {
      console.warn('Could not initialize agents:', e);
    }
    
    // Chat contacts will be loaded by initializeChat function
  });
  </script>

  <!-- Mind Panel Chat Widget -->
<div id="mindPanelChat" style="position:fixed;bottom:24px;right:24px;z-index:9999;">
  <button id="openMindPanelBtn" class="btn" style="border-radius:50%;width:56px;height:56px;background:linear-gradient(90deg,#0a84ff 60%,#ff4d4d 100%);color:#fff;font-size:1.6rem;box-shadow:0 4px 12px rgba(0,0,0,.18);border:none;outline:none;cursor:pointer;">
    üí¨
  </button>
  <div id="mindPanelWindow" style="display:none;width:370px;max-width:95vw;height:480px;box-shadow:0 8px 32px #0a84ff33;background:#fff;border-radius:18px;overflow:hidden;flex-direction:column;">
    <div style="background:linear-gradient(90deg,#0a84ff 60%,#ff4d4d 100%);color:#fff;font-weight:700;font-size:1.2rem;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;">
      <span><i class="fas fa-robot"></i> Mind Panel Advisor</span>
      <button id="closeMindPanelBtn" style="background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer;">&times;</button>
    </div>
    <div id="mindPanelMessages" style="flex:1;padding:16px 12px 8px 12px;overflow-y:auto;background:#f7fafc;font-size:1.05rem;display:flex;flex-direction:column;gap:8px;"></div>
    <div style="display:flex;padding:12px 10px;background:#f7fafc;border-top:1px solid #e3f2fd;gap:8px;">
      <input id="mindPanelInput" type="text" class="form-control" placeholder="Ask your advisor..." style="flex:1;border-radius:12px;border:1px solid #e3f2fd;padding:10px 14px;font-size:1.05rem;">
      <button id="mindPanelSendBtn" class="btn" style="border-radius:12px;background:linear-gradient(90deg,#0a84ff 60%,#ff4d4d 100%);color:#fff;font-weight:700;padding:0 18px;">Send</button>
    </div>
  </div>
</div>

<script>
// Mind Panel Chat Logic
(function(){
  // Get token from global scope
  const token = localStorage.getItem('authToken');
  const API_ROOT = window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1') || window.location.origin.includes('file:') 
    ? 'http://localhost:5000' 
    : 'https://api.alambda.com';
  
  const openBtn = document.getElementById('openMindPanelBtn');
  const closeBtn = document.getElementById('closeMindPanelBtn');
  const panelWin = document.getElementById('mindPanelWindow');
  const msgBox  = document.getElementById('mindPanelMessages');
  const input   = document.getElementById('mindPanelInput');
  const sendBtn = document.getElementById('mindPanelSendBtn');
  let currentTeam = null;

  // Show/hide chat
  openBtn.onclick = () => { panelWin.style.display='flex'; setTimeout(()=>input.focus(), 200); if(msgBox.childElementCount===0) mindPanelIntro(); };
  closeBtn.onclick = () => { panelWin.style.display = 'none'; };

  // Intro message
  function mindPanelIntro(teamName) {
    msgBox.innerHTML = `<div style="background:#fff0f0;color:#ff4d4d;padding:12px 16px;border-radius:12px;margin-bottom:6px;">
      <b>ü§ñ Mind Panel Advisor</b><br>
      Hi! I'm your AI advisor. Select a team or ask a question about your tasks.<br>
      ${teamName ? `<span style="color:#0a84ff;">You are viewing: <b>${teamName}</b></span>` : ''}
    </div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
  }

  // Send message to AI backend
  async function mindPanelSend(msg, team) {
    msgBox.innerHTML += `<div style="background:#0a84ff;color:#fff;padding:10px 14px;border-radius:12px;margin:4px 0 4px auto;max-width:80%;text-align:right;">${msg}</div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
    // Compose prompt for AI
    let prompt = msg;
    if (team) {
      prompt = `You are an expert advisor for "${teamDetails[team].title}". The user is working on this team's checklist. Guide them, answer questions, and offer step-by-step help. User says: "${msg}"`;
    }
    msgBox.innerHTML += `<div style="color:#aaa;padding:8px 0 0 8px;"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
    try {
      const res = await fetch(`${API_ROOT}/predict`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt, temperature: 0.7, max_tokens: 180 })
      });
      const d = await res.json();
      const aiReply = d.answer || d.response || d.result || d.message || d.text || 'Sorry, no response.';
      msgBox.lastChild.remove();
      msgBox.innerHTML += `<div style="background:#f4f8ff;color:#0a84ff;padding:10px 14px;border-radius:12px;margin:4px 0 4px 0;max-width:85%;text-align:left;">${aiReply}</div>`;
      msgBox.scrollTop = msgBox.scrollHeight;
    } catch {
      msgBox.lastChild.remove();
      msgBox.innerHTML += `<div style="color:#ff4d4d;">AI advisor unavailable.</div>`;
    }
  }

  // Send on button or Enter
  sendBtn.onclick = () => {
    const msg = input.value.trim();
    if (!msg) return;
    mindPanelSend(msg, currentTeam);
    input.value = '';
  };
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  // Listen for team tile clicks to set context
  document.querySelectorAll('.team-tile').forEach(tile => {
    tile.addEventListener('click', function() {
      currentTeam = this.getAttribute('data-team');
      panelWin.style.display = 'flex';
      mindPanelIntro(teamDetails[currentTeam].title);
      msgBox.innerHTML += `<div style="background:#f7fafc;color:#0a84ff;padding:10px 14px;border-radius:12px;margin:4px 0 4px 0;max-width:85%;text-align:left;">
        <b>You're now chatting with the advisor for:</b><br>${teamDetails[currentTeam].title}<br>
        <small>Ask for help with your checklist or any team topic!</small>
      </div>`;
      msgBox.scrollTop = msgBox.scrollHeight;
      input.focus();
    });
  });

  // Optional: If user closes and reopens, keep last team context
  // (If you want to reset, set currentTeam = null on closeBtn.onclick)
})();

   class LectureAgent {
      constructor(name, specialization, persona) {
        this.name = name;
        this.specialization = specialization;
        this.persona = persona;
        this.usageCount = 0;
        this.lastUsed = null;
      }
      
      async generateContent(week, topic, context = {}) {
        this.usageCount++;
        this.lastUsed = new Date();
        
        const prompt = this.buildPrompt(week, topic, context);
        return await this.callAI(prompt);
      }
      
      buildPrompt(week, topic, context) {
        return `${this.persona}\n\nTopic: ${topic}\nWeek: ${week}\n\nContext: ${JSON.stringify(context)}
        `;
      }

      async callAI(prompt) {
        const response = await fetch(`${API_ROOT}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, temperature: 0.7, max_tokens: 180 })
        });
        const data = await response.json();
        return data.answer || data.response || data.result || data.message || data.text || 'Sorry, no response.';
      }
      getUsageStats() {
        return {
          name: this.name,
          specialization: this.specialization,
          usageCount: this.usageCount,
          lastUsed: this.lastUsed ? this.lastUsed.toLocaleString() : 'Never'
        };
      }
      resetUsage() {
        this.usageCount = 0;
        this.lastUsed = null;
      }
      getContext() {
        return {
          week: this.week,
          topic: this.topic,
          context: this.context
        };
      }
      setContext(week, topic, context) {
        this.week = week;
        this.topic = topic;
        this.context = context;
      }
      getContextSummary() {
        return `Week: ${this.week}, Topic: ${this.topic}, Context: ${JSON.stringify(this.context)}`;
      }
      getPersona() {
        return this.persona;
      }
      getSpecialization() {
        return this.specialization;
      }
      getName() {
        return this.name;
      }
      getUsageCount() {
        return this.usageCount;
      }
      getLastUsed() {
        return this.lastUsed ? this.lastUsed.toLocaleString() : 'Never';
      }
      getStatus() {
        return `Agent: ${this.name} | Specialization: ${this.specialization} | Usage: ${this.usageCount} times | Last Used: ${this.getLastUsed()}`;
      }
      getFullInfo() {
        return `Name: ${this.name}\nSpecialization: ${this.specialization}\nUsage Count: ${this.usageCount}\nLast Used: ${this.getLastUsed()}\nPersona: ${this.persona}`;
      }
      getShortInfo() {
        return `${this.name} (${this.specialization}) - Used ${this.usageCount} times`;
      }
      getDetailedInfo() {
        return `Agent Name: ${this.name}\nSpecialization: ${this.specialization}\nUsage Count: ${this.usageCount}\nLast Used: ${this.getLastUsed()}\nPersona: ${this.persona}`;
      }
      getSummary() {
        return `Agent: ${this.name} | Specialization: ${this.specialization} | Usage: ${this.usageCount} times | Last Used: ${this.getLastUsed()}`;
      }
      getBrief() {
        return `${this.name} (${this.specialization}) - Used ${this.usageCount} times`;
      }
      reset() {
        this.usageCount = 0;
        this.lastUsed = null;
        this.week = null;
        this.topic = null;
        this.context = null;
      }
      getContext() {
        return {
          week: this.week,
          topic: this.topic,
          context: this.context
        };
      }
      
      // Enhanced methods for UI integration
      getInitials() {
        return this.name.split(' ').map(n => n[0]).join('');
      }
      
      getStatusBadge() {
        const color = this.usageCount > 5 ? '#22c55e' : this.usageCount > 2 ? '#f59e0b' : '#64748b';
        return `<span style="background: ${color}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em;">${this.usageCount} uses</span>`;
      }
      
      getPersonalizedGreeting() {
        const greetings = {
          'AI & Machine Learning Expert': 'Ready to dive into the fascinating world of AI!',
          'Data Science & Analytics': 'Let\'s explore the power of data together!',
          'Systems Architecture': 'Time to build some robust systems!',
          'Leadership & Strategy': 'Let\'s develop your leadership skills!'
        };
        return greetings[this.specialization] || 'Ready to learn something new!';
      }
    }

    // Email Modal Functions
    window.openEmailModal = async function() {
      document.getElementById('emailModal').style.display = 'block';
      await populateEmailAgents();
    };

    window.closeEmailModal = function() {
      document.getElementById('emailModal').style.display = 'none';
      // Clear form
      document.getElementById('emailDeliveryForm').reset();
      document.getElementById('agentCheckboxes').innerHTML = '';
    };

    // Populate agent checkboxes in email modal from backend
    async function populateEmailAgents() {
      const container = document.getElementById('agentCheckboxes');
      container.innerHTML = '<small style="color:#666;">Loading agents...</small>';
      
      try {
        // Fetch registered agents from backend
        const response = await fetch(`${API_ROOT}/contacts/list`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch agents');
        }
        
        const agents = await response.json();
        container.innerHTML = '';
        
        // Filter to only show agent-type contacts
        const agentContacts = agents.filter(a => a.type === 'agent');
        
        if (agentContacts.length === 0) {
          container.innerHTML = '<small style="color:#666;">No AI agents registered yet.</small>';
          return;
        }
        
        agentContacts.forEach(agent => {
          const id = `email-agent-${agent.id}`;
          const wrapper = document.createElement('label');
          wrapper.style = "display:flex;align-items:center;gap:6px;margin-right:1rem;cursor:pointer;padding:0.25rem 0.5rem;border-radius:4px;background:#fff;border:1px solid #ddd;margin-bottom:0.5rem;";
          wrapper.innerHTML = `
            <input type="checkbox" id="${id}" value="${agent.id}" style="margin:0;">
            <div style="flex:1;">
              <div style="font-weight:500;color:#333;font-size:0.9rem;">${agent.name}</div>
              <div style="font-size:0.8rem;color:#666;line-height:1.2;">${agent.bio ? agent.bio.substring(0, 100) + (agent.bio.length > 100 ? '...' : '') : 'AI Assistant'}</div>
            </div>
          `;
          container.appendChild(wrapper);
        });
        
      } catch (error) {
        console.error('Error fetching agents:', error);
        container.innerHTML = '<small style="color:#dc3545;">Error loading agents. Using local agents...</small>';
        
        // Fallback to local lectureAgents if backend fails
        populateLocalAgents();
      }
    }

    // Fallback function to use local lectureAgents
    function populateLocalAgents() {
      const container = document.getElementById('agentCheckboxes');
      container.innerHTML = '';
      
      Object.entries(lectureAgents).forEach(([key, agent]) => {
        const id = `email-agent-${key}`;
        const wrapper = document.createElement('label');
        wrapper.style = "display:flex;align-items:center;gap:6px;margin-right:1rem;cursor:pointer;padding:0.25rem 0.5rem;border-radius:4px;background:#fff;border:1px solid #ddd;margin-bottom:0.5rem;";
        wrapper.innerHTML = `
          <input type="checkbox" id="${id}" value="${key}" data-local="true" style="margin:0;">
          <div style="flex:1;">
            <div style="font-weight:500;color:#333;font-size:0.9rem;">${agent.getName()}</div>
            <div style="font-size:0.8rem;color:#666;line-height:1.2;">${agent.getSpecialization()}</div>
          </div>
        `;
        container.appendChild(wrapper);
      });
    }

    // Register all agents with the backend via contacts API
    async function registerAllAgents() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        console.log('‚ö†Ô∏è No auth token found, skipping agent registration');
        return;
      }
      
      try {
        console.log('Registering lecture agents with backend...');
        
        // Make sure lectureAgents is available
        if (typeof lectureAgents === 'undefined') {
          console.log('‚ö†Ô∏è lectureAgents not yet defined, skipping registration');
          return;
        }
        
        for (let [key, agent] of Object.entries(lectureAgents)) {
          try {
            const agentData = {
              name: agent.getName(),
              email: `${key}@agents.local`, // Provide a dummy email for agents
              bio: agent.getPersona(),
              type: 'agent',
              specialization: agent.getSpecialization()
            };
            
            const response = await fetch(`${API_ROOT}/contacts/create`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(agentData)
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log(`‚úÖ Agent registered: ${agent.getName()}`, result);
            } else if (response.status === 400) {
              // Agent might already exist, try to get more info
              const errorText = await response.text();
              console.log(`‚ö†Ô∏è Agent ${agent.getName()} registration failed (likely exists):`, errorText);
            } else {
              console.error(`‚ùå Failed to register ${agent.getName()}:`, response.status, response.statusText);
            }
          } catch (agentError) {
            console.error(`‚ùå Error registering individual agent ${agent.getName()}:`, agentError);
          }
        }
        
        console.log('All agents registration attempts completed');
      } catch (error) {
        console.error('‚ùå Error in registerAllAgents:', error);
      }
    }

    // Register agents on dashboard init with delay to ensure DOM is ready
    setTimeout(() => {
      registerAllAgents().catch(err => {
        console.error('‚ùå Failed to register agents:', err);
      });
    }, 1000);

    // Email Management Functions
    let emailData = JSON.parse(localStorage.getItem('emailData')) || [];

    // Email filtering functionality
    function initEmailFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active filter
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const filter = this.dataset.filter;
          filterEmails(filter);
        });
      });
    }

    function filterEmails(filter) {
      const emailItems = document.querySelectorAll('.email-item');
      let visibleCount = 0;
      
      emailItems.forEach(item => {
        let show = false;
        
        switch(filter) {
          case 'all':
            show = true;
            break;
          case 'sent':
            show = item.dataset.type === 'sent';
            break;
          case 'received':
            show = item.dataset.type === 'received';
            break;
          case 'with-agents':
            show = item.dataset.agents === 'true';
            break;
        }
        
        if (show) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show/hide empty state
      const emptyState = document.getElementById('emailEmptyState');
      if (visibleCount === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }
    }

    // Email action functions
    window.viewEmail = function(emailId) {
      // For now, just show an alert - could open a detailed view modal
      alert(`Viewing email ${emailId}. Full email viewer coming soon!`);
    };

    window.replyEmail = function(emailId) {
      // Open the compose modal with reply context
      openEmailModal();
      // Could pre-populate with "Re:" subject and quoted content
    };

    // Add new email to the list (called after successful send)
    function addEmailToList(emailInfo) {
      const emailList = document.getElementById('emailList');
      const newEmail = document.createElement('div');
      newEmail.className = 'email-item';
      newEmail.dataset.type = 'sent';
      
      const hasAgents = (emailInfo.agents && emailInfo.agents.length > 0) || emailInfo.agentCount > 0;
      if (hasAgents) {
        newEmail.dataset.agents = 'true';
      }
      
      const initials = emailInfo.recipient.split('@')[0].substring(0, 2).toUpperCase();
      
      // Create agent tags - handle both detailed agents and agent count
      let agentTags = '';
      if (emailInfo.agents && emailInfo.agents.length > 0) {
        agentTags = emailInfo.agents.map(agent => 
          `<span class="agent-tag">${agent.name || 'AI Agent'}</span>`
        ).join('');
      } else if (emailInfo.agentCount > 0) {
        agentTags = `<span class="agent-tag">${emailInfo.agentCount} AI Agent${emailInfo.agentCount > 1 ? 's' : ''}</span>`;
      }
      
      newEmail.innerHTML = `
        <div class="email-avatar">
          <div class="avatar-circle">${initials}</div>
        </div>
        <div class="email-content">
          <div class="email-header-info">
            <span class="email-recipient">${emailInfo.recipient}</span>
            <span class="email-date">${new Date().toLocaleDateString()}</span>
            <span class="email-status sent">Sent</span>
          </div>
          <div class="email-subject">${emailInfo.subject}</div>
          <div class="email-preview">${emailInfo.content.substring(0, 150)}...</div>
          ${agentTags ? `<div class="email-agents">${agentTags}</div>` : ''}
        </div>
        <div class="email-actions">
          <button class="action-btn" onclick="viewEmail('${Date.now()}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn" onclick="replyEmail('${Date.now()}')">
            <i class="fas fa-reply"></i>
          </button>
        </div>
      `;
      
      // Insert at the beginning of the list
      emailList.insertBefore(newEmail, emailList.firstChild);
      
      // Store in localStorage
      emailData.unshift({
        id: Date.now(),
        ...emailInfo,
        date: new Date().toISOString(),
        type: 'sent'
      });
      localStorage.setItem('emailData', JSON.stringify(emailData));
    }

    // Initialize email filters
    initEmailFilters();

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('emailModal');
      if (event.target === modal) {
        closeEmailModal();
      }
    });
   

    
    // Agent Status Management
    class AgentStatusManager {
        constructor() {
            this.agentStatuses = {
                'dr-smith': 'online',
                'prof-chen': 'online', 
                'dr-wilson': 'online',
                'prof-taylor': 'online'
            };
            this.loadingStates = {};
        }
        
        updateAgentStatus(agentId, status) {
            this.agentStatuses[agentId] = status;
            this.refreshStatusIndicators();
        }
        
        setAgentLoading(agentId, loading) {
            this.loadingStates[agentId] = loading;
            const button = document.querySelector(`[data-agent="${agentId}"]`);
            const loadingEl = button?.querySelector('.agent-loading');
            if (loadingEl) {
                loadingEl.classList.toggle('show', loading);
            }
        }
        
        refreshStatusIndicators() {
            Object.keys(this.agentStatuses).forEach(agentId => {
                const button = document.querySelector(`[data-agent="${agentId}"]`);
                const statusEl = button?.querySelector('.agent-status');
                if (statusEl) {
                    statusEl.className = `agent-status ${this.agentStatuses[agentId]}`;
                }
            });
        }
        
        initializeStatusIndicators() {
            document.querySelectorAll('[data-agent]').forEach(button => {
                const agentId = button.getAttribute('data-agent');
                
                // Add status indicator if not present
                if (!button.querySelector('.agent-status')) {
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `agent-status ${this.agentStatuses[agentId] || 'offline'}`;
                    button.insertBefore(statusSpan, button.firstChild);
                }
                
                // Add loading indicator if not present
                if (!button.querySelector('.agent-loading')) {
                    const loadingSpan = document.createElement('span');
                    loadingSpan.className = 'agent-loading';
                    button.appendChild(loadingSpan);
                }
                
                // Add transition class
                button.classList.add('agent-transition');
            });
        }
        
        simulateAgentActivity() {
            // Simulate periodic status changes for demo
            setInterval(() => {
                const agents = Object.keys(this.agentStatuses);
                const randomAgent = agents[Math.floor(Math.random() * agents.length)];
                const statuses = ['online', 'busy', 'offline'];
                const currentStatus = this.agentStatuses[randomAgent];
                const newStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                if (newStatus !== currentStatus) {
                    this.updateAgentStatus(randomAgent, newStatus);
                    console.log(`üîÑ ${randomAgent} status changed to ${newStatus}`);
                }
            }, 10000); // Update every 10 seconds
        }
    }
    
    // Initialize status manager
    const agentStatusManager = new AgentStatusManager();
    
    // Enhanced agent interaction with status updates
    function enhancedAgentInteraction() {
        // Initialize status indicators
        agentStatusManager.initializeStatusIndicators();
        
        // Start status simulation
        agentStatusManager.simulateAgentActivity();
        
        // Override agent selection to include loading states
        document.querySelectorAll('[data-agent]').forEach(button => {
            const originalHandler = button.onclick;
            button.onclick = function(e) {
                const agentId = this.getAttribute('data-agent');
                
                // Show loading state
                agentStatusManager.setAgentLoading(agentId, true);
                
                // Simulate processing time
                setTimeout(() => {
                    agentStatusManager.setAgentLoading(agentId, false);
                    agentStatusManager.updateAgentStatus(agentId, 'busy');
                    
                    // Call original handler if it exists
                    if (originalHandler) {
                        originalHandler.call(this, e);
                    }
                    
                    // Return to online after interaction
                    setTimeout(() => {
                        agentStatusManager.updateAgentStatus(agentId, 'online');
                    }, 3000);
                }, 1000);
            };
        });
    }
    
    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhancedAgentInteraction);
    } else {
        enhancedAgentInteraction();
    }
    
    // Global error handling for unhandled promises
    window.addEventListener('unhandledrejection', function(event) {
        console.error('üî¥ Unhandled promise rejection:', event.reason);
        
        // Check if it's a network error we can handle gracefully
        if (event.reason && event.reason.message && 
            (event.reason.message.includes('fetch') || 
             event.reason.message.includes('Failed to load'))) {
            console.log('üì° Network error detected, handling gracefully');
            // Prevent the default browser behavior
            event.preventDefault();
        }
    });
    
    // Global error handler for other JavaScript errors
    window.addEventListener('error', function(event) {
        console.error('üî¥ Global JavaScript error:', {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            error: event.error
        });
        
        // Don't prevent default behavior for debugging
        return false;
    });
    
</script>
  </body>
</html>
