<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anthesis CRM</title>
  <!-- Fonts & CSS -->
  <link
    href="https://fonts.googleapis.com/css?family=Quicksand:300,400,500,700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  
  <style>
    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      background: #f7fafc;
      color: #222;
    }
    
    body.modal-open {
      overflow: hidden !important;
    }
    header {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 1rem 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
    }
    header h1 {
      color: #ff4d4d;
      font-family: 'Quicksand', sans-serif;
      font-size: 2rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: 1px;
    }
    nav a {
      color: #0a84ff;
      margin: 0 1rem;
      font-weight: bold;
      text-decoration: none;
      font-size: 1.1rem;
      transition: color 0.2s;
    }
    nav a:hover, nav a.active {
      color: #ff4d4d;
      text-decoration: underline;
    }
    /* Tickers */
    .ticker {
      background: #e3f2fd;
      color: #0a84ff;
      padding: .5rem;
      text-align: center;
      font-weight: bold;
    }
    /* Layout */
    #content-wrapper {
      display: flex;
      height: calc(100vh - 2.5rem - 2.5rem);
      position: relative;
      z-index: 1;
    }
    #main-panel {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
      background: #fff;
      border-radius: 16px;
      margin: 1rem;
      box-shadow: 0 2px 8px rgba(10,132,255,0.07);
      transition: margin-right .3s ease;
    }
    #profile-panel {
      width: 320px;
      flex-shrink: 0;
      background: #f4fffd;
      border-left: 1px solid #e0e0e0;
      padding: 1.5rem 1rem;
      border-radius: 16px 0 0 16px;
      margin: 1rem 1rem 1rem 0;
      box-shadow: 0 2px 8px rgba(0,191,174,0.04);
      position: relative;
      transition: width .3s ease;
    }
    #content-wrapper.closed #profile-panel {
      width: 0;
      overflow: hidden;
    }
    #toggle-panel {
      position: absolute;
      top: 10px;
      left: -15px;
      width: 30px;
      height: 30px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 50%;
      color: #0a84ff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
      box-shadow: 0 2px 8px #e3f2fd;
    }
    /* Table & forms */
    .form-control,
    .table {
      background: #f7fafc;
      color: #222 !important;
    }
    .table th,
    .table td {
      border-color: #e0e0e0;
    }
    .section-title {
      color: #0a84ff;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
    }
    /* Chat bubbles */
    .bubble {
      max-width: 60%;
      padding: .75rem 1rem;
      margin: .5rem 0;
      border-radius: 1rem;
      white-space: pre-wrap;
      font-size: 1rem;
    }
    .bubble.user {
      background: #0a84ff;
      color: #fff;
      margin-left: auto;
    }
    .bubble.bot {
      background: #f4fffd;
      color: #0a84ff;
      margin-right: auto;
      border: 1px solid #e0e0e0;
    }
    /* Contact Fields */
    .contact-info {
      margin-top: 1rem;
    }
    .contact-field {
      margin-bottom: 1rem;
      color: #222;
    }
    .contact-field strong {
      color: #ff4d4d;
      margin-right: 0.5rem;
    }
    .contact-field span {
      color: #0a84ff;
    }
    /* Iframe overlay */
    #panel-container {
      display: none;
      position: absolute;
      top: 2.5rem;
      left: 0;
      right: 0;
      bottom: 2.5rem;
      background: #fff;
      z-index: 20;
      border-radius: 16px;
      box-shadow: 0 2px 8px #e3f2fd;
    }
    #panel-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #ff4d4d;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 21;
    }
    #panel-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0 0 16px 16px;
    }
    /* Footer */
    footer {
      height: 2.5rem;
      background: #fff;
      color: #0a84ff;
      text-align: center;
      line-height: 2.5rem;
      border-top: 1px solid #e0e0e0;
      font-weight: 500;
    }
    /* Auth */
    #login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10,132,255,0.07);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      width: 320px;
      text-align: center;
      box-shadow: 0 2px 8px #e3f2fd;
    }
    .auth-toggle {
      background: none;
      border: none;
      color: #0a84ff;
      text-decoration: underline;
      cursor: pointer;
      margin-top: .5rem;
      font-weight: 600;
    }
    /* Buttons in profile */
    .action-btn {
      width: 100%;
      margin-bottom: .5rem;
    }
    /* Modal overrides */
    .modal-content.bg-dark,
    .modal-content.text-light {
      background: #fff !important;
      color: #222 !important;
      border-radius: 16px;
      border: 1px solid #e0e0e0;
    }
    .modal-header {
      border-bottom: 1px solid #e0e0e0 !important;
    }
    .btn-close-white {
      filter: invert(0);
    }
    .list-group-item.bg-dark.text-light {
      background: #f7fafc !important;
      color: #222 !important;
    }
    /* Misc */
    .btn-primary, .btn-success, .btn-info, .btn-warning {
      border-radius: 8px;
      font-weight: 600;
    }
    .btn-primary { background: #0a84ff; border-color: #0a84ff; }
    .btn-success { background: #00bfae; border-color: #00bfae; }
    .btn-info    { background: #ff4d4d; border-color: #ff4d4d; }
    .btn-warning { background: #ffe066; border-color: #ffe066; color: #222; }
    .btn-outline-info { color: #ff4d4d; border-color: #ff4d4d; }
    .btn-outline-info:hover { background: #ff4d4d; color: #fff; }
    .btn-outline-success { color: #00bfae; border-color: #00bfae; }
    .btn-outline-success:hover { background: #00bfae; color: #fff; }

    /* Logout button styling */
    #logout-btn {
      display: none; /* Hidden by default, shown via JavaScript */
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    #logout-btn:hover {
      background-color: #c82333;
      border-color: #bd2130;
      color: white;
    }
    
    /* Agent Modal Responsive Styles */
    .modal-fullscreen-responsive {
      width: 100vw;
      height: 100vh;
      margin: 0;
      max-width: none;
      max-height: none;
    }
    
    .modal-fullscreen-responsive .modal-content {
      height: 100vh;
      border: none;
      border-radius: 0;
    }
    
    .modal-fullscreen-responsive .modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(100vh - 120px);
    }
    
    .modal-fullscreen-responsive .modal-header {
      flex-shrink: 0;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
    }
    
    /* Fix modal display and z-index issues */
    #agentModal {
      z-index: 1050 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background-color: rgba(0,0,0,0.5) !important;
    }
    
    #agentModal .modal-dialog {
      z-index: 1051 !important;
      position: relative !important;
      margin: 0 !important;
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
    }
    
    #agentModal.show {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    #agentModal .modal-content {
      background-color: #343a40 !important;
      color: #fff !important;
      width: 100% !important;
      height: 100% !important;
      border: none !important;
      border-radius: 0 !important;
      position: relative !important;
    }
    
    #agentModal .modal-backdrop {
      z-index: 1040 !important;
    }
    
    /* Force visibility for debugging */
    #agentModal .modal-header {
      background-color: #495057 !important;
      color: #fff !important;
      border-bottom: 1px solid #6c757d !important;
    }
    
    #agentModal .modal-body {
      background-color: #343a40 !important;
      color: #fff !important;
    }
    
    /* Mobile specific adjustments */
    @media (max-width: 768px) {
      .modal-fullscreen-responsive .modal-body {
        padding: 0.75rem;
        max-height: calc(100vh - 100px);
      }
      
      .modal-fullscreen-responsive .modal-header {
        padding: 0.75rem;
      }
      
      .modal-fullscreen-responsive .modal-header h5 {
        font-size: 1.1rem;
      }
      
      .tab-content {
        padding: 0.5rem 0;
      }
      
      .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
      }
      
      .form-control {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      
      .list-group-item {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
      
      .list-group-item p {
        font-size: 0.8rem;
      }
      
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }
    }
    
    /* Tablet adjustments */
    @media (min-width: 768px) and (max-width: 1024px) {
      .modal-fullscreen-responsive .modal-body {
        padding: 1rem;
        max-height: calc(100vh - 110px);
      }
      
      .tab-content {
        padding: 1rem 0;
      }
    }

    /* Ensure modal and backdrop are properly stacked */
    .modal-backdrop.show {
      z-index: 1098 !important;
    }

    .modal.show {
      z-index: 1099 !important;
    }

    /* Don't hide every modal backdrop! */
    /* .modal-backdrop { display: none !important; } */
    
    /* Email modal specific z-index tweaks */
    .modal-backdrop.show {
      z-index: 1098 !important;
    }
    #emailDeliveryModal.modal.show {
      z-index: 1099 !important;
    }
    
    /* Workflow Log Styles */
    .workflow-conversation-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .workflow-message {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      background: #343a40;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }
    
    .workflow-message.coordinator {
      border-left-color: #0a84ff;
    }
    
    .workflow-message.document-analysis {
      border-left-color: #ff4d4d;
    }
    
    .workflow-message.content-generation {
      border-left-color: #00bfae;
    }
    
    .agent-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
      flex-shrink: 0;
    }
    
    .workflow-message-content {
      flex: 1;
      min-width: 0;
    }
    
    .agent-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    
    .workflow-message-text {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #e9ecef;
    }
    
    .workflow-timestamp {
      font-size: 0.75rem;
      color: #adb5bd;
      margin-top: 0.25rem;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .workflow-message {
      animation: fadeInUp 0.4s ease-out forwards;
      opacity: 0;
    }
    
    .workflow-header {
      animation: fadeInUp 0.3s ease-out;
    }
    
    .workflow-completion {
      animation: fadeInUp 0.5s ease-out;
    }
    
    .workflow-step-indicator {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 0.5rem;
    }
    
    .step-initialization {
      background: #0a84ff;
      color: white;
    }
    
    .step-document-analysis {
      background: #ff4d4d;
      color: white;
    }
    
    .step-content-generation {
      background: #00bfae;
      color: white;
    }
    
    .step-handoff {
      background: #ffe066;
      color: #333;
    }
    
    .step-completion {
      background: #28a745;
      color: white;
    }
    
    .step-error {
      background: #dc3545;
      color: white;
    }
    
    /* Draft info styles */
    .workflow-draft-info {
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #2c3e50;
      border-left: 4px solid #3498db;
    }
    
    .workflow-draft-info h6 {
      color: #ecf0f1;
      margin-bottom: 0.5rem;
    }
    
    .workflow-draft-info p {
      color: #bdc3c7;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }
    
    .workflow-draft-info strong {
      color: #ecf0f1;
    }
    
    /* Draft actions styling */
    .draft-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    
    .draft-actions .btn {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }

    /* New Email Delivery Section */
    #emailDeliverySection {
      margin: 2rem auto;
      max-width: 600px;
    }
    
    #emailDeliverySection h3 {
      color: #0a84ff;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    #emailDeliverySection .form-group {
      margin-bottom: 1rem;
    }
    
    #emailDeliverySection label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    #emailDeliverySection input,
    #emailDeliverySection textarea {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #emailDeliverySection button {
      background: #0a84ff;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    #emailDeliverySection button:hover {
      background: #007acc;
    }

    /* Email Delivery Modal Specific Styles */
    #emailDeliveryModal {
      z-index: 1060 !important;
    }
    
    #emailDeliveryModal .modal-dialog {
      max-width: 600px;
    }
    
    #emailDeliveryModal .modal-content {
      background: #fff !important;
      color: #222 !important;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
    }
    
    #emailDeliveryModal .modal-header {
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      border-radius: 12px 12px 0 0;
    }
    
    #emailDeliveryModal .modal-title {
      color: #0a84ff;
      font-weight: 700;
    }
    
    #emailDeliveryModal .modal-body {
      padding: 2rem;
    }
    
    #emailDeliveryModal .form-group label {
      color: #222;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    #emailDeliveryModal .form-control {
      background: #fff;
      color: #222;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    #emailDeliveryModal .form-control:focus {
      border-color: #0a84ff;
      box-shadow: 0 0 0 0.2rem rgba(10, 132, 255, 0.25);
    }
    
    #emailDeliveryModal .btn-primary {
      background: #0a84ff;
      border-color: #0a84ff;
    }
    
    #emailDeliveryModal .btn-primary:hover {
      background: #007acc;
      border-color: #007acc;
    }
  </style>
</head>
<body>
  <!-- Header/Nav -->
  <header>
    <div class="header-container">
      <h1>Anthesis CRM</h1>
      <nav>
        <a href="/index.html" onclick="window.location=this.href;return false;">Home</a>
        <a href="/school.html" onclick="window.location=this.href;return false;">Training</a>
        <a href="/Crm.html" onclick="window.location=this.href;return false;">CRM</a>
        <a href="/privacy.html" onclick="window.location=this.href;return false;">Privacy Policy</a>
        <button id="logout-btn" class="btn btn-outline-danger btn-sm" style="margin-left:1rem;">Logout</button>
      </nav>
    </div>
  </header>

  <!-- LOGIN / REGISTER -->
  <div id="login-container">
    <div class="auth-box" id="login-box">
      <h2>Login</h2>
      <input id="login-username" class="form-control mb-3" placeholder="Username"/>
      <input id="login-password" type="password" class="form-control mb-3" placeholder="Password"/>
      <button id="login-btn" class="btn btn-primary w-100 mb-2">Login</button>
      <p id="login-error" class="text-danger"></p>
      <button class="auth-toggle" onclick="showRegister()">Don’t have an account? Register</button>
    </div>
    <div class="auth-box" id="register-box" style="display:none;">
      <h2>Register</h2>
      <input id="reg-username" class="form-control mb-3" placeholder="Username"/>
      <!-- NEW: Email field -->
      <input id="reg-email"    type="email" class="form-control mb-3" placeholder="Email"/>
      <input id="reg-password" type="password" class="form-control mb-3" placeholder="Password"/>
      <input id="reg-confirm"  type="password" class="form-control mb-3" placeholder="Confirm Password"/>
      <button id="register-btn" class="btn btn-success w-100 mb-2">Register</button>
      <p id="register-error" class="text-danger"></p>
      <button class="auth-toggle" onclick="showLogin()">Already have an account? Login</button>
    </div>
  </div>


  <!-- MAIN CONTENT -->
  <div id="main-content" style="display:none;">

    <div id="content-wrapper">
      <!-- Main Panel -->
      <div id="main-panel">
        <h3 class="section-title">CRM Contacts</h3>
        <table id="contactsTable" class="table table-bordered mb-4">
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Agency</th><th>Focus</th><th>Why Hot</th>
              <th>Score</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div>
          <h5 class="section-title">Discuss Data</h5>
          <div class="input-group mb-2">
            <input id="crmUserInput" class="form-control" placeholder="Ask about these contacts…"/>
            <div class="input-group-append">
              <button id="crmSendBtn" class="btn btn-primary">
                <span id="crmSendText">Send</span>
                <span id="crmSpinner" class="spinner-border spinner-border-sm text-light" style="display:none;"></span>
              </button>
            </div>
          </div>
          <div id="crmMessages" style="max-height:200px; overflow:auto;"></div>
        </div>
        <div class="mb-4">
          <h5>Upload Contacts (.csv)</h5>
          <input type="file" id="fileUpload" class="form-control"/>
          <small class="text-muted">Format: Name,Email,Agency,Focus,Why Hot</small>
        </div>
      </div>

      <!-- Profile Panel -->
      <div id="profile-panel">
        <button id="toggle-panel">
          <i id="toggle-icon" class="fa fa-chevron-left"></i>
        </button>
        <button id="profile-close" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ff4d4d; font-size: 1.5rem; cursor: pointer; z-index: 10;">&times;</button>
        <div class="section-title">Profile</div>
        <div class="contact-info">
          <div class="contact-field">
            <strong>Name:</strong>
            <span id="p-name">Loading...</span>
          </div>
          <div class="contact-field">
            <strong>Email:</strong>
            <span id="p-email">Loading...</span>
          </div>
          <div class="contact-field">
            <strong>Agency:</strong>
            <span id="p-agency">Loading...</span>
          </div>
          <div class="contact-field">
            <strong>Focus:</strong>
            <span id="p-focus">Loading...</span>
          </div>
          <div class="contact-field">
            <strong>Why Hot:</strong>
            <span id="p-why">Loading...</span>
          </div>
          <div class="contact-field">
            <strong>Bio:</strong>
            <span id="p-bio">Loading...</span>
          </div>
        </div>
        <div><strong>Analytics:</strong><ul id="p-analytics-list"></ul></div>
        <button id="btn-enrich"    class="btn btn-sm btn-info action-btn">Enrich Contact</button>
        <button id="btn-meeting"   class="btn btn-sm btn-primary action-btn">Schedule Meeting</button>
        <button id="btn-analytics" class="btn btn-sm btn-warning action-btn">Generate Analytics</button>
        <!--New Anthesis-->
        <button id="btn-agent" class="btn btn-sm btn-outline-info action-btn">Anthesis Agent</button>
        <!-- Debug button -->
        <button id="btn-debug-modal" class="btn btn-sm btn-outline-danger action-btn">Debug Modal</button>
      </div>
     
    </div>

    <!-- Iframe Overlay -->
    <div id="panel-container">
      <button id="panel-close">&times;</button>
      <iframe id="panel-iframe" sandbox="allow-scripts allow-same-origin allow-downloads allow-popups allow-forms allow-pointer-lock allow-top-navigation-by-user-activation" aria-hidden="false"></iframe>
    </div>


    <!-- Email Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1" aria-labelledby="templatesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="templatesModalLabel">Email Templates</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between mb-3">
          <button id="btn-new-template" class="btn btn-primary btn-sm">New Template</button>
          <button id="btn-use-template" class="btn btn-success btn-sm">Use Template</button>
        </div>
        <ul id="templates-list" class="list-group mb-3"></ul>
        <div id="template-form" style="display: none;">
          <input id="template-name" class="form-control mb-2" placeholder="Template Name" />
          <input id="template-subject" class="form-control mb-2" placeholder="Subject" />
          <textarea id="template-body" class="form-control mb-3" rows="5" placeholder="Template Body..."></textarea>
          <button id="template-save" class="btn btn-primary w-100">Save Template</button>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="analyticsModalLabel">Contact Analytics</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="analytics-content" class="p-3"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Draft Email Modal -->
<div class="modal fade" id="draftModal" tabindex="-1" role="dialog" aria-labelledby="draftModalLabel" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="draftModalLabel">Email Drafts</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="drafts-list" class="mb-3 ps-3"></ul>
        <div class="d-flex justify-content-between mb-3">
          <input id="draft-subject" class="form-control" placeholder="Subject" />
          <button id="btn-use-template" class="btn btn-primary btn-sm">Use Template</button>
        </div>
        <textarea id="draft-body" class="form-control mb-3" rows="5" placeholder="Email body..."></textarea>
        <button id="draft-save" class="btn btn-success w-100">Save Draft</button>
      </div>
    </div>
  </div>

    <!-- NEW: Agent Modal -->
<div class="modal fade" id="agentModal" tabindex="-1" role="dialog" aria-labelledby="agentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 95vw; height: 90vh;">
    <div class="modal-content bg-dark text-light" style="height: 100%;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="agentModalLabel">Anthesis Agent</h5>
        <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body bg-dark text-light" style="height: calc(100% - 120px); overflow-y: auto;">
        <!-- Tabs for Email Drafts, RFP Responses, and Workflow Logs -->
        <ul class="nav nav-tabs mb-3" id="agentTabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active text-light" id="email-tab" data-toggle="tab" href="#email-drafts" role="tab" aria-controls="email-drafts" aria-selected="true">Email Drafts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-light" id="rfp-tab" data-toggle="tab" href="#rfp-responses" role="tab" aria-controls="rfp-responses" aria-selected="false">RFP Responses</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-light" id="workflow-tab" data-toggle="tab" href="#workflow-logs" role="tab" aria-controls="workflow-logs" aria-selected="false">Workflow Logs</a>
          </li>
        </ul>
        <div class="tab-content">
          <!-- Email Drafts Tab -->
          <div class="tab-pane fade show active" id="email-drafts" role="tabpanel" aria-labelledby="email-tab">
            <div class="row">
              <div class="col-lg-6 col-12 mb-3">
                <h6 class="text-light">Generate Email Draft</h6>
                <div class="mb-3">
                  <input id="email-draft-subject" class="form-control bg-secondary text-light border-secondary mb-2" placeholder="Subject" />
                  <textarea id="email-draft-body" class="form-control bg-secondary text-light border-secondary mb-2" rows="3" placeholder="Custom message (optional)"></textarea>
                  <button id="generate-email-draft" class="btn btn-primary w-100">Generate Email Draft</button>
                </div>
              </div>
              <div class="col-lg-6 col-12">
                <h6 class="text-light">Saved Email Drafts</h6>
                <div style="max-height: 60vh; overflow-y: auto;">
                  <ul id="email-drafts-list" class="list-group"></ul>
                </div>
              </div>
            </div>
          </div>
          <!-- RFP Responses Tab -->
          <div class="tab-pane fade" id="rfp-responses" role="tabpanel" aria-labelledby="rfp-tab">
            <div class="row">
              <div class="col-lg-6 col-12 mb-3">
                <h6 class="text-light">Upload RFP & Generate Response</h6>
                <div class="mb-3">
                  <input type="file" id="agent-rfp-file-input" accept=".pdf,.docx,.txt" class="form-control-file bg-secondary text-light border-secondary mb-2" />
                  <div id="agent-rfp-upload-status" class="mb-2 text-light"></div>
                  <button id="agent-rfp-upload-btn" class="btn btn-primary w-100">Upload & Generate RFP Response</button>
                </div>
              </div>
              <div class="col-lg-6 col-12">
                <h6 class="text-light">Saved RFP Responses</h6>
                <div style="max-height: 60vh; overflow-y: auto;">
                  <ul id="rfp-responses-list" class="list-group"></ul>
                </div>
              </div>
            </div>
          </div>
          <!-- Workflow Logs Tab -->
          <div class="tab-pane fade" id="workflow-logs" role="tabpanel" aria-labelledby="workflow-tab">
            <div class="row">
              <div class="col-12">
                <h6 class="text-light">Agent Workflow Conversations</h6>
                <div id="workflow-log-container" style="max-height: 70vh; overflow-y: auto; background: #212529; border-radius: 8px; padding: 1rem;">
                  <div id="workflow-conversations" class="workflow-conversation-list">
                    <p class="text-muted">No workflow logs available. Generate content to see agent interactions.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Delivery Modal -->
  <div class="modal fade" id="emailDeliveryModal" tabindex="-1" aria-labelledby="emailDeliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="emailDeliveryModalLabel">Send Email</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="emailDeliveryForm">
            <div class="form-group mb-3">
              <label for="emailTo" class="form-label">Recipient Email</label>
              <input type="email" id="emailTo" name="emailTo" class="form-control bg-secondary text-light border-secondary" required readonly />
            </div>
            <div class="form-group mb-3">
              <label for="emailSubject" class="form-label">Subject</label>
              <input type="text" id="emailSubject" name="emailSubject" class="form-control bg-secondary text-light border-secondary" required />
            </div>
            <div class="form-group mb-3">
              <label for="emailContent" class="form-label">Content</label>
              <textarea id="emailContent" name="emailContent" class="form-control bg-secondary text-light border-secondary" rows="8" required></textarea>
            </div>
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">
                <span id="emailSendText">Send Email</span>
                <span id="emailSpinner" class="spinner-border spinner-border-sm" style="display:none;"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Email Delivery Section (replaced by modal) -->
  <div id="emailDeliverySection" style="display: none;">

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

<script>
  // Document ready handler
  $(document).ready(function() {
    console.log('Document ready, initializing modal...');
    
    // Ensure modal exists and is accessible
    if ($('#agentModal').length === 0) {
      console.error('Agent modal not found in DOM');
    } else {
      console.log('Agent modal found, setting up event handlers...');
      
      // Test modal functionality
      $('#agentModal').on('show.bs.modal', function (e) {
        console.log('Modal is about to show');
      });
      
      $('#agentModal').on('shown.bs.modal', function (e) {
        console.log('Modal has been shown');
      });
      
      $('#agentModal').on('hide.bs.modal', function (e) {
        console.log('Modal is about to hide');
      });
      
      $('#agentModal').on('hidden.bs.modal', function (e) {
        console.log('Modal has been hidden');
      });
    }
    
    // Initialize tab switching
    $('#agentTabs a').on('click', function (e) {
      e.preventDefault();
      console.log('Tab clicked:', $(this).attr('href'));
      
      // Remove active class from all tabs and content
      $('#agentTabs .nav-link').removeClass('active');
      $('.tab-pane').removeClass('show active');
      
      // Add active class to clicked tab
      $(this).addClass('active');
      
      // Show corresponding content
      const targetPane = $(this).attr('href');
      $(targetPane).addClass('show active');
    });
  });

  // Globals
  let contacts = [];
  let currentIdx = null;

  // Server health check
  fetch('https://api.alambda.com/health')
    .then(res => res.json())
    .then(data => console.log('Server Health:', data.status));

  // Footer year
  $('#year').text(new Date().getFullYear());

  // Auth toggles
  function showRegister() { $('#login-box').hide(); $('#register-box').show(); }
  function showLogin()    { $('#register-box').hide(); $('#login-box').show(); }

  // Initialize templates
  async function loadTemplates() {
    try {
      const response = await fetch('https://api.alambda.com/email-templates', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      const templates = await response.json();
      $('#templates-list').empty();
      templates.forEach(template => {
        $(`<li class="list-group-item bg-dark text-light">
          <div class="d-flex justify-content-between align-items-center">
            <span>${template.name}</span>
            <small class="text-muted">${new Date(template.created_at).toLocaleDateString()}</small>
          </div>
        </li>`).appendTo('#templates-list');
      });
    } catch (error) {
      console.error('Error loading templates:', error);
    }
  }

  // Register
  $('#register-btn').click(async () => {
    const u = $('#reg-username').val().trim();
    const e = $('#reg-email').val().trim();
    const p = $('#reg-password').val();
    const c = $('#reg-confirm').val();
    const err = $('#register-error').text('');

    if (!u || !e || !p) return err.text('Username, email, and password are required.');
    if (p !== c) return err.text('Passwords must match.');

    try {
        const res = await fetch('https://api.alambda.com/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        body: JSON.stringify({ username: u, email: e, password: p })
      });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Registration failed');
        const token = data.token;
        if (token) {
          localStorage.setItem('token', token);
          // Validate token immediately
          const validateRes = await fetch('https://api.alambda.com/health', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (validateRes.ok) {
            $('#login-container').hide();
            $('#main-content').show();
            $('#logout-btn').show();
            initCRM();
          } else {
            throw new Error('Token validation failed');
          }
        } else {
          throw new Error('No token received');
        }
    } catch (error) {
      console.error('Registration error:', error);
      err.text(error.message);
    }
  });

  // Login
  $('#login-btn').click(async () => {
    const u = $('#login-username').val().trim();
    const p = $('#login-password').val();
    const err = $('#login-error').text('');

    if (!u || !p) return err.text('Required.');

    try {
      const res = await fetch('https://api.alambda.com/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Login failed');
      localStorage.setItem('token', data.token);
      $('#login-container').hide();
      $('#main-content').show();
      $('#logout-btn').show();
      initCRM();
    } catch (error) {
      console.error('Login error:', error);
      err.text(error.message);
    }
  });

  // Auto-login with token validation
  $(async function () {
    // Initially hide logout button
    $('#logout-btn').hide();
    
    const token = localStorage.getItem('token');
    if (token) {
      // Validate the token before proceeding
      const isValid = await validateToken();
      if (isValid) {
        $('#login-container').hide();
        $('#main-content').show();
        $('#logout-btn').show();
        initCRM();
      } else {
        // Token is invalid, show login
        performLogout();
      }
    } else {
      // No token, ensure logout button is hidden
      $('#logout-btn').hide();
    }
  });

  // Chat LLM call
  async function fetchPredict(prompt) {
    try {
      const res = await fetch('https://api.alambda.com/predict', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Prediction failed');
      console.log('Predict response:', data); // Debug log
      return data.answer || data.response || data.result || data.message || data.text || '';
    } catch (error) {
      console.error('Prediction error:', error);
      throw error;
    }
  }

  // Ticker updates
  function updateCrypto() { $('#crypto-ticker').text('BTC $62k • ETH $3.1k'); }
  function updateStock()  { $('#stock-ticker').text('AAPL $170 • MSFT $400'); }
  setInterval(updateCrypto, 15000); updateCrypto();
  setInterval(updateStock, 30000); updateStock();

  // Panel overlay toggle
  function openPanel(url) {
    const iframe = $('#panel-iframe');
    iframe.attr('src', ''); // Clear previous content
    iframe.attr('src', url); // Set new URL
    $('#panel-container').fadeIn(200);

    // Handle iframe load errors
    iframe.on('error', () => {
      console.error('Error loading iframe content');
      $('#panel-container').fadeOut(200);
    });
  }
  $('#panel-close').click(() => {
    $('#panel-container').fadeOut(200, () => $('#panel-iframe').attr('src', ''));
  });

    // Token validation function
  async function validateToken() {
    const token = localStorage.getItem('token');
    if (!token) {
      return false;
    }

    try {
      const response = await fetch('https://api.alambda.com/health', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.status === 401) {
        console.warn('Token is invalid or expired');
        localStorage.removeItem('token');
        return false;
      }
      
      return response.ok;
    } catch (error) {
      console.error('Token validation failed:', error);
      return false;
    }
  }

  // Enhanced logout function with better cleanup
  function performLogout() {
    localStorage.removeItem('token');
    $('#logout-btn').hide();
    $('#login-container').show();
    $('#main-content').hide();
    
    // Clear any cached data
    $('#login-username').val('');
    $('#login-password').val('');
    $('#login-error').text('');
    $('#register-error').text('');
    
    // Clear profile panel
    $('#profile-panel').hide();
    currentIdx = null;
    
    console.log('Logged out successfully');
  }

  // Authentication wrapper for API calls
  async function authenticatedFetch(url, options = {}) {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('No authentication token available');
    }

    const defaultOptions = {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...options.headers
      }
    };

    const response = await fetch(url, { ...options, headers: defaultOptions.headers });
    
    if (response.status === 401) {
      console.warn('Authentication failed, logging out...');
      performLogout();
      throw new Error('Authentication failed. Please log in again.');
    }
    
    return response;
  }

  // Main CRM init
    function initCRM() {
      const token = localStorage.getItem('token');
      if (!token) {
        $('#login-container').show();
        $('#main-content').hide();
        $('#logout-btn').hide();
        return;
      }
      
      // Show logout button when logged in
      $('#logout-btn').show();

      // Initialize agent system
      initializeAgents().then(result => {
        if (result && result.success) {
          console.log('Agents initialized successfully');
        } else {
          console.warn('Agent initialization failed, but continuing...');
        }
      });

      // Fetch user profile
      fetch('https://api.alambda.com/profile', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(profile => {
        if (profile.error) {
          console.error('Profile error:', profile.error);
          return;
        }
        
        $('#p-bio').text(profile.bio || 'No bio available');
        $('#p-name').text(profile.name || 'Anonymous');
        $('#p-email').text(profile.email || 'No email available');
      })
      .catch(error => {
        console.error('Error fetching profile:', error);
        $('#p-bio').text('Error loading profile');
        $('#p-name').text('Error loading profile');
        $('#p-email').text('Error loading profile');
      });

      contacts = [
        ["Kenyata Wesley", "kenyata.wesley@acf.hhs.gov", "HHS (ACF)", "Health modernization", "Senior-level buyer"],
        ["Kimberly Nash", "kimberly.nash@hq.doe.gov", "DOE", "Smart Grid AI", "DOE AI leader"],
        ["Isaac V. Roper Charles", "isaac.ropercharles@sba.gov", "SBA", "Veteran services", "VA contracts gateway"],
        ["Pamela Barker", "pamela.barker@nih.gov", "NIH", "Biomedical R&D", "Medtech influencer"],
        ["Richard Allen", "richard.allen@cisa.dhs.gov", "CISA", "Cyber Defense", "Major cyber buyer"],
        ["Amber Pierce", "amber.pierce@dhs.gov", "DHS", "Biometrics AI", "Security tech focus"]
      ];
      loadContacts(contacts);

    // Logout handler
    $('#logout-btn').click(async () => {
      try {
        const token = localStorage.getItem('token');
        
        // Always clear token and show login, regardless of server response
        localStorage.removeItem('token');
        $('#logout-btn').hide();
        $('#login-container').show();
        $('#main-content').hide();
        
        // Clear any cached data
        $('#login-username').val('');
        $('#login-password').val('');
        $('#login-error').val('');
        $('#register-error').val('');
        
        // Optional: Call server logout endpoint
        if (token) {
          try {
            await fetch('https://api.alambda.com/logout', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
          } catch (error) {
            console.log('Server logout failed, but local logout completed');
          }
        }
        
        // Force page reload to ensure clean state
        setTimeout(() => {
          window.location.reload();
        }, 100);
        
      } catch (error) {
        console.error('Logout error:', error);
        // Force logout even if there's an error
        localStorage.removeItem('token');
        $('#logout-btn').hide();
        $('#login-container').show();
        $('#main-content').hide();
        window.location.reload();
      }
    });

    $('#contactsTable').on('click', 'tbody tr', function () {
      currentIdx = $(this).data('idx');
      const c = contacts[currentIdx];
      $('#p-name').text(c[0]);
      $('#p-email').text(c[1]);
      $('#p-agency').text(c[2]);
      $('#p-focus').text(c[3]);
      $('#p-why').text(c[4]);
      $('#p-bio').text('Loading...');
      $('#p-analytics-list').empty();
      $('#profile-panel').show();

      fetchPredict(`Write a 2-sentence bio for ${c[0]}.`).then(
        bio => {
          // Since fetchPredict now returns the extracted response directly
          const bioText = bio || 'No bio available';
          $('#p-bio').text(bioText);
        }
      ).catch(error => {
        console.error('Error fetching bio:', error);
        $('#p-bio').text('Error loading bio');
      });
      fetchDrafts(currentIdx); // Load drafts

      // Save Draft
      $('#draft-save').off('click').on('click', () => {
        const subject = $('#draft-subject').val().trim();
        const body = $('#draft-body').val().trim();
        if (!subject || !body) return alert('Subject and body required.');
        const id = $('#draft-save').data('edit-id');
        if (id) updateDraft(currentIdx, id, subject, body);
        else createDraft(currentIdx, subject, body);
      });
    });

    $('#profile-close').click(() => $('#profile-panel').hide());

    $('#toggle-panel').click(() => {
      $('#content-wrapper').toggleClass('closed');
      $('#toggle-icon').toggleClass('fa-chevron-left fa-chevron-right');
    });

    $('#btn-enrich').click(() => openPanel(`action-enrich.html?idx=${currentIdx}`));
    $('#btn-meeting').click(() => openPanel(`action-meeting.html?contact=${encodeURIComponent($('#p-email').text())}`));
    $('#btn-analytics').click(() => openPanel(`action-analytics.html?contact=${encodeURIComponent($('#p-email').text())}`));

    $('#fileUpload').change(e => {
      const f = e.target.files[0];
      if (!f) return;
      Papa.parse(f, {
        complete(res) {
          const v = res.data.filter(r => r.length >= 5 && r[0]);
          if (v.length) { contacts = v; loadContacts(v); }
          else alert('Invalid CSV.');
        }
      });
    });

    $('#crmSendBtn').click(async () => {
      const msg = $('#crmUserInput').val().trim(), cb = $('#crmMessages');
      if (!msg) return;
      cb.append(`<div class="bubble user">${msg}</div>`);
      $('#crmUserInput').val('');
      $('#crmSendBtn').prop('disabled', true);
      $('#crmSendText').hide(); $('#crmSpinner').show();
      
      try {
        const header = contacts.map(c => `- ${c[0]}: ${c[1]}`).join('\n');
        const resp = await fetchPredict(`Contacts:\n${header}\nQ: ${msg}`);
        cb.append(`<div class="bubble bot">${resp}</div>`);
      } catch (error) {
        console.error('CRM chat error:', error);
        cb.append(`<div class="bubble bot">Sorry, there was an error: ${error.message}</div>`);
      } finally {
        $('#crmSendBtn').prop('disabled', false);
        $('#crmSpinner').hide(); $('#crmSendText').show();
        cb.scrollTop(cb[0].scrollHeight);
      }
    });

    // Close function for agent modal
    function closeAgentModal() {
      $('#agentModal').modal('hide');
      $('body').removeClass('modal-open');
      $('.modal-backdrop').remove();
    }

    // Agent system functions
    async function initializeAgents() {
      try {
        const response = await fetch('https://api.alambda.com/api/agents/initialize', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const result = await response.json();
        console.log('Agents initialized:', result);
        return result;
      } catch (error) {
        console.error('Error initializing agents:', error);
        return null;
      }
    }

    async function listAvailableAgents() {
      try {
        const response = await fetch('https://api.alambda.com/api/agents/', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error listing agents:', error);
        return null;
      }
    }

    async function processRfpWithAgent(fileData, filename, contactInfo) {
      try {
        const formData = new FormData();
        formData.append('file', fileData);
        formData.append('company_name', contactInfo.company || 'Alambda Systems');
        formData.append('company_focus', contactInfo.focus || 'AI and software development');
        formData.append('why_hot', contactInfo.why_hot || 'Experienced team');
        formData.append('response_style', 'detailed');

        const response = await fetch('https://api.alambda.com/api/agents/workflows/rfp', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          body: formData
        });
        
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error processing RFP with agent:', error);
        return { success: false, error: error.message };
      }
    }

    async function generateEmailWithAgent(recipient, subject, context, tone = 'professional') {
      try {
        const response = await fetch('https://api.alambda.com/api/agents/workflows/email', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipient: recipient,
            subject: subject,
            context: context,
            tone: tone
          })
        });
        
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error generating email with agent:', error);
        return { success: false, error: error.message };
      }
    }

    // Ensure the Anthesis Agent modal opens on button click
    $('#btn-agent').click(async () => {
      console.log('Agent button clicked'); // Debug log
      
      // Check authentication first
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please log in first to access the Anthesis Agent.');
        return;
      }
      
      // Validate token
      const isValid = await validateToken();
      if (!isValid) {
        alert('Your session has expired. Please log in again.');
        performLogout();
        return;
      }
      
      if (typeof currentIdx !== 'number' || !contacts[currentIdx]) {
        alert('Please select a contact first.');
        return;
      }
      console.log('Opening agent modal...'); // Debug log
      
      // Clear workflow logs when opening modal
      clearWorkflowLogs();

      try {
        const modalEl = document.getElementById('agentModal');
        document.body.appendChild(modalEl); // Move modal to end of <body>
        modalEl.style.zIndex = '1099'; // Ensure modal is on top

        // Bootstrap 5 approach
        const modalInstance = new bootstrap.Modal(modalEl, { backdrop: false });
        modalInstance.show();
      } catch (e) {
        console.error('Bootstrap modal failed, fallback showing manually:', e);
        // Fallback modal display activated
        const el = document.getElementById('agentModal');
        el.style.display = 'block';
        el.classList.add('show');
        el.removeAttribute('aria-hidden');
        el.setAttribute('aria-modal', 'true');
        $('body').addClass('modal-open').css('overflow', 'hidden');
      }

      // Load drafts after modal is shown
      $('#agentModal').on('shown.bs.modal', function () {
        console.log('Modal shown, loading drafts...'); // Debug log
        clearWorkflowLogs(); // Clear any previous workflow logs
        loadEmailDrafts();
        loadRfpResponses();
      });
    });

    // Email draft generation in Anthesis Agent modal using agent system
    $('#generate-email-draft').click(async () => {
      if (typeof currentIdx !== 'number' || !contacts[currentIdx]) {
        alert('Please select a contact first.');
        return;
      }

      const c = contacts[currentIdx];
      const customMessage = $('#email-draft-body').val().trim();
      const subject = $('#email-draft-subject').val().trim() || 'Partnership Opportunity with ' + c[0];
      
      // Clear previous workflow logs
      clearWorkflowLogs();
      
      // Switch to workflow tab to show progress
      switchToTab('workflow-logs');
      
      // Build context for the agent
      const context = `Outreach to ${c[0]} from ${c[2]} about partnership opportunities in ${c[3]}. 
      We're SAM-registered (UEI: YEHBP8VM3NJ3, CAGE Code: 8G5R3) and can help with ${c[4].toLowerCase()}.
      Request a meeting or call to discuss collaboration.`;
      
      const finalContext = customMessage ? `${context}\n\nAdditional context: ${customMessage}` : context;
      
      // Prepare recipient info
      const recipient = {
        name: c[0],
        company: c[2],
        focus: c[3],
        why_hot: c[4]
      };

      const subjectInput = $('#email-draft-subject');
      const bodyInput = $('#email-draft-body');
      
      subjectInput.val(subject);
      bodyInput.val('Generating email with AI agent...');

      try {
        // Use the agent system to generate email
        const result = await generateEmailWithAgent(recipient, subject, finalContext, 'professional');
        
        if (result.success && result.data) {
          const generatedContent = result.data.content;
          bodyInput.val(generatedContent);
          
          // Debug logging
          console.log('Email Result:', result);
          console.log('Workflow Log:', result.data.workflow_log);
          console.log('Generated Content:', generatedContent);
          
          // Display workflow log if available
          if (result.data.workflow_log) {
            displayWorkflowLog(result.data.workflow_log);
          }

          // Auto-save to backend with workflow log
          const draftData = {
            subject: subject,
            body: generatedContent,
            type: 'email',
            workflow_log: result.data.workflow_log || null
          };
          
          console.log('Saving email draft data:', draftData);
          
          await fetch(`https://api.alambda.com/contacts/${currentIdx}/drafts`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(draftData)
          });

          loadEmailDrafts(); // refresh UI
        } else {
          throw new Error(result.error || 'Failed to generate email');
        }
      } catch (err) {
        console.error("Agent email generation failed", err);
        bodyInput.val('[Error generating email with agent]');
      }
    });

    // RFP upload and generation in Anthesis Agent modal using agent system
    $('#agent-rfp-upload-btn').click(async () => {
      if (typeof currentIdx !== 'number' || !contacts[currentIdx]) {
        alert('Please select a contact first.');
        return;
      }

      const fileInput = $('#agent-rfp-file-input')[0];
      const status = $('#agent-rfp-upload-status');
      
      if (!fileInput.files.length) {
        status.text('Please select a .pdf, .docx, or .txt file.').addClass('text-danger');
        return;
      }
      
      // Clear previous workflow logs
      clearWorkflowLogs();
      
      // Switch to workflow tab to show progress
      switchToTab('workflow-logs');
      
      status.text('Processing RFP with AI agent...').removeClass('text-danger').addClass('text-info');

      const file = fileInput.files[0];
      const c = contacts[currentIdx];
      
      // Prepare contact info for agent
      const contactInfo = {
        name: c[0],
        company: c[2],
        focus: c[3],
        why_hot: c[4]
      };

      try {
        // Use agent system to process RFP
        const result = await processRfpWithAgent(file, file.name, contactInfo);
        
        if (result.success && result.data) {
          const rfpResponseContent = result.data.rfp_response.response_content;
          
          // Debug logging
          console.log('RFP Result:', result);
          console.log('Workflow Log:', result.data.workflow_log);
          console.log('Response Content:', rfpResponseContent);
          
          // Display workflow log if available
          if (result.data.workflow_log) {
            displayWorkflowLog(result.data.workflow_log);
          }
          
          // Save the AI-generated draft with workflow log
          const draftData = {
            subject: 'Agent-Generated RFP Response',
            body: rfpResponseContent,
            type: 'rfp',
            workflow_log: result.data.workflow_log || null
          };
          
          console.log('Saving draft data:', draftData);
          
          await fetch(`https://api.alambda.com/contacts/${currentIdx}/drafts`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(draftData)
          });

          status.text('RFP response generated by agent and saved!').removeClass('text-danger').addClass('text-success');
          loadRfpResponses(); // Refresh RFP responses UI
          fileInput.value = ''; // Clear file input
        } else {
          throw new Error(result.error || 'Agent failed to process RFP');
        }
      } catch (err) {
        console.error('Agent RFP processing failed', err);
        status.text('Failed: ' + (err.message || 'Unknown error')).removeClass('text-info').addClass('text-danger');
      }
    });

    // Email button click handler for contacts table
    $(document).on('click', '.email-btn', function(e) {
      e.stopPropagation(); // Prevent row click event
      
      const row = $(this).closest('tr');
      const contactIdx = row.data('idx');
      const contact = contacts[contactIdx];
      
      if (!contact) {
        alert('Contact information not found.');
        return;
      }
      
      console.log('Email button clicked for contact:', contact[0]);
      
      // Populate modal with contact information
      $('#emailTo').val(contact[1]); // Email is at index 1
      $('#emailSubject').val(`Partnership Opportunity with ${contact[0]}`);
      $('#emailContent').val(`Dear ${contact[0]},

I hope this email finds you well. I'm reaching out from Alambda Systems regarding potential partnership opportunities in ${contact[3]}.

We are a SAM-registered vendor (UEI: YEHBP8VM3NJ3, CAGE Code: 8G5R3) specializing in AI and software development solutions.

I would love to schedule a brief call to discuss how we can support ${contact[2]}'s initiatives in ${contact[3]}.

Best regards,
Alambda Systems Team`);
      
      // Make sure it's a direct child of body
      const emailEl = document.getElementById('emailDeliveryModal');
      document.body.appendChild(emailEl);

      // Show via the Bootstrap API
      const emailModal = new bootstrap.Modal(emailEl, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
      emailModal.show();
      
      console.log('Email delivery modal opened for:', contact[0]);
    });

    // Email form submission handler
    $('#emailDeliveryForm').on('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = $('#emailDeliveryForm button[type="submit"]');
      const sendText = $('#emailSendText');
      const spinner = $('#emailSpinner');
      
      // Disable form and show loading
      submitBtn.prop('disabled', true);
      sendText.hide();
      spinner.show();
      
      const emailData = {
        context: {
          content: $('#emailContent').val(),
        },
        destination: {
          email: $('#emailTo').val(),
          subject: $('#emailSubject').val(),
        },
      };

      try {
        const response = await fetch('https://api.alambda.com/api/agents/workflows/email', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailData),
        });

        const result = await response.json();
        
        if (result.success) {
          alert('Email sent successfully!');
          $('#emailDeliveryModal').modal('hide');
          
          // Clear form
          $('#emailTo').val('');
          $('#emailSubject').val('');
          $('#emailContent').val('');
        } else {
          alert(`Error sending email: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Email sending error:', error);
        alert(`Error sending email: ${error.message}`);
      } finally {
        // Re-enable form and hide loading
        submitBtn.prop('disabled', false);
        spinner.hide();
        sendText.show();
      }
    });
  }

  function loadContacts(list) {
    const tb = $('#contactsTable tbody').empty();
    list.forEach((r, i) => {
      const tr = $('<tr>').data('idx', i);
      r.forEach(c => tr.append($('<td>').text(c)));
      tr.append(`<td>—</td><td>
        <button class="btn btn-sm btn-outline-info enrich-btn">Enrich</button>
        <button class="btn btn-sm btn-outline-success email-btn">Email</button>
      </td>`);
      tb.append(tr);
    });
  }

  // Draft Logic
  function fetchDrafts(contactId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    $('#drafts-list').empty();
    // Fetch email drafts
    fetch(`https://api.alambda.com/contacts/${contactId}/drafts?type=email`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    .then(r => r.json())
    .then(drafts => {
      if (drafts.length) {
        $('#drafts-list').append('<li><strong>Email Drafts</strong></li>');
        drafts.forEach(d => {
          const subject = d.subject || 'Untitled';
          const body = d.body || 'No content';
          $('#drafts-list').append(`
            <li class="draft-item">
              <div class="draft-header">
                <strong>${subject}</strong>
                <div class="draft-actions">
                  <button class="btn btn-sm btn-outline-primary" onclick="editDraft(${contactId}, ${d.id}, '${subject}', '${body}')">Edit</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteDraft(${contactId}, ${d.id})">Delete</button>
                </div>
              </div>
              <div class="draft-body">
                ${body}
              </div>
            </li>
          `);
        });
      }
    })
    .catch(error => {
      console.error('Error fetching drafts:', error);
      $('#drafts-list').append('<li class="error">Failed to load drafts</li>');
    });
  }

  function createDraft(contactId, subject, body) {
    fetch(`https://api.alambda.com/contacts/${contactId}/drafts`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ subject, body })
    }).then(() => {
      $('#draft-subject').val('');
      $('#draft-body').val('');
      $('#draft-save').removeData('edit-id');
      fetchDrafts(contactId);
    });
  }

  function updateDraft(contactId, draftId, subject, body) {
    fetch(`https://api.alambda.com/contacts/${contactId}/drafts/${draftId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ subject, body })
    }).then(() => {
      $('#draft-subject').val('');
      $('#draft-body').val('');
      $('#draft-save').removeData('edit-id');
      fetchDrafts(contactId);
    });
  }

  function deleteDraft(contactId, draftId) {
    if (!confirm('Delete this draft?')) return;
    fetch(`https://api.alambda.com/contacts/${contactId}/drafts/${draftId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    }).then(() => fetchDrafts(contactId));
  }

  function editDraft(contactId, draftId, subject, body) {
    $('#draft-subject').val(subject);
    $('#draft-body').val(body);
    $('#draft-save').data('edit-id', draftId);
  }

  function loadEmailDrafts() {
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('Authorization token is missing.');
      $('#email-drafts-list').append('<li class="list-group-item text-warning">Please log in to view email drafts.</li>');
      return;
    }

    // Validate currentIdx
    if (typeof currentIdx !== 'number' || currentIdx < 0) {
      console.error('No contact selected.');
      $('#email-drafts-list').append('<li class="list-group-item text-warning">Please select a contact first.</li>');
      return;
    }

    $('#email-drafts-list').empty();
    $('#email-drafts-list').append('<li class="list-group-item">Loading email drafts...</li>');
    
    fetch(`https://api.alambda.com/contacts/${currentIdx}/drafts?type=email`, {
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => {
        if (res.status === 401) {
          // Token is invalid or expired
          console.error('Authentication failed - token may be expired');
          localStorage.removeItem('token');
          $('#login-container').show();
          $('#main-content').hide();
          $('#logout-btn').hide();
          throw new Error('Authentication failed. Please log in again.');
        }
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(drafts => {
        $('#email-drafts-list').empty();
        
        // Filter to ensure only email drafts are shown
        const emailDrafts = drafts.filter(draft => 
          !draft.type || draft.type === 'email' || 
          (draft.subject && !draft.subject.includes('RFP Response'))
        );
        
        if (emailDrafts.length === 0) {
          $('#email-drafts-list').append('<li class="list-group-item">No email drafts found.</li>');
          return;
        }
        
        emailDrafts.forEach(draft => {
          // Escape quotes and newlines in subject and body for onclick handlers
          const escapedSubject = (draft.subject || '').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
          const escapedBody = (draft.body || '').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
          
          // Check if draft has workflow log
          const hasWorkflowLog = draft.workflow_log && draft.workflow_log.agent_conversations;
          const workflowButton = hasWorkflowLog ? 
            `<button class="btn btn-sm btn-outline-warning" onclick="loadDraftWorkflowLog(${draft.id})">View Workflow</button>` : 
            '';
          
          $('#email-drafts-list').append(`
            <li class="list-group-item">
              <strong>${draft.subject || 'Untitled'}</strong>
              <p style="max-height: 60px; overflow: hidden; font-size: 0.9em; color: #666;">${(draft.body || '').substring(0, 150)}...</p>
              <div class="draft-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="editDraft(${currentIdx}, ${draft.id}, '${escapedSubject}', '${escapedBody}')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteDraft(${currentIdx}, ${draft.id})">Delete</button>
                ${workflowButton}
              </div>
            </li>
          `);
        });
      })
      .catch(err => {
        console.error('Error loading email drafts:', err);
        $('#email-drafts-list').empty();
        $('#email-drafts-list').append(`<li class="list-group-item text-danger">Error loading email drafts: ${err.message}</li>`);
      });
  }

function loadRfpResponses() {
  const token = localStorage.getItem('token');
  if (!token) {
    console.error('Authorization token is missing.');
    $('#rfp-responses-list').append('<li class="list-group-item text-warning">Please log in to view RFP responses.</li>');
    return;
  }

  // Validate currentIdx
  if (typeof currentIdx !== 'number' || currentIdx < 0) {
    console.error('No contact selected.');
    $('#rfp-responses-list').append('<li class="list-group-item text-warning">Please select a contact first.</li>');
    return;
  }

  $('#rfp-responses-list').empty();
  $('#rfp-responses-list').append('<li class="list-group-item">Loading RFP responses...</li>');
  
  fetch(`https://api.alambda.com/contacts/${currentIdx}/drafts?type=rfp`, {
    headers: { 
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  })
    .then(res => {
      if (res.status === 401) {
        // Token is invalid or expired
        console.error('Authentication failed - token may be expired');
        localStorage.removeItem('token');
        $('#login-container').show();
        $('#main-content').hide();
        $('#logout-btn').hide();
        throw new Error('Authentication failed. Please log in again.');
      }
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(responses => {
      $('#rfp-responses-list').empty();
      
      // Filter to ensure only RFP responses are shown
      const rfpResponses = responses.filter(response => 
        response.type === 'rfp' || 
        (response.subject && response.subject.includes('RFP Response'))
      );
      
      if (rfpResponses.length === 0) {
        $('#rfp-responses-list').append('<li class="list-group-item">No RFP responses found. Upload an RFP to generate responses.</li>');
        return;
      }
      
      rfpResponses.forEach(response => {
        // Check if response has workflow log
        const hasWorkflowLog = response.workflow_log && response.workflow_log.agent_conversations;
        const workflowButton = hasWorkflowLog ? 
          `<button class="btn btn-sm btn-outline-warning" onclick="loadDraftWorkflowLog(${response.id})">View Workflow</button>` : 
          '';
        
        $('#rfp-responses-list').append(`
          <li class="list-group-item">
            <strong>${response.subject || 'Untitled RFP Response'}</strong>
            <p style="max-height: 60px; overflow: hidden; font-size: 0.9em; color: #666;">${(response.body || '').substring(0, 150)}...</p>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-success" onclick="downloadDraft(${response.id}, 'pdf')">Download PDF</button>
              <button class="btn btn-sm btn-outline-info" onclick="downloadDraft(${response.id}, 'pptx')">Download PPTX</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDraft(${currentIdx}, ${response.id})">Delete</button>
              ${workflowButton}
            </div>
          </li>
        `);
      });
    })
    .catch(err => {
      console.error('Error loading RFP responses:', err);
      $('#rfp-responses-list').empty();
      $('#rfp-responses-list').append(`<li class="list-group-item text-danger">Error loading RFP responses: ${err.message}</li>`);
    });
}

// Add missing downloadDraft function
function downloadDraft(draftId, format) {
  const token = localStorage.getItem('token');
  if (!token) {
    console.error('Authorization token is missing.');
    return;
  }

  // Download draft in specified format
  window.open(`https://api.alambda.com/contacts/${currentIdx}/drafts/${draftId}/download?format=${format}`, '_blank');
}

// Function to display workflow logs
function displayWorkflowLog(workflowLog) {
  const container = $('#workflow-conversations');
  
  if (!workflowLog || !workflowLog.agent_conversations) {
    container.html('<p class="text-muted">No workflow conversations available.</p>');
    return;
  }
  
  container.empty();
  
  // Calculate workflow statistics
  const totalMessages = workflowLog.agent_conversations.length;
  const uniqueAgents = [...new Set(workflowLog.agent_conversations.map(c => c.agent_name))];
  const startTime = new Date(workflowLog.started_at);
  const endTime = workflowLog.completed_at ? new Date(workflowLog.completed_at) : new Date();
  const duration = Math.round((endTime - startTime) / 1000); // in seconds
  
  // Add workflow header with statistics
  const header = $(`
    <div class="workflow-header mb-3 p-3" style="background: #34495e; border-radius: 8px; border-left: 4px solid #3498db;">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h6 class="text-light mb-2">
            <i class="fas fa-cogs"></i> Workflow: ${workflowLog.workflow_type.replace('_', ' ').toUpperCase()}
          </h6>
          <small class="text-muted">ID: ${workflowLog.workflow_id}</small>
        </div>
        <div class="text-right">
          <small class="text-muted d-block">Started: ${startTime.toLocaleString()}</small>
          ${workflowLog.completed_at ? `<small class="text-muted d-block">Completed: ${new Date(workflowLog.completed_at).toLocaleString()}</small>` : ''}
        </div>
      </div>
      <div class="workflow-stats mt-2 pt-2" style="border-top: 1px solid #4a5568;">
        <div class="row">
          <div class="col-4">
            <small class="text-muted">Messages:</small>
            <div class="text-light font-weight-bold">${totalMessages}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Agents:</small>
            <div class="text-light font-weight-bold">${uniqueAgents.length}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Duration:</small>
            <div class="text-light font-weight-bold">${duration}s</div>
          </div>
        </div>
      </div>
    </div>
  `);
  container.append(header);
  
  // Add each conversation message
  workflowLog.agent_conversations.forEach((conversation, index) => {
    const agentType = getAgentTypeFromName(conversation.agent_name);
    const avatarColor = getAgentColor(agentType);
    const timestamp = new Date(conversation.timestamp).toLocaleTimeString();
    
    const messageDiv = $(`
      <div class="workflow-message ${agentType}" style="animation-delay: ${index * 0.1}s;">
        <div class="agent-avatar" style="background-color: ${avatarColor};">
          ${getAgentIcon(agentType)}
        </div>
        <div class="workflow-message-content">
          <div class="agent-name">${conversation.agent_name}</div>
          <div class="workflow-message-text">${conversation.message}</div>
          <div class="workflow-timestamp">
            ${timestamp}
            <span class="workflow-step-indicator step-${conversation.step}">${conversation.step}</span>
          </div>
        </div>
      </div>
    `);
    
    container.append(messageDiv);
  });
  
  // Add workflow completion status
  if (workflowLog.completed_at) {
    const completionDiv = $(`
      <div class="workflow-completion mt-3 p-3" style="background: #27ae60; border-radius: 8px; color: white;">
        <i class="fas fa-check-circle"></i> Workflow completed successfully at ${new Date(workflowLog.completed_at).toLocaleString()}
      </div>
    `);
    container.append(completionDiv);
  }
  
  // Auto-scroll to bottom
  setTimeout(() => {
    container.scrollTop(container[0].scrollHeight);
  }, 100);
}

// Helper functions for agent display
function getAgentTypeFromName(agentName) {
  if (agentName.includes('Coordinator')) return 'coordinator';
  if (agentName.includes('Document')) return 'document-analysis';
  if (agentName.includes('Content')) return 'content-generation';
  return 'default';
}

function getAgentIcon(agentType) {
  const icons = {
    'coordinator': '🎯',
    'document-analysis': '📄',
    'content-generation': '✍️',
    'default': '🤖'
  };
  return icons[agentType] || icons.default;
}

function getAgentColor(agentType) {
  const colors = {
    'coordinator': '#0a84ff',
    'document-analysis': '#ff4d4d',
    'content-generation': '#00bfae',
    'default': '#6c757d'
  };
  return colors[agentType] || colors.default;
}

// Function to clear workflow logs
function clearWorkflowLogs() {
  $('#workflow-conversations').html('<p class="text-muted">No workflow logs available. Generate content to see agent interactions.</p>');
}

// Function to switch to a specific tab
function switchToTab(tabId) {
  // Remove active class from all tabs and content
  $('#agentTabs .nav-link').removeClass('active');
  $('.tab-pane').removeClass('show active');
  
  // Add active class to target tab
  $(`#${tabId}-tab`).addClass('active');
  
  // Show corresponding content
  $(`#${tabId}`).addClass('show active');
}

// Function to load workflow log from a saved draft
function loadDraftWorkflowLog(draftId) {
  const token = localStorage.getItem('token');
  if (!token) {
    console.error('Authorization token is missing.');
    return;
  }

  // Fetch the specific draft
  fetch(`https://api.alambda.com/contacts/${currentIdx}/drafts`, {
    headers: { 'Authorization': `Bearer ${token}` }
  })
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(drafts => {
      const draft = drafts.find(d => d.id === draftId);
      if (!draft) {
        console.error('Draft not found');
        return;
      }

      if (draft.workflow_log && draft.workflow_log.agent_conversations) {
        // Switch to workflow tab
        switchToTab('workflow-logs');
        
        // Display the workflow log
        displayWorkflowLog(draft.workflow_log);
        
        // Add draft context info
        const draftInfo = $(`
          <div class="workflow-draft-info mb-3 p-3" style="background: #2c3e50; border-radius: 8px; border-left: 4px solid #3498db;">
            <h6 class="text-light mb-2">
              <i class="fas fa-file-alt"></i> Draft Context
            </h6>
            <p class="mb-1"><strong>Subject:</strong> ${draft.subject}</p>
            <p class="mb-1"><strong>Type:</strong> ${draft.type.toUpperCase()}</p>
            <p class="mb-0"><strong>Created:</strong> ${new Date(draft.created_at).toLocaleString()}</p>
          </div>
        `);
        
        $('#workflow-conversations').prepend(draftInfo);
        
        // Scroll to top of workflow container
        $('#workflow-log-container').scrollTop(0);
      } else {
        alert('No workflow log available for this draft.');
      }
    })
    .catch(err => {
      console.error('Error loading draft workflow log:', err);
      alert('Error loading workflow log.');
    });
}

// Debug function to test email modal
    function testEmailModal() {
      console.log('Testing email modal...');
      const modal = $('#emailDeliveryModal');
      if (modal.length === 0) {
        console.error('Email modal not found in DOM');
        return;
      }
      
      // Populate with test data
      $('#emailTo').val('test@example.com');
      $('#emailSubject').val('Test Email');
      $('#emailContent').val('This is a test email.');
      
      // Show modal
      modal.modal('show');
      console.log('Email modal should now be visible');
    }
    
    // Ensure email modal works independently
    $(document).ready(function() {
      // Verify email modal exists
      if ($('#emailDeliveryModal').length === 0) {
        console.error('Email modal not found in DOM!');
      } else {
        console.log('Email modal found and ready');
      }
      
      // Add test button for debugging (temporary)
      if (window.location.hash === '#debug') {
        $('<button>')
          .text('Test Email Modal')
          .addClass('btn btn-warning')
          .css({
            position: 'fixed',
            top: '10px',
            right: '10px',
            zIndex: 9999
          })
          .click(testEmailModal)
          .appendTo('body');
      }
    });
</script>

</body>
</html>
